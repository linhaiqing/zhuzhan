<?phpnamespace model;use Move\db;class daili extends common{	public function up($userid, $coinname, $num, $paypassword, $username)	{		if (!$userid || !check($userid, "d")) {			return ["用户id格式错误"];		}		if (!$coinname || !check($coinname, "w")) {			return ["币种类型错误"];		}		if (!$num || !check($num, "xnb")) {			return ["充值数量格式错误"];		}		if (!$paypassword || !check($paypassword, "password")) {			return ["交易密码格式错误"];		}		if (!$username || !check($username, "username")) {			return ["充值用户名格式错误"];		}		$rs = [];		db::exec("set autocommit=0");		db::exec("lock tables #pre#user write, #pre#user_coin write, #pre#coin write,#pre#finan_pay write,#pre#coin_in write,#pre#daili_log write,#pre#daili write,#pre#daili_invit write");		$dl_user = db::table("user")->where(["id" => $userid])->find();		if (!$dl_user) {			db::exec("rollback");			db::exec("unlock tables");			return ["代理用户不存在"];		}		if ($dl_user["paypassword"] != hashs($paypassword)) {			db::exec("rollback");			db::exec("unlock tables");			return ["交易密码错误"];		}		$daili = db::table('daili')->where(['userid' => $userid])->find();		if (!$daili) {			db::exec("rollback");			db::exec("unlock tables");			return ["您不是代理"];		}		$cz_user = db::table('user')->where(['username' => $username])->find();		if (!$cz_user) {			db::exec("rollback");			db::exec("unlock tables");			return ["充值用户不存在"];		}		$mymc_coin = new \mymc\coin();		$coin = $mymc_coin->find($coinname);		if (!$coin) {			db::exec("rollback");			db::exec("unlock tables");			return ["充值币种不存在"];		}		if (!isset($daili[$coinname]) || !$daili[$coinname] || $daili[$coinname] < $num) {			db::exec("rollback");			db::exec("unlock tables");			return ["代理当前币种可用额度不足"];		}		if ($daili["invit_daili"] > 0 && isset($daili["invit_daili_kai"]) && $daili["invit_daili_kai"]) {			$invit_daili = num((floor($num) / 100 * $daili["invit_daili"]), 8);		} else {			$invit_daili = 0;		}		if ($daili["invit_self"] > 0 && isset($daili["invit_self_kai"]) && $daili["invit_self_kai"]) {			$invit_self = num((floor($num) / 100 * $daili["invit_self"]), 8);		} else {			$invit_self = 0;		}		if (isset($daili["invit_kai"]) && $daili["invit_kai"] && isset($daili["invit_coin"]) && $daili["invit_coin"]) {			if ($daili["invit_1"] > 0) {				$invit_1 = num((floor($num) / 100 * $daili["invit_1"]), 8);			}			if ($daili["invit_2"] > 0) {				$invit_2 = num((floor($num) / 100 * $daili["invit_2"]), 8);			}			if ($daili["invit_3"] > 0) {				$invit_3 = num((floor($num) / 100 * $daili["invit_3"]), 8);			}		} else {			$invit_1 = 0;			$invit_2 = 0;			$invit_3 = 0;		}		$rs[] = db::table('daili')->where(['userid' => $dl_user['id']])->setDec($coinname, $num);		$rs[] = db::table('user_coin')->where(['userid' => $cz_user['id']])->setInc($coinname, $num);		if ($coin['wallet'] == "rmb") {			$rs[] = db::table('finan_pay')->add(['userid' => $cz_user['id'], 'num' => $num, 'mum' => $num, 'coinname' => $coinname, 'type' => "", 'tradeno' => $dl_user['username'] . "代理充值", 'addtime' => time(), 'endtime' => time(), 'status' => 2]);		} else {			$rs[] = db::table('coin_in')->add(['userid' => $cz_user['id'], 'num' => $num, 'mum' => $num, 'coinname' => $coinname, 'type' => $dl_user['username'] . "代理充值", 'addtime' => time(), 'endtime' => time(), 'status' => 1]);		}		$rs[] = db::table('daili_log')->add(['userid' => $cz_user['id'], 'dailiid' => $dl_user['id'], 'coinname' => $coinname, 'num' => $num, 'addtime' => time(), 'endtime' => time(), 'status' => 1]);		if ($invit_daili && $daili["invit_daili_kai"] && $daili["invit_coin"] && $dl_user['id']) {			$rs[] = db::table("daili_invit")->add(["userid" => $dl_user['id'], "invit" => $cz_user['id'], "type" => "代理充值赠送", "name" => "代理赠送", "num" => $num, "fee" => $invit_daili, "feecoin" => $daili['invit_coin'], "addtime" => time(), "status" => 1]);			$rs[] = db::table("user_coin")->where(["userid" => $dl_user['id']])->set([$daili['invit_coin'] . "#+" => $invit_daili]);		}		if ($invit_self && $daili["invit_self_kai"] && $daili["invit_coin"] && $cz_user['id']) {			$rs[] = db::table("daili_invit")->add(["userid" => $cz_user['id'], "invit" => $cz_user['id'], "type" => "代理充值赠送", "name" => "自己送自己", "num" => $num, "fee" => $invit_self, "feecoin" => $daili['invit_coin'], "addtime" => time(), "status" => 1]);			$rs[] = db::table("user_coin")->where(["userid" => $cz_user['id']])->set([$daili['invit_coin'] . "#+" => $invit_self]);		}		if ($invit_1 && $daili["invit_kai"] && $daili["invit_coin"] && $cz_user["invit_1"]) {			$rs[] = db::table("daili_invit")->add(["userid" => $cz_user["invit_1"], "invit" => $cz_user['id'], "type" => "代理充值赠送", "name" => "一代赠送", "num" => $num, "fee" => $invit_1, "feecoin" => $daili['invit_coin'], "addtime" => time(), "status" => 1]);			$rs[] = db::table("user_coin")->where(["userid" => $cz_user["invit_1"]])->set([$daili['invit_coin'] . "#+" => $invit_1]);		}		if ($invit_2 && $daili["invit_kai"] && $daili["invit_coin"] && $cz_user["invit_2"]) {			$rs[] = db::table("daili_invit")->add(["userid" => $cz_user["invit_2"], "invit" => $cz_user['id'], "type" => "代理充值赠送", "name" => "二代赠送", "num" => $num, "fee" => $invit_2, "feecoin" => $daili['invit_coin'], "addtime" => time(), "status" => 1]);			$rs[] = db::table("user_coin")->where(["userid" => $cz_user["invit_2"]])->set([$daili['invit_coin'] . "#+" => $invit_2]);		}		if ($invit_3 && $daili["invit_kai"] && $daili["invit_coin"] && $cz_user["invit_3"]) {			$rs[] = db::table("daili_invit")->add(["userid" => $cz_user["invit_3"], "invit" => $cz_user['id'], "type" => "代理充值赠送", "name" => "三代赠送", "num" => $num, "fee" => $invit_3, "feecoin" => $daili['invit_coin'], "addtime" => time(), "status" => 1]);			$rs[] = db::table("user_coin")->where(["userid" => $cz_user["invit_3"]])->set([$daili['invit_coin'] . "#+" => $invit_3]);		}		if (check_arr($rs)) {			db::exec("commit");			db::exec("unlock tables");			return ['充值成功', 1];		} else {			db::exec("rollback");			db::exec("unlock tables");			return ["充值失败" . implode("|", $rs)];		}	}}