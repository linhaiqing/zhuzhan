<?phpnamespace model;use Move\db;class wallet extends common{	public function coin_in($coin)	{		$coin = db::table("coin")->where(["status" => 1, 'name' => $coin, "zr_jz" => 1])->find();		if (!$coin) {			return ["不存在钱包币"];		}		if ($coin['zr_jz'] != 1) {			return ["未开启转入"];		}		$host = $coin['dj_zj'];		$port = $coin["dj_dk"];		$password = $coin['dj_jm'];		$pararm = 'coin=' . $coin['wallet'] . '&name=' . $coin['name'] . '&action=billin';		$client = \ext\coin\mscoin::mycurl($host, $port, $password, $pararm);		if (!$client) {			return [$coin["name"] . "没有新的入账信息"];		}		if (empty($client['msg']['data'])) {			return [$coin["name"] . "没有新的入账信息"];		}		if (!isset($client['status']) || !$client['status'] || empty($client['msg'])) {			return [$coin["name"] . "获取入账信息异常"];		}		db::exec("set autocommit = 0");		db::exec("lock tables #pre#coin_in write,#pre#user_coin write,#pre#user_qianbao write,#pre#user read");		$success_id = [];		foreach ($client['msg']['data'] as $k => $v) {			$rs = [];			$txid = $v["txid"];			$zhuanchu = $v['account'];			$mum = $v['value'];			$num = $v['value'];			$fee = '';			$coin_in_check = db::table('coin_in')->where(['txid' => $txid])->find();			if ($coin_in_check) {				$success_id[] = 'Repeat Orders';				$pararm = 'coin=' . $coin['wallet'] . '&name=' . $coin['name'] . '&action=billinConfirm&txid=' . $txid . '&status=1';				\ext\coin\mscoin::mycurl($host, $port, $password, $pararm);				continue;			}			$check_qianbao = db::table('user_qianbao')->where(['coinname' => $coin['name'], 'type' => 1])->find();			if (empty($check_qianbao)) {				$pararm = 'coin=' . $coin['wallet'] . '&name=' . $coin['name'] . '&action=billinConfirm&txid=' . $txid . '&status=2';				\ext\coin\mscoin::mycurl($host, $port, $password, $pararm);				$success_id[] = 'empty address';				continue;			}			if ($check_qianbao['status'] == 0 && $num != $check_qianbao['round']) {				$rs[] = db::table('coin_in')->add(["userid" => $check_qianbao["userid"], "coinname" => $coin["name"], "zhuanchu" => $zhuanchu, "username" => '', "txid" => $txid, "queren" => $v['confirms'], "num" => $num, "mum" => $mum, "fee" => $fee, "addtime" => time(), "type" => "站外", 'status' => 0]);			} else if ($check_qianbao['status'] == 0 && $num == $check_qianbao['round']) {				$rs[] = db::table('coin_in')->add(["userid" => $check_qianbao["userid"], "coinname" => $coin["name"], "zhuanchu" => $zhuanchu, "username" => '', "txid" => $txid, "queren" => $v['confirms'], "num" => $num, "mum" => $mum, "fee" => $fee, "addtime" => time(), "type" => "站外", 'status' => 1]);				$rs[] = db::table('user_coin')->where(['userid' => $check_qianbao['userid']])->set([$coin["name"] . "#+" => $num]);				$rs[] = db::table('user_qianbao')->where(['coinname' => $coin['name'], 'id' => $check_qianbao['id']])->save(['status' => 1]);			} else if ($check_qianbao['status'] == 1) {				$rs[] = db::table('coin_in')->add(["userid" => $check_qianbao["userid"], "coinname" => $coin["name"], "zhuanchu" => $zhuanchu, "username" => '', "txid" => $txid, "queren" => $v['confirms'], "num" => $num, "mum" => $mum, "fee" => $fee, "addtime" => time(), "type" => "站外", 'status' => 1]);				$rs[] = db::table('user_coin')->where(['userid' => $check_qianbao['userid']])->set([$coin["name"] . "#+" => $num]);			} else {				db::exec("unlock tables");				continue;			}			if (check_arr($rs)) {				db::exec("commit");				$pararm = 'coin=' . $coin['wallet'] . '&name=' . $coin['name'] . '&action=billinConfirm&txid=' . $v['txid'] . '&status=1';				\ext\coin\mscoin::mycurl($host, $port, $password, $pararm);				$success_id[] = $rs[0];			} else {				db::exec("rollback");			}		}		db::exec("unlock tables");		return ['处理数据' . json_encode($success_id)];	}}