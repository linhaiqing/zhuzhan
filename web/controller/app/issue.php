<?phpnamespace app;use Move\db;class issue extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$this->set_title('认购中心');		$where["status"] = 1;		$res = parent::pullpage("issue", $where, "id desc");		$mymc_coin = new \mymc\coin();		foreach ($res["list"] as $k => $v) {			$res["list"][$k]['strtime'] = addtime($v['strtime'], "y-m-d");			$res["list"][$k]['sndtime'] = addtime($v['sndtime'], "y-m-d");			$coin = $mymc_coin->find($v["coinname"]);			$res["list"][$k]['price'] = num($v['price'], $coin["round"]);			$res["list"][$k]['coin']["img"] = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $coin['img'];			$res["list"][$k]['coin']["img"] = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $coin['img'];		}		ajax($res, 1);	}	public function buy()	{		$this->set_title('认购中心');		$id = iv('get.id', 'd', '参数错误');		$res["data"]["item"] = db::table("issue")->where(["id" => $id])->find();		$mymc_coin = new \mymc\coin();		$coin = $mymc_coin->find($res["data"]["item"]["coinname"]);		if (time() - $res["data"]["item"]['sndtime'] > 0) {			$res["data"]["item"]['jieshu'] = 1;		} else {			$res["data"]["item"]['jieshu'] = 0;		}		$res["data"]["item"]['strtime'] = addtime($res["data"]["item"]['strtime']);		$res["data"]["item"]['sndtime'] = addtime($res["data"]["item"]['sndtime']);		$res["data"]["item"]['price'] = num($res["data"]["item"]['price'], $coin["round"]);		$res["data"]["item"]["img"] = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $coin['img'];		$where["issueid"] = $id;		$res["log"] = parent::pullpage("issue_log", $where, "id desc");		foreach ($res["log"]["list"] as $k => $v) {			$res["log"]["list"][$k]['addtime'] = addtime($v["addtime"]);			$username = db::table("user")->where(["id" => $v["userid"]])->find();			if ($username["username"]) {				$res["log"]["list"][$k]['username'] = substr_replace(str_replace("|", " ", $username["username"]), '**', 3, 2);			}		}		$this->userid = $this->userid(1);		if ($this->userid) {			$usercoin = db::table("user_coin")->where(["userid" => $this->userid])->find();			$res["data"]["usercoin"] = $usercoin[$res["data"]["item"]['buycoin']];		}		ajax($res, 1);	}	public function up()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv('post.id', 'd', '参数错误');		$num = iv('post.num', 'd', '认购数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$res = md('issue')->up($this->userid, $id, $num, $paypassword);		if (isset($res[1]) && $res[1]) {			ajax('操作成功', 1);		} else {			ajax($res[0]);		}	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("issue_log", $where, "id desc");		foreach ($res["list"] as $k => $v) {			$res["list"][$k]['addtime'] = addtime($v["addtime"]);			$res["list"][$k]['endtime'] = addtime($v["endtime"]);			$yici = $res["list"][$k]['num'] / $res["list"][$k]['ci'];			$res["list"][$k]['shen'] = $res["list"][$k]['num'] - $yici * $res["list"][$k]['jd'];			$mymc_coin = new \mymc\coin();			$coin = $mymc_coin->find($v["coinname"]);			$res["list"][$k]['coin']["img"] = 'http://' . $_SERVER["HTTP_HOST"] . "/upload/" . $coin['img'];;		}		ajax($res, 1);	}	public function jiedong()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv('post.id', 'd', '请选择解冻项');		$res = md('issue')->jiedong($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax('操作成功', 1);		} else {			ajax($res[0]);		}	}	public function invit()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where = ["userid" => $this->userid];		$res = parent::pullpage("issue_invit", $where, "id desc");		$inviteList = [];		foreach ($res['list'] as $k => $v) {			$inviteList[] = $v['invit'];		}		if (count($inviteList) > 0) {			$userInvite = db::table('user')->where(['id#in' => $inviteList])->select();		}		foreach ($res["list"] as $k => $v) {			$res["list"][$k]['addtime'] = addtime($v["addtime"]);			if ($v['invit'] != 0) {				if ($userInvite) {					foreach ($userInvite as $v2) {						if ($v2['id'] == $v['invit']) {							$res["list"][$k]['invitname'] = $v2['username'];						}					}				}			} else {				$res["list"][$k]['invitname'] = '系统';			}		}		ajax($res, 1);	}}