<?phpnamespace app;use Move\db;use Move\ext\page;class ico_y extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$this->set_title('项目列表');		$type = iv("type", "d", "条件错误", 1);		$where = [];		if ($type == 1) {			$where["status"] = 1;			$where["strtime#>"] = time();		} else {			if ($type == 2) {				$where["status"] = 1;				$where["strtime#<"] = time();			} else {				if ($type == 3) {					$where["status#in"] = [2, 3, 4];				} else {					$where["status#!="] = 0;				}			}		}		$pages = parent::pullpage("ico_y", $where, "endtime desc", 3);		$list = $pages['list'];		foreach ($list as $k => $v) {			$list[$k]['img'] = "/upload/" . $v['img'];			$list[$k]['strtime'] = addtime($v['strtime']);			$list[$k]['endtime'] = addtime($v['endtime']);			$list[$k]["day"] = round(($v["endtime"] - time()) / 86400);			if ($list[$k]["day"] < 0) {				$list[$k]["day"] = 0;			}			if ($v["strtime"] > time()) {				$list[$k]["kaishi"] = 1;			} else {				if ($v["strtime"] <= time() && $v["endtime"] > time()) {					$list[$k]["kaishi"] = 2;				} else {					if ($v["endtime"] < time()) {						$list[$k]["kaishi"] = 3;					}				}			}			$list[$k]["bili"] = $v["gete"] / $v["mum"] * 100;		}		$pages['list'] = $list;		ajax($pages, 1);	}	public function details()	{		$this->userid = $this->userid(1);		$this->set_title('项目介绍');		$id = iv("id", "d", "参数错误");		$ico = db::table("ico_y")->where(["id" => $id])->find();		if (!$ico) {			show_msg("该项目丢失了.......");		}		$ico["day"] = round(($ico["endtime"] - time()) / 86400);		if ($ico["day"] < 0) {			$ico["day"] = 0;		}		if (time() < $ico['strtime']) {			$ico['start'] = 1;		} elseif (time() > $ico['strtime'] && time() < $ico['endtime']) {			$ico['start'] = 2;		} elseif (time() > $ico['endtime']) {			$ico['start'] = 3;			db::table('ico_y')->where(["id" => $id, "status" => 1])->save(['status' => 2]);		}		if ($ico['gete'] > $ico['mum']) {			$ico['start'] = 3;			db::table('ico_y')->where(["id" => $id, "status" => 1])->save(['status' => 2]);		}		$ico['img'] = '/upload/' . $ico['img'];		$pattern = "/upload/";		preg_match($pattern, $ico['content'], $match);		if ($match) {			$ico['content'] = str_replace($_SERVER . "/upload/", "/upload/", $ico['content']);		}		$ico["strtime"] = addtime($ico["strtime"]);		$ico["endtime"] = addtime($ico["endtime"]);		$ico["bili"] = $ico["gete"] / $ico["mum"] * 100;		if ($ico["mum"] > 0 && ($ico["gete"] / $ico["mum"]) > 1) {			$ico["bili"] = 100;		}		$ico_bili = db::table("ico_y_bili")->where(["pid" => $id])->select();		foreach ($ico_bili as $k => $v) {			$ico_bili[$k]['strtime'] = addtime($v['strtime'], 'y-m-d');			$ico_bili[$k]['endtime'] = addtime($v['endtime'], 'y-m-d');			$ico_bili[$k]['bili'] = num($v['bili'], 2);		}		$coin_list = db::table('ico_y_bili')->where(['status' => 1, 'pid' => $id, 'strtime#<=' => time(), 'endtime#>' => time()])->select();		$coin_data = [];		if ($coin_list) {			if ($this->userid) {				$user_coin = db::table('user_coin')->where(['userid' => $this->userid])->find();			}			foreach ($coin_list as $k => $v) {				$coin_data[$k]['coin'] = $ico['coin_data'];				if ($this->userid) {					$coin_data[$k]['user_coin'] = $user_coin[$ico['coin_data']];				}			}		}		$ico['data'] = $coin_data;		$ico['huibao'] = $ico_bili;		ajax($ico, 1);	}	public function up()	{		$this->userid = $this->userid();		$this->check_up('ICO众筹立即认筹');		$id = iv("post.id", "d", "ID格式错误");		$num = iv("post.num", "xnb", "数量格式错误");		$coin = iv("post.coin", "w", "币种格式错误");		$paypassword = iv("post.paypassword", "password", "密码格式格式错误");		if (!$this->userid) {			ajax("请先登录");		}		$user1 = db::table("user")->where(["id" => $this->userid])->find();		if (empty($user1['paypassword'])) {			ajax('交易密码非法');		}		if (hashs($paypassword) != $user1['paypassword']) {			ajax('交易密码错误');		}		$res = md('ico_y')->up($this->userid, $id, $coin, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function log()	{		$this->userid = $this->userid();		$this->set_title('众筹记录');		if ($this->userid) {			$where = ['userid' => $this->userid];			$pages = parent::pullpage("ico_y_log", $where, "id desc", 5);		} else {			$pages = [];		}		foreach ($pages['list'] as $k => $v) {			$pages['list'][$k]['addtime'] = addtime($v['addtime']);			$pages['list'][$k]['bili'] = num($v['bili'], 0);		}		ajax($pages, 1);	}	public function back()	{		$id = iv('post.id', 'd', '');		$num = iv('post.num', 'xnb', '');		$coin_bili = db::table('ico_y_bili')->where(['status' => 1, 'pid' => $id, 'strtime#<=' => time(), 'endtime#>' => time()])->find();		$ico = db::table('ico_y')->where(['status' => 1, 'id' => $id, 'strtime#<=' => time(), 'endtime#>' => time()])->find();		$back = 0;		if ($coin_bili) {			$back = $coin_bili['bili'] * $num . " " . $ico['coin_back'];		}		ajax($back, 1);	}} 