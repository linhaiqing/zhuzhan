<?phpnamespace app;use Move\db;class weike extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$weike = db::table("weike")->select();		foreach ($weike as $k => $v) {			if (time() - $v["addtime"] <= 86400 & $v["status"] == 1 & time() < $v["endtime"]) {				$v["step"] = 1;			} else if (time() - $v["addtime"] > 86400 & time() <= $v["endtime"] & $v["status"] == 1) {				$v["step"] = 2;			} else if (time() > $v["endtime"] & $v["status"] == 1) {				$v["step"] = 3;			} else if ($v["status"] == 0) {				$v["step"] = 4;			}			$count = db::table("weike_tender")->where(["weikeid" => $v["id"]])->count();			db::table("weike")->where(["id" => $v["id"]])->save(["step" => $v["step"], "num" => $count]);		}		$typelist = db::table("weike_type")->where(["status" => 1])->select();		$res["a"]["typelist"] = $typelist;		$where = [];		$res["a"]["keywords"] = iv("get.keywords", "a", "参数错误", 1);		if ($res["a"]["keywords"]) {			if (!check($res["a"]["keywords"], 'a')) {				ajax('关键字格式错误');			}			$where["title#like"] = "%" . $res["a"]["keywords"] . "%";		} else {			$res["a"]["keywords"] = "";		}		$res["a"]["type"] = iv("type", "d", "参数错误", 1);		if (!$res["a"]["type"]) {			$where["status"] = 1;			$where["step#<="] = 2;		} else {			if (!check($res["a"]["type"], 'd')) {				ajax('类型1格式错误');			}			$where["status"] = 1;			$where["type"] = $res["a"]["type"];			$where["step#<="] = 2;		}		$res["a"]["sort"] = iv('get.sort');		if ($res["a"]["sort"]) {			if (!check($res["a"]["sort"], 'd')) {				ajax('格式错误');			}			if ($res["a"]["sort"] == 1) {				$order = "num";			}			if ($res["a"]["sort"] == 2) {				$order = "price";			}			if ($res["a"]["sort"] == 3) {				$order = "addtime";			}		} else {			$res["a"]["sort"] = 0;			$order = "id";		}		$res["data"] = parent::pullpage("weike", $where, $order);		foreach ($res["data"]["list"] as $k => $v) {			$res["data"]["list"][$k]['addtime'] = addtime($v["addtime"]);			$username = db::table("user")->where(["id" => $v["userid"]])->find();			$res["data"]["list"][$k]["username"] = substr_replace(str_replace("|", " ", $username["username"]), '**', 3, 2);			if (!$username["id"]) {				$res["data"]["list"][$k]["username"] = "系统管理员";			}		}		ajax($res, 1);	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("weike_tender", $where, "id  desc", 10);		foreach ($res["list"] as $k => $v) {			$res["list"][$k]['addtime'] = addtime($v["addtime"]);			$username = db::table("user")->where(["id" => $v["userid"]])->find();			$res["list"][$k]["userid"] = substr_replace(str_replace("|", " ", $username["username"]), '**', 3, 2);		}		ajax($res, 1);	}	public function details()	{		$id = iv("id", "d", "参数错误");		$res["data"] = db::table("weike")->where(["id" => $id])->find();		$i = $res["data"]["view"];		$i++;		$view = ["view" => "$i++"];		db::table("weike")->where(["id" => $id])->save($view);		$username = db::table("user")->where(["id" => $res["data"]["userid"]])->find();		$res["data"]["username"] = $username["username"];		$res["data"]["addtime"] = addtime($res["data"]["addtime"]);		$res["data"]["endtime"] = addtime($res["data"]["endtime"]);		if (!$username["id"]) {			$res["data"]["username"] = "系统管理员";		}		$type = db::table("weike_type")->where(["id" => $res["data"]["type"]])->find();		$res["data"]["type"] = $type["type"];		$where["weikeid"] = $id;		$res["log"] = parent::pullpage("weike_tender", $where, "id  desc", 10);		foreach ($res["log"]["list"] as $k => $v) {			$res["log"]["list"][$k]['addtime'] = addtime($v["addtime"]);			$username = db::table("user")->where(["id" => $v["userid"]])->find();			$res["log"]["list"][$k]["userid"] = substr_replace(str_replace("|", " ", $username["username"]), '**', 3, 2);		}		ajax($res, 1);	}	public function tender_up()	{		$weikeid = iv("post.weikeid", "d", "参数错误");		$content = iv("post.content", "a", "参数错误");		$paypassword = iv("post.paypassword", "password", "交易密码格式错误");		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$user = db::table("user")->where(["id" => $this->userid])->find();		if (hashs($paypassword) != $user["paypassword"]) {			ajax("交易密码错误");		}		$weike = db::table("weike")->where(["id" => $weikeid])->find();		if (!$weike) {			ajax("威客不存在");		}		if ($weike["step"] >= 3 || $weike["status"] == 0) {			ajax("该威客已不接受投标");		}		$rs = [];		$arr = ["weikeid" => $weikeid, "userid" => session("userid"), "content" => $content, "status" => 2, "addtime" => time()];		$rs[] = db::table("weike_tender")->add($arr);		if (check_arr($rs)) {			ajax("投标成功", 1);		} else {			ajax("投标失败");		}	}}