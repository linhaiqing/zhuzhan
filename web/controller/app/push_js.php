<?phpnamespace app;use Move\db;use Move\ext\page;class push_js extends home{	public function __construct()	{		parent::__construct();	}	public function market()	{		$market_lists = db::table('push_js_market')->where(['status' => 1])->select();		$mymc_coin = new \mymc\coin();		foreach ($market_lists as $k => $v) {			$coin = $mymc_coin->find($v["coin"]);			$market_lists[$k]["title"] = $coin["title"];		}		ajax($market_lists, 1);	}	public function index()	{		$this->userid = $this->userid(1);		$market = mrz(iv('get.market', 'w', '市场错误', true), null);		$where["status"] = 1;		if ($market && $market != "my") {			$where["coin"] = $market;		} else {			if ($market && $market = "my") {				$where["userid"] = $this->userid;			}		}		$res = parent::pullpage("push_js", $where, "id desc");		$list = $res['list'];		$mymc_coin = new \mymc\coin();		foreach ($list as $k => $v) {			$coin = $mymc_coin->find($v["coin"]);			$list[$k]["title"] = $coin["title"];			$list[$k]["img"] = '/upload/' . $coin["img"];			$list[$k]["num"] = num($v['num'], 2);			$list[$k]["addtime"] = addtime($v['addtime']);			$list[$k]['bili'] = num(100 * ($v['deal'] / $v['num']), 2);		}		$res['list'] = $list;		ajax($res, 1);	}	public function up()	{		$this->userid = $this->userid();		$market = iv('post.market', 'w', '市场格式错误');		$price = iv('post.price', 'xnb', '价格格式错误');		$num = iv('post.num', 'xnb', '数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		if (!$this->userid) {			ajax('请先登录');		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user ['paypassword']) {			ajax('交易密码错误');		}		$res = md('push_js')->up($this->userid, $market, $price, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function chexiao()	{		$this->userid = $this->userid();		$id = iv('post.id', 'd', '参数错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		if (!$this->userid) {			ajax('请先登录');		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user ['paypassword']) {			ajax('交易密码错误');		}		$res = md('push_js')->chexiao($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function ajax()	{		$id = iv("post.id", "d", "ID错误");		$push_js = db::table("push_js")->where(["id" => $id])->find();		if ($push_js) {			$sheng = $push_js["num"] - $push_js["deal"];			ajax("", 1, $sheng);		} else {			ajax("err", 1, "err");		}	}	public function buy()	{		$this->userid = $this->userid();		$id = iv('post.id', 'd', '订单号格式错误');		$num = iv('post.num', 'xnb', '数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		if (!$this->userid) {			ajax('请先登录');		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user ['paypassword']) {			ajax('交易密码错误');		}		$res = md('push_js')->buy($this->userid, $id, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function log()	{		$this->userid = $this->userid();		$this->set_title('PUSH记录');		$type = iv('get.type', 'd', '类型错误', 1);		if (!$type) {			$type = 1;		}		if ($this->userid) {			$where = [];			if ($type == 1) {				$where["peerid"] = $this->userid;			} else {				$where["userid"] = $this->userid;			}			$res = parent::pullpage("push_js_log", $where, "id desc");			$list = $res['list'];			$mymc_coin = new \mymc\coin();			foreach ($list as $k => $v) {				if ($type == 1) {					$list[$k]["username"] = substr_replace(str_replace("|", " ", db::table("user")->where(["id" => $v["userid"]])->find("username")), '**', 3, 2);;					$list[$k]['rev'] = 1;				} else {					$list[$k]["username"] = substr_replace(str_replace("|", " ", db::table("user")->where(["id" => $v["peerid"]])->find("username")), '**', 3, 2);;				}				$coin = $mymc_coin->find($v["coin"]);				$list[$k]["img"] = '/upload/' . $coin['img'];				$list[$k]["title"] = $coin['title'];				$list[$k]["addtime"] = addtime($v['addtime']);				$list[$k]["endtime"] = addtime($v['endtime']);			}		} else {			$list = [];		}		$res['list'] = $list;		ajax($res, 1);	}	public function push()	{		$this->userid = $this->userid();		$coin = iv("post.coin", "w", "币种异常");		$uid = iv("post.uid", "d", "用户ID异常");		$uname = iv("post.uname", "username", "用户名异常");		$num = iv("post.num", "xnb", "数量异常");		$price = iv("post.price", "xnb", "单价异常");		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		if (!$this->userid) {			ajax('请先登录');		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user ['paypassword']) {			ajax('交易密码错误');		}		$res = md('push_js')->push($this->userid, $uid, $uname, $coin, $num, $price);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function yes()	{		$this->userid = $this->userid();		$id = iv("post.id", "d", "记录id参数错误");		$type = iv("post.type", "d", "选择类型参数错误");		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		if (!$this->userid) {			ajax('请先登录');		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user ['paypassword']) {			ajax('交易密码错误');		}		$res = md('push_js')->yes($this->userid, $id, $type);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}}