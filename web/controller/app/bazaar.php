<?phpnamespace app;use Move\db;class bazaar extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$market = iv('get.market', 'w_', '市场错误', 1);		$type = iv('get.type', 'd', '类型错误', 1);		$market_lists = db::table('bazaar_market')->where(['status' => 1])->select();		$data_list = [];		if ($market_lists) {			foreach ($market_lists as $k => $v) {				$data_list [$v['name']] = $v;			}		}		$res["market_list"] = $data_list;		$where = [];		if ($market) {			$where['market'] = $market;		}		if ($type) {			$where['type'] = $type;		}		$where['status'] = 0;		if ($type == 1) {			$order = 'price asc ,id asc';		} else {			$order = 'price desc ,id asc';		}		$res["data"] = parent::pullpage("bazaar", $where, $order);		foreach ($res["data"]["list"] as $k => $v) {			$res["data"]["list"][$k]['addtime'] = addtime($v["addtime"]);			$title = db::table("bazaar_market")->where(["name" => $v["market"]])->find();			$res["data"]["list"][$k]['title'] = $title["title"];		}		$res["market"] = $market;		$res["type"] = $type;		ajax($res, 1);	}	public function up()	{		$type = iv('post.type', 'd', '类型格式错误');		$market = iv('post.market', 'w_', '市场格式错误');		$price = iv('post.price', 'xnb', '价格格式错误');		$num = iv('post.num', 'xnb', '数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请先登录');		}		if ($type != 1 && $type != 2) {			ajax('交易类型错误');		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user['paypassword']) {			ajax('交易密码错误');		}		$res = md('bazaar')->up($this->userid, $type, $market, $price, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function buy()	{		$type = iv('post.type', 'd', '类型格式错误');		$id = iv('post.id', 'd', '订单号格式错误');		$num = iv('post.num', 'xnb', '数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请先登录', -99);		}		if ($type != 1 && $type != 2) {			ajax('交易类型错误');		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user ['paypassword']) {			ajax('交易密码错误');		}		$res = md('bazaar')->buy($this->userid, $id, $type, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function chexiao()	{		$id = iv('post.id', 'd', '参数错误');		$paypassword = iv('post.paypassword', 'password', '交易密码错误');		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请先登录', -99);		}		$user = db::table('user')->where(['id' => $this->userid])->find();		if (!$user) {			ajax('用户异常');		}		if (hashs($paypassword) != $user ['paypassword']) {			ajax('交易密码错误');		}		$res = md('bazaar')->chexiao($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function my()	{		$market = iv('get.market', 'w_', '市场错误', 1);		$type = iv('get.type', 'd', '类型错误', 1);		$status = iv('get.status', 'd', '状态错误', 1);		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请先登录', -99);		}		$market_lists = db::table('bazaar_market')->where(['status' => 1])->select();		$data_list = [];		if ($market_lists) {			foreach ($market_lists as $k => $v) {				$data_list [$v['name']] = $v;			}		}		$res["market_list"] = $data_list;		$where['userid'] = $this->userid;		if ($market) {			$where['market'] = $market;		}		if ($type > 0) {			$where['type'] = $type;		}		if ($status > 0) {			$where['status'] = $status - 1;		}		$res["data"] = parent::pullpage("bazaar", $where, "`id` desc");		foreach ($res["data"]["list"] as $k => $v) {			$res["data"]["list"][$k]['addtime'] = addtime($v["addtime"]);			$title = db::table("bazaar_market")->where(["name" => $v["market"]])->find();			$res["data"]["list"][$k]['title'] = $title["title"];		}		$res["market"] = $market;		$res["type"] = $type;		$res["status"] = $status;		ajax($res, 1);	}	public function log()	{		$market = iv('get.market', 'w_', '市场错误', 1);		$type = iv('get.type', 'd', '类型错误', 1);		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请先登录', -99);		}		$market_lists = db::table('bazaar_market')->where(['status' => 1])->select();		$data_list = [];		if ($market_lists) {			foreach ($market_lists as $k => $v) {				$data_list [$v['name']] = $v;			}		}		$res["market_list"] = $data_list;		$where['userid'] = $this->userid;		if ($market) {			$where['market'] = $market;		}		if ($type > 0) {			$where['type'] = $type;		}		$res["data"] = parent::pullpage("bazaar_log", $where, "`id` desc");		foreach ($res["data"]["list"] as $k => $v) {			$res["data"]["list"][$k]['addtime'] = addtime($v["addtime"]);			$title = db::table("bazaar_market")->where(["name" => $v["market"]])->find();			$res["data"]["list"][$k]['title'] = $title["title"];		}		$res["market"] = $market;		$res["type"] = $type;		ajax($res, 1);	}	public function invit()	{		$where = ["userid" => session("userid")];		$res = parent::pullpage("bazaar_invit", $where, "`id` desc");		foreach ($res["list"] as $k => $v) {			$res["list"][$k]['addtime'] = addtime($v["addtime"]);			$username = db::table("user")->where(["id" => $v["invit"]])->find();			if ($username["username"]) {				$res["list"][$k]['invitname'] = $username["username"];			}		}		ajax($res, 1);	}}