<?phpnamespace app;use Move\db;class duihuan extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$banner = db::table("sys_ad")->where(["type" => "app"])->select();		foreach ($banner as $val) {			$res['banner'][] = $this->host . "/upload/" . $val["img"];		}		$where["status#!="] = 0;		$res = parent::pullpage("duihuan", $where, "id desc");		ajax($res, 1);	}	public function details()	{		$id = iv("id", "d", "参数错误");		$res["data"]["duihuan"] = db::table("duihuan")->where(["id" => $id, "status" => 1])->find();		if (!$res["data"]["duihuan"]) {			ajax("参数错误");		}		$this->userid = $this->userid(1);		if ($this->userid) {			$user_coin = db::table("user_coin")->where(["userid" => $this->userid])->find();			if ($res["data"]["duihuan"] ["coin3"] && $res["data"]["duihuan"] ["num3"]) {				$res["data"]["mycoin3"] = $user_coin[$res["data"]["duihuan"] ["coin3"]];			}			if ($res["data"]["duihuan"] ["coin4"] && $res["data"]["duihuan"] ["num4"]) {				$res["data"]["mycoin4"] = $user_coin[$res["data"]["duihuan"] ["coin4"]];			}			$log = db::table("duihuan_log")->where(["userid" => $this->userid, "dhid" => $res["data"]["duihuan"]["id"], "status#!=" => 0])->select();			$mum = 0;			foreach ($log as $k => $v) {				$mum += $v["num"];			}			$res["data"]["mum"] = $mum;		}		$res["data"]["strtime"] = addtime(strtotime(addtime(time(), 'y-m-d')) + ($res["data"]["duihuan"]['strtime'] * 3600));		$res["data"]["endtime"] = addtime(strtotime(addtime(time(), 'y-m-d')) + ($res["data"]["duihuan"]['endtime'] * 3600));		$where = ["dhid" => $res["data"]["duihuan"] ["id"], "status#!=" => 0];		$res["log"] = parent::pullpage("duihuan_log", $where, "id desc");		foreach ($res["log"]["list"] as $k => $v) {			$user = db::table("user")->where(["id" => $v["userid"]])->find();			$res["log"]["list"][$k]["userid"] = substr_replace(str_replace("|", " ", $user['username']), '**', 3, 2);			$res["log"]["list"][$k]["addtime"] = addtime($res["log"]["list"][$k]["addtime"]);		}		ajax($res, 1);	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("duihuan_log", $where, "id desc");		foreach ($res["list"] as $k => $v) {			$res["list"][$k]['addtime'] = addtime($v["addtime"]);		}		ajax($res, 1);	}	public function buy()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv('post.id', 'd', '兑换id错误');		$num = iv('post.num', 'd', '数量错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$res = md('duihuan')->up($this->userid, $id, $num, $paypassword);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}}