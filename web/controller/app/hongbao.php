<?phpnamespace app;use Move\db;class hongbao extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$hongbao = db::table("hongbao")->select();		foreach ($hongbao as $k => $v) {			if ($v["get"] == $v['num']) {				db::table("hongbao")->where(["id" => $v["id"]])->save(["status" => 0]);			}		}		$where["status"] = 1;		$res = parent::pullpage("hongbao", $where, "id desc");		foreach ($res["list"] as $k => $v) {			$arr = db::table("hongbao_type")->where(["id" => $v["money_type"]])->find();			$res["list"][$k]["money_type"] = $arr["money_type"];			$res["list"][$k]["addtime"] = addtime($res["list"][$k]["addtime"]);		}		foreach ($res["list"] as $k => $v) {			$arr = db::table("user")->where(["id" => $v["userid"]])->find();			$res["list"][$k]["userid"] = substr_replace(str_replace("|", " ", $arr["username"]), '**', 3, 2);		}		ajax($res, 1);	}	public function tuhao()	{		$arr = db::table("hongbao")->select();		$rank1 = [];		foreach ($arr as $key => $val) {			$rank1[$val['userid']] = isset($rank1[$val['userid']]) ? $rank1[$val['userid']] + 1 : 1;		}		arsort($rank1);		foreach ($rank1 as $k => $v) {			$res = db::table("user")->where(["id" => $k])->find();			$rank1[$k] = ["num" => $v, "username" => substr_replace(str_replace("|", " ", $res['username']), '**', 3, 2),];		}		$tuhao = array_slice($rank1, 0, 5);		ajax($tuhao, 1);	}	public function speed()	{		$brr = db::table("hongbao_log")->select();		$rank = [];		foreach ($brr as $key => $val) {			$rank[$val['userid']] = isset($rank[$val['userid']]) ? $rank[$val['userid']] + 1 : 1;		}		arsort($rank);		foreach ($rank as $k => $v) {			$res = db::table("user")->where(["id" => $k])->find();			$rank[$k] = ["num" => $v, "username" => substr_replace(str_replace("|", " ", $res['username']), '**', 3, 2),];		}		$speed = array_slice($rank, 0, 5);		ajax($speed, 1);	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$where = [];		$where["userid"] = $this->userid;		$res = parent::pullpage("hongbao_log", $where, "id desc");		foreach ($res["list"] as $k => $v) {			$username = db::table("user")->where(["id" => $v["userid"]])->find();			$res["list"][$k]["userid"] = substr_replace(str_replace("|", " ", $username ["username"]), '**', 3, 2);			$arr = db::table("hongbao_type")->where(["id" => $v["money_type"]])->find();			$res["list"][$k]["money_type"] = $arr["money_type"];			$res["list"][$k]["addtime"] = addtime($res["list"][$k]["addtime"]);		}		ajax($res, 1);	}	public function sendlog()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$where = [];		$where["userid"] = $this->userid;		$res = parent::pullpage("hongbao", $where, "id desc");		foreach ($res["list"] as $k => $v) {			$username = db::table("user")->where(["id" => $v["userid"]])->find();			$res["list"][$k]["userid"] = substr_replace(str_replace("|", " ", $username ["username"]), '**', 3, 2);			$arr = db::table("hongbao_type")->where(["id" => $v["money_type"]])->find();			$res["list"][$k]["money_type"] = $arr["money_type"];			$res["list"][$k]["addtime"] = addtime($res["list"][$k]["addtime"]);		}		ajax($res, 1);	}	public function hongbao()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$id = iv("id", "d", "参数错误");		$res = md('hongbao')->hongbao($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function send()	{		$res = db::table("hongbao_type")->where(["status" => 1])->select();		foreach ($res as $k => $v) {			$mymc_coin = new \mymc\coin();			$coin = $mymc_coin->find($v["money_type"]);			$res[$k]["title"] = $coin["title"];		}		ajax($res, 1);	}	public function send_up()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$money = iv("post.money", "double", "金钱 格式错误");		$money_type = iv("post.money_type", "d", "币种 格式错误");		$num = iv("post.num", "d", "红包数 格式错误");		$title = iv("post.title", "a", "红包标题 格式错误", 1);		$paypassword = iv("post.paypassword", "password", "交易密码 格式错误");		$res = md('hongbao')->send($this->userid, $money, $money_type, $num, $paypassword, $title);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}}