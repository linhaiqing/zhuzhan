<?phpnamespace app;use Move\db;use Move\ext\page;class hold extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$platform = iv('platform');		$where = ["status" => 1];		$res = parent::pullpage("hold", $where, '`sort` asc ,id desc', 10);		if ($res) {			$mymc_coin = new \mymc\coin();			foreach ($res['list'] as $key => $var) {				$coin = $mymc_coin->find($var["coinname"]);				$res["list"][$key]['strtime'] = addtime($var['strtime']);				$res["list"][$key]['sndtime'] = addtime($var['sndtime']);				if (isset($platform) && $platform == 'pc') {					$res["list"][$key]['coin']["img"] = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $coin['img'];				} else {					$res["list"][$key]['coin']["img"] = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $coin['img'];				}			}		}		ajax($res, 1);	}	public function buy()	{		$this->userid = $this->userid(1);		$id = iv('get.id', 'd', '参数错误');		$res["data"]["item"] = db::table("hold")->where(["id" => $id])->find();		$mymc_coin = new \mymc\coin();		$coin = $mymc_coin->find($res["data"]["item"]["coinname"]);		if (time() - $res["data"]["item"]['sndtime'] > 0) {			$res["data"]["item"]['jieshu'] = 1;		} else {			$res["data"]["item"]['jieshu'] = 0;		}		$res["data"]["item"]['strtime'] = addtime($res["data"]["item"]['strtime']);		$res["data"]["item"]['sndtime'] = addtime($res["data"]["item"]['sndtime']);		$res["data"]["item"]['price'] = num($res["data"]["item"]['price'], $coin["round"]);		$res["data"]["item"]["img"] = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $coin['img'];		$usercoin = db::table("user_coin")->where(["userid" => $this->userid])->find();		$res["data"]["usercoin"] = $usercoin[$res["data"]["item"]['coinname']];		$where["holdid"] = $id;		$res["log"] = parent::pullpage("hold_log", $where, "id desc", 10);		foreach ($res["log"]["list"] as $k => $v) {			$res["log"]["list"][$k]['addtime'] = addtime($v["addtime"]);			$username = db::table("user")->where(["id" => $v["userid"]])->find();			if ($username["username"]) {				$res["log"]["list"][$k]['username'] = substr_replace(str_replace("|", " ", $username["username"]), '**', 3, 2);			}		}		ajax($res, 1);	}	public function chaomu_up()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$type = iv('post.type', 'a', '', 1);		$id = iv('post.id', 'd', '参数错误');		$num = iv('post.num', 'd', '认购数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$userid = $this->userid;		$user = db::table("user")->where(["id" => $userid])->find();		if (!$user) {			ajax('用户不存在');		}		if ($user["paypassword"] != hashs($paypassword)) {			ajax("交易密码错误");		}		$res = md('hold')->chaomu_up($this->userid, $id, $num, $type);		if (isset($res[1]) && $res[1]) {			session('home_hold_buy', null);			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function up()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$type = iv('post.type', 'a', '', 1);		$id = iv('post.id', 'd', '参数错误');		$num = iv('post.num', 'd', '认购数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$userid = $this->userid;		$user = db::table("user")->where(["id" => $userid])->find();		if (!$user) {			ajax('用户不存在');		}		if ($user["paypassword"] != hashs($paypassword)) {			ajax("交易密码错误");		}		$res = md('hold')->up($this->userid, $id, $num, $type);		if (isset($res[1]) && $res[1]) {			session('home_hold_buy', null);			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("hold_log", $where, "id desc", 10);		if ($res) {			$mymc_coin = new \mymc\coin();			foreach ($res['list'] as $k => $v) {				$coin = $mymc_coin->find($v["coinname"]);				$res["list"][$k]['coin']["img"] = 'http://' . $_SERVER["HTTP_HOST"] . "/upload/" . $coin['img'];;				$res['list'][$k]["shen"] = num((($v["ci"] - $v["jd"]) * $v["num"] / $v["ci"]), 8);				$res["list"][$k]['addtime'] = addtime($v["addtime"]);				$res["list"][$k]['endtime'] = addtime($v["endtime"]);			}		}		ajax($res, 1);	}	public function jiedong()	{		$id = iv('post.id', 'd', '请选择解冻项');		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$user = db::table("user")->where(["id" => $this->userid])->find();		if (!$user) {			ajax("用户不存在");		}		$res = md('hold')->jiedong($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function invit()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where = ["userid" => $this->userid];		$res = parent::pullpage("hold_invit", $where, "id desc", 10);		foreach ($res['list'] as $k => $v) {			$res["list"][$k]['addtime'] = addtime($v["addtime"]);			if ($v['invit'] != 0) {				$res['list'][$k]['invitname'] = md('user')->find(['id' => $v['invit']], 'username');			} else {				$res['list'][$k]['invitname'] = '系统';			}		}		ajax($res, 1);	}}