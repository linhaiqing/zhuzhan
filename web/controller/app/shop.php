<?phpnamespace app;use Move\db;class shop extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$res = ["banner" => [], "shop" => [["name" => "推荐专区", "lists" => ""], ["name" => "热门商品", "lists" => ""]], "shop_type" => ""];		$banner = db::table("sys_ad")->where(["type" => "app"])->select();		foreach ($banner as $val) {			$res['banner'][] = "/upload/" . $val["img"];		}		$shop_tj = db::table('shop')->where(['tj' => 1])->select();		foreach ($shop_tj as $k => $v) {			if ($k >= 3) {				break;			}			$res['shop'][0]["lists"][] = ["id" => $v['id'], "title" => $v['title'], "price" => num($v['price'], 0), "img" => "/upload/" . $v['img']];		}		$shop_hot = db::table('shop')->where(['hot' => 1])->select();		foreach ($shop_hot as $k => $v) {			if ($k >= 3) {				break;			}			$res['shop'][1]['lists'][] = ["id" => $v['id'], "title" => $v['title'], "price" => num($v['price'], 0), "img" => "/upload/" . $v['img']];		}		ajax($res, 1);	}	public function type_list()	{		$type = db::table("shop_type")->where(["status" => 1])->order("sort asc , id desc")->select();		$level = null;		foreach ($type as $k => $v) {			if ($v['pid'] == 0) {				$level[] = $v;			}		}		$levelTemp = $level;		foreach ($type as $k => $v) {			foreach ($levelTemp as $k2 => $v2) {				if ($v['pid'] == $v2['id']) {					$level[$k2]["pid_list"][] = $v;				}			}		}		$levelTemp = $level;		foreach ($type as $k => $v) {			foreach ($levelTemp as $k2 => $v2) {				if (!array_key_exists('pid_list', $v2)) {					$level[$k2]['pid_list'] = [];				} else {					foreach ($v2['pid_list'] as $k3 => $v3) {						if ($v['pid'] == $v3['id']) {							$level[$k2]["pid_list"][$k3]["pid_list"][] = $v;						}					}				}			}		}		$levelTemp = $level;		foreach ($levelTemp as $k1 => $v1) {			if (!array_key_exists('pid_list', $v1)) {				$level[$k1]['pid_list'] = [];			} else {				foreach ($v1['pid_list'] as $k2 => $v2) {					if (!array_key_exists('pid_list', $v2)) {						$level[$k1]['pid_list'][$k2]['pid_list'] = [];					} else {						foreach ($v2['pid_list'] as $k3 => $v3) {							if (!array_key_exists('pid_list', $v3)) {								$level[$k1]['pid_list'][$k2]['pid_list'][$k3]['pid_list'] = [];							}						}					}				}			}		}		$typelist = ["shop_type1" => $level];		ajax($typelist, 1);	}	public function type_list_discard()	{		$top_list = db::table("shop_type")->where(["status" => 1, "pid" => 0])->order("sort asc , id desc")->select();		if ($top_list) {			foreach ($top_list as $k => $v) {				$top_list[$k]['pid_list'] = db::table("shop_type")->where(["status" => 1, "pid" => $v['id']])->order("sort asc , id desc")->select();				if ($top_list[$k]['pid_list']) {					foreach ($top_list[$k]['pid_list'] as $kk => $vv) {						$top_list[$k]['pid_list'][$kk]['pid_list'] = db::table("shop_type")->where(["status" => 1, "pid" => $vv['id']])->order("sort asc , id desc")->select();						if ($top_list[$k]['pid_list'][$kk]['pid_list']) {							foreach ($top_list[$k]['pid_list'][$kk]['pid_list'] as $kkk => $vvv) {								$top_list[$k]['pid_list'][$kk]['pid_list'][$kkk]['pid_list'] = db::table("shop_type")->where(["status" => 1, "pid" => $vvv['id']])->order("sort asc , id desc")->select();							}						}					}				}			}		}		$res["shop_type1"] = $top_list;		ajax($res, 1);	}	public function lists()	{		$where = [];		$keyword = iv('get.keyword', "a", "关键字参数错误", 1);		if ($keyword) {			$where["title#like"] = "%" . $keyword . "%";		} else {			$keyword = "";		}		$type2 = iv('get.type2', 'wd', '参数错误', 1);		if ($type2) {			$where["status"] = 1;			$where["type"] = $type2;		} else {			$type2 = 0;			$where["status"] = 1;		}		$sort = iv('get.sort');		if ($sort) {			if (!check($sort, 'd')) {				ajax('格式错误');			}			if ($sort == 1) {				$order = "num";			}			if ($sort == 2) {				$order = "price";			}			if ($sort == 3) {				$order = "addtime";			}		} else {			$sort = 0;			$order = "sort";		}		$res["type2"] = $type2;		$res["sort"] = $sort;		$res["data"] = db::table("shop")->where($where)->order("'$order' desc,id desc")->select();		foreach ($res["data"] as $k => $v) {			$res["data"][$k]['img'] = "/upload/" . $res["data"][$k]['img'];		}		ajax($res, 1);	}	public function view()	{		$id = iv('get.id', 'd', '参数错误');		$shop = db::table("shop")->where(["id" => $id])->find();		$shop['img'] = "/upload/" . $shop['img'];		if (isset($shop["coindata"])) {			$coinpay = explode(",", rtrim($shop["coindata"], ","));			$mymc_coin = new \mymc\coin();			foreach ($coinpay as $k => $v) {				$shop_coinpay = $mymc_coin->find(['id' => $v]);				$coinpay[$k] = $shop_coinpay["title"];			}		}		$shop['price'] = num($shop['price']);		$img = db::table("shop_img")->where(["shopid" => $id, "status" => 1])->select();		foreach ($img as $key => $val) {			$val['img'] = "/upload/" . $val['img'];			$img[$key] = $val;		}		$ret["shop"] = $shop;		$ret["coin"] = $coinpay;		$ret["img"] = $img;		ajax($ret, 1);	}	public function order()	{		$id = iv('post.id', 'd', '参数错误1');		$num = iv('post.num', "d", "参数错误2");		$buycoin = iv("post.coinpay", "a", "参数错误3");		$coin = db::table("coin")->where(["title" => $buycoin])->find();		$coinpay = $coin["name"];		$shop = db::table("shop")->where(["id" => $id])->find();		$shop['coin_title'] = $coin["title"];		$heji = num($num * $shop['price']);		$shop_coinpay = db::table("shop_coinpay")->where(["coinpay" => $coin["name"]])->find();		if ($coinpay == 'cny') {			$bili = '';			$shiji = $heji;		} else if (!$shop_coinpay || !$shop_coinpay["bili"]) {			$price = db::table("trade_market")->where(["name" => "$coinpay" . "_cny"])->find();			$bili = $price["new_price"];			if (!$bili) {				ajax("参数错误");			}			$shiji = num($num * $shop['price'] / $bili);		} else {			$bili = $shop_coinpay["bili"];			if (!$bili) {				ajax("参数错误");			}			$shiji = num($num * $shop['price'] / $shop_coinpay["bili"]);		}		$this->userid = $this->userid(1);		if ($this->userid) {			$user_goods = db::table("user_goods")->where(["userid" => $this->userid])->select();			$res["user_goods"] = $user_goods;		}		$res["shop"] = $shop;		$res["num"] = $num;		$res["buycoin"] = $coinpay;		$res["bili"] = $bili;		$res["shiji"] = $shiji;		ajax($res, 1);	}	public function order_up()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$num = iv('post.num', 'd', '数量错误');		$coinpay = iv('post.coinpay', 'w', '币种错误');		$shop_id = iv('post.shop_id', 'd', '商品错误');		$user_goods_id = iv('post.user_goods_id', 'a', '收货地址错误');		$liuyan = iv('post.liuyan', 'a', '留言格式错误', 1);		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$user = db::table("user")->where(["id" => $this->userid])->find();		if (!$user) {			ajax("请先登录");		}		if (empty($user['paypassword'])) {			ajax('交易密码非法');		}		if (hashs($paypassword) != $user['paypassword']) {			ajax('交易密码错误');		}		$res = md('shop')->order_up($this->userid, $shop_id, $num, $coinpay, $user_goods_id, $liuyan);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("shop_log", $where, "id desc");		foreach ($res["list"] as $k => $v) {			$res["list"][$k]["addtime"] = addtime($v["addtime"]);		}		ajax($res, 1);	}	public function shouhuo()	{		$id = iv('post.id', 'd', '请选择id');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$user = db::table("user")->where(["id" => $this->userid])->find();		if (empty($user['paypassword'])) {			ajax('交易密码非法');		}		if (hashs($paypassword) != $user['paypassword']) {			ajax('交易密码错误');		}		$shop_log = db::table("shop_log")->where(["id" => $id])->find();		if (!$shop_log) {			ajax('参数错误');		}		if ($shop_log['status'] != 3) {			ajax('非法访问1');		}		if ($shop_log['userid'] != $this->userid) {			ajax('非法访问2');		}		$res = db::table("shop_log")->where(["id" => $id])->save(['status' => 1]);		if (isset($res[1]) && $res[1]) {			ajax('操作成功', 1);		} else {			ajax($res[0]);		}	}} 