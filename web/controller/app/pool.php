<?phpnamespace app;use Move\db;class pool extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$status = iv("status", "d", "参数错误", 1);		$where["userid"] = $this->userid;		$where["status#!="] = 0;		if ($status) {			$where["status"] = $status;		}		$res = parent::pullpage("pool", $where, "id desc");		foreach ($res["list"] as $k => $v) {			if ($res["list"][$k]["addtime"]) {				$res["list"][$k]["addtime"] = addtime($res["list"][$k]["addtime"], "y/m/d");			} else {				$res["list"][$k]["addtime"] = "----";			}			if ($res["list"][$k]["strtime"]) {				$res["list"][$k]["strtime"] = addtime($res["list"][$k]["strtime"]);			} else {				$res["list"][$k]["strtime"] = "----";			}			if ($res["list"][$k]["gettime"]) {				$res["list"][$k]["gettime"] = addtime($res["list"][$k]["gettime"]);			} else {				$res["list"][$k]["gettime"] = "----";			}		}		ajax($res, 1);	}	public function str()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv("post.id", "d", "参数错误");		$paypassword = iv("post.paypassword", "password", "交易密码格式错误");		if (!$this->userid) {			ajax("请先登录");		}		$user = db::table("user")->where(["id" => $this->userid])->find();		if (hashs($paypassword) != $user["paypassword"]) {			ajax("交易密码错误");		}		$pool = db::table("pool")->where(["id" => $id])->find();		if (!$pool) {			ajax("矿机不存在");		}		if ($pool['userid'] != $this->userid) {			ajax("用户不合法");		}		if ($pool["status"] == 3) {			ajax("该矿机寿命用完了");		}		$res = db::table("pool")->where(["id" => $id])->save(["status" => 2, "strtime" => time()]);		if ($res) {			ajax('操作成功', 1);		}	}	public function end()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv("post.id", "d", "参数错误");		$paypassword = iv("post.paypassword", "password", "交易密码格式错误");		if (!$this->userid) {			ajax("请先登录");		}		$user = db::table("user")->where(["id" => $this->userid])->find();		if (hashs($paypassword) != $user["paypassword"]) {			ajax("交易密码错误");		}		$pool = db::table("pool")->where(["id" => $id])->find();		if (!$pool) {			ajax("矿机不存在");		}		if ($pool["status"] != 2) {			ajax("该矿机未工作");		}		if ($pool['userid'] != $this->userid) {			ajax("用户不合法");		}		$pool_log = db::table("pool_log")->where(["workerid" => $id])->order("id desc")->limit(1)->find();		if (!$pool_log["gettime"] && strtotime(addtime($pool['strtime'], "y-m-d")) != strtotime(addtime(time(), "y-m-d"))) {			ajax("你有未领取的收益,请领取后再关闭");		}		if ($pool_log["gettime"] && strtotime(addtime($pool_log['gettime'], "y-m-d")) != strtotime(addtime(time(), "y-m-d"))) {			ajax("你有未领取的收益,请领取后再关闭");		}		$res = db::table("pool")->where(["id" => $id])->save(["status" => 1, "strtime" => 0]);		if ($res) {			ajax('操作成功', 1);		}	}	public function get()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv("post.id", "d", "参数错误");		$paypassword = iv("post.paypassword", "password", "交易密码格式错误");		if (!$this->userid) {			ajax("请先登录");		}		$user = db::table("user")->where(["id" => $this->userid])->find();		if (hashs($paypassword) != $user["paypassword"]) {			ajax("交易密码错误");		}		$res = md('pool')->get($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function market()	{		$where["status"] = 1;		$res = parent::pullpage("pool_market", $where, "id desc");		ajax($res, 1);	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("pool_log", $where, "id desc", 10);		foreach ($res["list"] as $k => $v) {			$res["list"][$k]["gettime"] = addtime($res["list"][$k]["gettime"]);		}		ajax($res, 1);	}	public function buy()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		if (!$this->userid) {			ajax("请先登录", -99);		}		$id = iv("post.id", "d", "参数错误");		$paypassword = iv("post.paypassword", "password", "交易密码格式错误");		$num = 1;		$user = db::table("user")->where(["id" => $this->userid])->find();		if (!$user) {			ajax("用户异常");		}		if (hashs($paypassword) != $user["paypassword"]) {			ajax("交易密码错误");		}		$res = md('pool')->buy($this->userid, $id, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}}