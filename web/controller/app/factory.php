<?phpnamespace app;use Move\db;use Move\ext\page;class factory extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$this->set_title('养殖工厂');		$this->userid = $this->userid();		if ($this->userid) {			md('factory')->checkStatus($this->userid);		}		$where = ["userid" => session("userid"), "type" => 1, "status#!=" => 0];		$res = parent::pullpage("factory_proterty", $where, "id desc");		foreach ($res['list'] as $k => $v) {			$res['list'][$k]["addtime"] = addtime($v["addtime"]);			if ($v["lastFeedTime"] != 0) {				$res['list'][$k]["lastFeedTime"] = addtime($v["lastFeedTime"]);			}		}		$page['tool'] = $res;		$where2 = ["userid" => session("userid"), "type" => 2, "status#!=" => 0];		$res2 = parent::pullpage("factory_proterty", $where2, "id desc");		foreach ($res2['list'] as $k => $v) {			$goods = db::table("factory_goods")->where(["goodsName" => $v["protertyName"]])->find();			if ($goods['id']) {				$res2['list'][$k]["goodsId"] = $goods['id'];				$res2['list'][$k]["price"] = $goods['price'];				$res2['list'][$k]["coin"] = $goods['coin'];			}			$res2['list'][$k]["addtime"] = addtime($v["addtime"]);		}		$page['food'] = $res2;		ajax($page, 1);	}	public function feed()	{		$id = iv("post.id", "d", "参数错误");		$paypassword = iv("post.paypassword", "password", "交易密码格式错误");		$this->userid = $this->userid();		if (!$this->userid()) {			ajax("请先登录");		}		$res = md('factory')->feed($this->userid, $id, $paypassword);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function market()	{		$this->set_title('养殖工厂');		$where = ["status" => 1, 'type' => 1];		$tool = parent::pullpage("factory_goods", $where, "id desc");		$where2 = ["status" => 1, 'type' => 2];		$food = parent::pullpage("factory_goods", $where2, "id desc");		$res['tool'] = $tool;		$res['food'] = $food;		ajax($res, 1);	}	public function buyLog()	{		$this->userid = $this->userid();		$where = ["userid" => $this->userid];		$res = parent::pullpage("factory_buylog", $where, "id desc", 6);		foreach ($res['list'] as $k => $v) {			$res['list'][$k]['addtime'] = addtime($v['addtime']);		}		ajax($res, 1);	}	public function buy()	{		$id = iv("post.id", "d", "参数错误");		$paypassword = iv("post.paypassword", "password", "交易密码格式错误");		$num = iv("post.num", "d", "数量错误");		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$res = md('factory')->buy($this->userid, $id, $paypassword, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function order()	{		$this->set_title('养殖工厂');		$status = iv("status");		if ($status == '') {			redirect("/factory/index");			exit();		}		$arr = db::table("factory_proterty")->where(["userid" => session("userid"), "type" => 1, "status" => $status])->count();		$PageObj = new page($arr, 15);		$show = $PageObj->show();		$list = db::table("factory_proterty")->where(["userid" => session("userid"), "type" => 1, "status" => $status])->order("`id` desc")->limit($PageObj->firstRow, $PageObj->listRows)->select();		$pages['tool'] = ['show' => $show, 'list' => $list];		$arr2 = db::table("factory_proterty")->where(["userid" => session("userid"), "type" => 2, "status#!=" => 0])->count();		$PageObj2 = new page($arr2, 5);		$show2 = $PageObj2->show();		$list2 = db::table("factory_proterty")->where(["userid" => session("userid"), "type" => 2, "status#!=" => 0])->order("`id` desc")->limit($PageObj2->firstRow, $PageObj2->listRows)->select();		$pages['food'] = ['show' => $show2, 'list' => $list2];		$this->assign('pages', $pages);		$this->display("index");	}	public function gainLog()	{		$where = ["userid" => session("userid"), "status" => 1];		$pages = parent::pullpage("factory_getproduct", $where, "id desc", 6);		foreach ($pages['list'] as $k => $v) {			$pages['list'][$k]['addtime'] = addtime($v['addtime']);		}		ajax($pages, 1);	}}