<?phpnamespace app;use Move\db;class push extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$this->userid = $this->userid(1);		$pushCoin = [];		$push_config = db::table('push_config')->where(['can_push' => 1])->select();		if (!$push_config) {			ajax("push未配置");		}		$condition = [];		foreach ($push_config as $k => $v) {			$condition[] = $v['coinid'];		}		if (!$condition) {			ajax('push配置错误');		}		$coin = db::table('coin')->where(['id#in' => $condition])->select();		if (!$coin) {			ajax('暂无支持push的币种');		}		foreach ($coin as $k => $v) {			foreach ($push_config as $k2 => $v2) {				if ($v['id'] == $v2['coinid']) {					$row = ['shouxufeibili' => $v2['shouxufeibili'], 'coinid' => $v2['coinid'], 'name' => $v['name'], 'title' => $v['title'], 'img' => $v['img']];					$pushCoin[] = $row;				}			}		}		if ($this->userid) {			$user_coin = db::table('user_coin')->where(['userid' => $this->userid])->find();			foreach ($pushCoin as $k => $v) {				$pushCoin[$k]['shouxufeibili'] = round($v['shouxufeibili']);				$pushCoin[$k]['img'] = '/upload/' . $v['img'];				$pushCoin[$k]['cny'] = @empty($user_coin['cny']) ? 0 : $user_coin['cny'];				$pushCoin[$k][$v['name']] = @empty($user_coin[$v['name']]) ? 0 : $user_coin[$v['name']];			}			$user = db::table('user')->where(['id' => $this->userid])->find();			if (empty($user['moble'])) {				ajax('已绑定手机号错误');			}			if ($user['moble']) {				$user['moble'] = substr_replace(str_replace("|", " ", $user['moble']), '****', 7, 4);			}			$res = ['userid' => $user['id'], 'mobile' => $user['moble'], "finan" => $user_coin,];		}		$res["coin"] = $pushCoin;		ajax($res, 1);	}	public function log()	{		$this->userid = $this->userid();		$push_type = iv("get.push_type", "d", "参数错误");		if ($push_type != 1 && $push_type != 2) {			ajax('push_type参数不符合要求');		}		$where = null;		if ($push_type == 1) {			$where = ['send_id' => $this->userid];		} else {			$where = ['rev_id' => $this->userid];		}		$res = parent::pullpage("push_log", $where, "id desc", 10);		foreach ($res["list"] as $k => $v) {			$res["list"][$k]["addtime"] = addtime($v["addtime"]);			$res["list"][$k]['mum'] = round($v['buynum'] * $v['price'], 2);			$res["list"][$k]["shouxufeibili"] = round($v['shouxufeibili'], 2);			$res["list"][$k]["price"] = round($v['price'], 4);			if ($push_type == 1) {				$res["list"][$k]['shouxufei'] = round($v['buynum'] * $v['price'] * ($v['shouxufeibili'] / 100), 2);			}		}		ajax($res, 1);	}	public function push_send_moble()	{		$this->userid = $this->userid(1);		$user = db::table("user")->where(["id" => $this->userid])->find();		parent::doMoble("push", "send", $user['moble']);	}	public function pushUp()	{		$this->userid = $this->userid();		$uid = iv("post.uid");		$coinname = iv("post.coin", 'w', '币种 格式错误');		$num = iv("post.num", 'xnb', 'PUSH数量 格式错误');		$moble_verify = iv("post.code", 'd', '短信验证码格式错误');		$price = iv("post.price", 'xnb', '交易价格格式错误');		$paypassword = iv("post.paypassword", 'password', '交易密码格式错误');		$rev_user = null;		if (check($uid, 'username')) {			$rev_user = db::table("user")->where(["username" => $uid])->find();		} else if (check($uid, 'moble')) {			$rev_user = db::table("user")->where(["moble" => '+86|' . $uid])->find();		} else if (check($uid, 'd')) {			$rev_user = db::table("user")->where(["id" => $uid])->find();		}		if (!$rev_user) {			ajax('对方用户不存在');		}		if ($rev_user["id"] == $this->userid) {			ajax('不能向自己发起PUSH交易');		}		$user = db::table("user")->where(["id" => $this->userid])->find();		$pre = parent::doMoble("push", "check", $user['moble'], 1);		$res = md('push')->pushUp($this->userid, $uid, $coinname, $num, $price, $paypassword);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function cancelSend()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$pushid = iv('post.id', 'd', 'push记录id格式错误');		$res = md('push')->cancelSend($this->userid, $pushid);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function refuseTrade()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$pushid = iv('post.id', 'd', 'push记录id格式错误');		$res = md('push')->refuseTrade($this->userid, $pushid);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function surePush()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax("请先登录");		}		$pushid = iv('post.id', 'd', 'push记录id格式错误');		$res = md('push')->surePush($this->userid, $pushid);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}}