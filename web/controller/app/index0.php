<?phpnamespace app;use home\news;use Move\db;class index extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		redirect('/index/app');	}	public function test()	{		$homeRollType = iv('homeRollType');		$homeRollType = (($homeRollType == null) || ($homeRollType == '')) ? 1 : $homeRollType;		echo $homeRollType;	}	public function initinfo()	{		$web_info = db::table('sys_config')->select();		$info = [];		$titleArray = ['web_name', 'web_title', 'web_logo', 'web_keywords', 'web_description', 'web_icp'];		foreach ($web_info as $key => $value) {			for ($index = 0; $index < count($titleArray) - 1; $index++) {				if ($value['name'] == $titleArray[$index]) {					$info["web_info"][$value['name']] = ['title' => $value['title'], 'value' => $value['value']];				}			}		}		$info['charge_account'] = ["alipay" => ["name" => "", "value" => ""], "bank" => ["name" => "", "value" => ""]];		$info['myczTypeList'][] = ['type' => 'alipay', 'title' => '支付宝转账支付'];		$info['myczTypeList'][] = ['type' => 'bank', 'title' => '网银转账支付'];		$where = [];		$news_type_list = db::table('article_type')->where(['type' => 1, "status" => 1])->limit(3)->order("`sort` ASC ,`id` desc")->select();		if ($news_type_list) {			foreach ($news_type_list as $k => $v) {				if ($v['title'] == '行业资讯') {					$where = ['type_id' => $v['id'], 'status' => 1];				}			}		}		$news = db::table("article")->where($where)->order("id desc")->field("id,username,title,addtime,value")->limit(10)->select();		$type_arr = ['系统公告', '帮助中心', '关于我们'];		$typeName = "行业资讯";		$banner = db::table("sys_ad")->where(["type" => "app"])->select();		if ($banner) {			foreach ($banner as $val) {				if (false !== stripos($val["img"], "http")) {					$src = $val["img"];					$_mc_key = "INDEX_BANNER_" . md5($src);					if (!$code = mc($_mc_key)) {					}					$info['banner'][] = ["src" => $src, "href" => $val["url"]];				} else {					$src = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $val["img"];					$_mc_key = "INDEX_BANNER_" . md5($src);					if (!$code = mc($_mc_key)) {					}					$info['banner'][] = ["src" => $src, "href" => $val["url"]];				}			}		} else {			$info['banner'] = [];		}		foreach ($news as $val) {			$title = mb_strlen($val['title']) > 10 ? mb_substr($val['title'], 0, 50, 'utf-8') . '...' : $val['title'];			$img = null;			preg_match_all('/<img.*?src="(.*?)".*?>/is', $val['value'], $img);			$newsImg = isset($img['1']['0']) ? $img['1']['0'] : "";			$info['News'][] = ['id' => $val['id'], 'type' => $typeName, 'title' => mb_substr($title, 0, 10), 'img' => $newsImg, 'view' => rand(100, 800), 'time_m' => date("m", $val['addtime']), 'time_d' => date("d", $val['addtime'])];		}		$game_list = db::table('version_game')->where(['anzhuang' => 1, 'status' => 1, 'menu' => 1])->select();		if ($game_list) {			foreach ($game_list as $k => $v) {				$app[$k] = ['id' => $v['id'], 'name' => $v['name'], 'title' => $v['title'], 'img' => 'upload' . $v['img'], 'content' => $v['shuoming'],];			}		} else {			$app = [];		}		$info['app'] = $app;		ajax($info, 1);	}	public function banner()	{		$banner = db::table("sys_ad")->where(["type" => "app"])->select();		if ($banner) {			foreach ($banner as $val) {				if (false !== stripos($val["img"], "http")) {					$src = $val["img"];					$_mc_key = "INDEX_BANNER_" . md5($src);					if (!$code = mc($_mc_key)) {						$code = base64_encode(file_get_contents($val["img"]));						mc($_mc_key, $code);					}					$info['banner'][] = ["src" => $src, "href" => $val["url"], "code" => $code];				} else {					$src = 'http://' . $_SERVER['HTTP_HOST'] . "/upload/" . $val["img"];					$_mc_key = "INDEX_BANNER_" . md5($src);					if (!$code = mc($_mc_key)) {						$code = base64_encode(file_get_contents("./upload/" . $val["img"]));						mc($_mc_key, $code);					}					$info['banner'][] = ["src" => $src, "href" => $val["url"], "code" => $code];				}			}		} else {			$info = [];		}		ajax($info, 1);	}	public function coininfo()	{		$info = $this->_coininfo();		ajax($info, 1);	}	protected function _coininfo()	{		$trade_qu = db::table('trade_qu')->where(['status' => 1])->order('sort asc ,id asc')->select();		$trade_qu_data = [];		foreach ($trade_qu as $k => $v) {			$trade_qu_arry = explode(",", $v['data']);			$trade_qu_data = array_merge($trade_qu_data, $trade_qu_arry);		}		$market_list = db::table("trade_market")->where(["status" => 1, "id#in" => $trade_qu_data])->order("trade asc,id asc ,addtime asc")->select();		$info = array();		foreach ($market_list as $val) {			$arr = explode("_", $val["name"]);			$mymc_coin = new \mymc\coin();			$coin = $mymc_coin->find($arr[0]);			$round = $coin['round'];			if ($round <= 0) {				$round = 2;			}			$info['market'][] = array('id' => (string)$val['id'], 'title' => $val['title'], 'name' => $val['name'], 'ico' => '/upload/' . $val['img'], 'new_price' => num($val['new_price'], $round), 'buy_price' => num($val['buy_price'], $round), 'sell_price' => num($val['sell_price'], $round), 'min_price' => num($val['min_price'], $round), 'max_price' => num($val['max_price'], $round), 'change' => num($val['change'], 2), 'volume' => num($val['volume'], 2));		}		$mymc_coin = new \mymc\coin();		$coin_list = $mymc_coin->select(1);		foreach ($coin_list as $val) {			if ($val['name'] == "cny") {				continue;			}			$info['coins'][] = ["id" => $val['id'], "name" => $val['name'], "title" => $val['title'], "type" => $val['type'], "wallet" => $val['wallet'], "ico" => '/upload/coin/' . $val['img'],];		}		return $info;	}	public function verify()	{		$randstr = iv("randstr", 'wd', 'GET randstr is require');		if (strlen($randstr) != 32) {			ajax("randstr is must 32 bit");		}		$codelen = 4;		$width = 130;		$height = 50;		$img = "";		$font = "";		$fontsize = 20;		$fontcolor = "";		$font = defined(APP_PATH) ? APP_PATH . "/static/extend/elephant.ttf" : '/static/extend/elephant.ttf';		$img = imagecreatetruecolor($width, $height);		$color = imagecolorallocate($img, mt_rand(157, 255), mt_rand(157, 255), mt_rand(157, 255));		imagefilledrectangle($img, 0, $height, $width, 0, $color);		$code = parent::getRandCode($codelen);		for ($i = 0; $i < 6; $i++) {			$color = imagecolorallocate($img, mt_rand(0, 156), mt_rand(0, 156), mt_rand(0, 156));			imageline($img, mt_rand(0, $width), mt_rand(0, $height), mt_rand(0, $width), mt_rand(0, $height), $color);		}		for ($i = 0; $i < 100; $i++) {			$color = imagecolorallocate($img, mt_rand(200, 255), mt_rand(200, 255), mt_rand(200, 255));			imagestring($img, mt_rand(1, 5), mt_rand(0, $width), mt_rand(0, $height), '*', $color);		}		$_x = $width / $codelen;		for ($i = 0; $i < $codelen; $i++) {			$fontcolor = imagecolorallocate($img, mt_rand(0, 156), mt_rand(0, 156), mt_rand(0, 156));			imagettftext($img, $fontsize, mt_rand(-30, 30), $_x * $i + mt_rand(1, 5), $height / 1.4, $fontcolor, $font, $code[$i]);		}		header('Content-type:image/png');		imagepng($img);		imagedestroy($img);		mc("VERIFY_" . hashs($randstr), strtolower($code));	}	public function check_verify()	{		if (parent::checkVerify()) {			ajax("验证码测试通过");		}	}	public function getlinks()	{		$sysLinks = db::table("sys_link")->where(["status" => 1])->select();		foreach ($sysLinks as $k => $v) {			$sysLinks[$k]['img'] = '/upload/' . $v['img'];		}		if ($sysLinks) {			ajax($sysLinks, 1);		} else {			ajax('友情链接未设置');		}	}} 