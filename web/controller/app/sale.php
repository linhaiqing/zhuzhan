<?phpnamespace app;use Move\db;class sale extends home{	public function __construct()	{		parent::__construct();	}	public function index()	{		$res["banner"] = db::table("sys_ad")->where(["type" => "app"])->select();		foreach ($res['banner'] as $val) {			$res['banner'][] = "/upload/" . $val["img"];		}		$res["will"] = db::table("sale")->where(["status" => 1])->order("strtime  desc")->limit(3)->field("id,name,title,img,minprice,fudu,price,strtime,endtime,coin,danbao")->select();		$mymc_coin = new \mymc\coin();		foreach ($res["will"] as $k => $v) {			$coin = $mymc_coin->find($v['coin']);			$res["will"][$k]["cointitle"] = $coin["title"];			$res["will"][$k]["strtime"] = addtime($v["strtime"]);			$res["will"][$k]["img"] = "/upload/" . $v['img'];		}		$res["goning"] = db::table("sale")->where(["status" => 2])->order("id  desc")->limit(3)->field("id,name,title,img,minprice,fudu,price,strtime,endtime,coin,danbao")->select();		foreach ($res["goning"] as $k => $v) {			$coin = $mymc_coin->find($v['coin']);			$res["goning"][$k]["cointitle"] = $coin["title"];			$res["goning"][$k]["endtime"] = addtime($v["endtime"]);			$res["goning"][$k]["img"] = "/upload/" . $v['img'];		}		$res["done"] = db::table("sale")->where(["status" => 3])->order("id  desc")->limit(3)->field("id,name,title,img,minprice,fudu,price,strtime,endtime,coin,danbao")->select();		foreach ($res["done"] as $k => $v) {			$coin = $mymc_coin->find($v['coin']);			$res["done"][$k]["cointitle"] = $coin["title"];			$res["done"][$k]["endtime"] = addtime($v["endtime"]);			$res["done"][$k]["img"] = "/upload/" . $v['img'];		}		ajax($res);	}	public function type_list()	{		$top_list = db::table("sale_type")->where(["status" => 1, "pid" => 0])->order("sort asc , id desc")->field("id,title,pid")->select();		if ($top_list) {			foreach ($top_list as $k => $v) {				$top_list[$k]['pid_list'] = db::table("sale_type")->where(["status" => 1, "pid" => $v['id']])->order("sort asc , id desc")->field("id,title,pid")->select();				if ($top_list[$k]['pid_list']) {					foreach ($top_list[$k]['pid_list'] as $kk => $vv) {						$top_list[$k]['pid_list'][$kk]['pid_list'] = db::table("sale_type")->where(["status" => 1, "pid" => $vv['id']])->order("sort asc , id desc")->field("id,title,pid")->select();						if ($top_list[$k]['pid_list'][$kk]['pid_list']) {							foreach ($top_list[$k]['pid_list'][$kk]['pid_list'] as $kkk => $vvv) {								$top_list[$k]['pid_list'][$kk]['pid_list'][$kkk]['pid_list'] = db::table("sale_type")->where(["status" => 1, "pid" => $vvv['id']])->field("id,title,pid")->order("sort asc , id desc")->select();							}						}					}				}			}		}		$res["shop_type1"] = $top_list;		ajax($res, 1);	}	public function lists()	{		$res["other"]["type3"] = iv('get.type3', "d", "参数错误", 1);		$where = [];		if ($res["other"]["type3"]) {			$where["type"] = $res["other"]["type3"];		} else {			$res["other"]["type3"] = 0;		}		$status = iv('get.status', "d", "状态参数错误", 1);		if ($status) {			if ($status == 1) {				$where["status"] = 1;			}			if ($status == 2) {				$where["status"] = 2;			}			if ($status == 3) {				$where["status"] = 3;			} else {				$where["status#!="] = 0;			}		} else {			$status = 0;			$where["status#!="] = 0;		}		$res["other"]["status"] = $status;		$res["other"]["sort"] = iv('get.sort', "d", "参数错误", 1);		if (!$res["other"]["sort"]) {			$res["other"]["sort"] = 0;			$order = "id";		}		if ($res["other"]["sort"] == 1) {			$order = "minprice";		}		if ($res["other"]["sort"] == 2) {			$order = "addtime";		}		$res["data"] = parent::pullpage("sale", $where, "$order asc", 8);		$mymc_coin = new \mymc\coin();		foreach ($res["data"]["list"] as $k => $v) {			$coin = $mymc_coin->find($v['coin']);			$res["data"]["list"][$k]["cointitle"] = $coin["title"];			$res["data"]["list"][$k]["strtime"] = addtime($v["strtime"]);			$res["data"]["list"][$k]["endtime"] = addtime($v["endtime"]);			$res["data"]["list"][$k]["img"] = "/upload/" . $v['img'];		}		ajax($res, 1);	}	public function view()	{		$id = iv('get.id', 'd', '参数错误');		$sale1 = db::table("sale")->where(["id" => $id])->find();		if ($sale1["status"] == 0) {			ajax("该商品不支持拍卖");		}		$status = 1;		if (time() >= $sale1["strtime"]) {			$status = 2;		}		if (time() >= $sale1["endtime"] && $sale1["price"] >= $sale1["keepprice"]) {			$status = 3;		}		if (time() >= $sale1["endtime"] && $sale1["price"] < $sale1["keepprice"]) {			$status = 4;		}		md("sale")->check($id, $status);		$res["data"]["sale"] = db::table("sale")->where(["id" => $id])->field("id,name,title,img,minprice,fudu,price,strtime,endtime,coin,danbao,content,keepprice")->find();		$mymc_coin = new \mymc\coin();		$coin = $mymc_coin->find($res["data"]["sale"]['coin']);		$res["data"]["sale"]["cointitle"] = $coin["title"];		$res["data"]["sale"]["img"] = "/upload/" . $res["data"]["sale"]["img"];		$res["data"]["sale"]["strtime1"] = addtime($res["data"]["sale"]["strtime"]);		$res["data"]["sale"]["endtime1"] = addtime($res["data"]["sale"]["endtime"]);		$res["data"]["sale"]["content"] = str_replace("/upload", "/upload", $res["data"]["sale"]["content"]);		$res["data"]["img"] = db::table("sale_img")->where(["saleid" => $id, "status" => 1])->select();		foreach ($res["data"]["img"] as $k => $v) {			$res["data"]["img"][$k]["img"] = "/upload/" . $v['img'];		}		$where = ["saleid" => $id];		$res["log"] = parent::pullpage("sale_log", $where, "id desc", 8);		foreach ($res["log"]["list"] as $k => $v) {			$username = db::table("user")->where(["id" => $v["userid"]])->find();			$res["log"]["list"][$k]["username"] = substr_replace(str_replace("|", " ", $username['username']), '**', 3, 2);			$res["log"]["list"][$k]["addtime"] = addtime($v["addtime"]);		}		ajax($res, 1);	}	public function danbao()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv("post.id", "d", "商品格式错误");		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$user = db::table("user")->where(["id" => $this->userid])->find();		if (empty($user['paypassword'])) {			ajax('交易密码非法');		}		if (hashs($paypassword) != $user['paypassword']) {			ajax('交易密码错误');		}		$res = md('sale')->danbao($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function danbaolog()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("sale_danbaolog", $where, "id desc", 5);		foreach ($res["list"] as $k => $v) {			$res["list"][$k]["addtime"] = addtime($v["addtime"]);			$res["list"][$k]["endtime"] = addtime($v["endtime"]);		}		ajax($res, 1);	}	public function up()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv('post.id', 'd', '参数非法');		$price = iv('post.price', 'double', '参数非法');		$res = md('sale')->up($this->userid, $id, $price);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function log()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$where["userid"] = $this->userid;		$res = parent::pullpage("sale_log", $where, "id desc", 5);		foreach ($res["list"] as $k => $v) {			$sale = db::table('sale')->where(["id" => $v["saleid"]])->find();			$res["list"][$k]["time"] = $sale["time"];			$res["list"][$k]["addtime"] = addtime($v["addtime"]);		}		ajax($res, 1);	}	public function order()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv('get.id', 'd', '参数错误');		$res["log"] = db::table("sale_log")->where(["id" => $id, "userid" => $this->userid])->find();		if ($res["log"] && $res["log"]["status"] != 1) {			ajax("非法访问1");		}		$res["user_goods"] = db::table("user_goods")->where(["userid" => $this->userid])->select();;		ajax($res, 1);	}	public function order_up()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$coinpay = iv('post.coinpay', 'w', '币种错误');		$id = iv('post.id', 'd', '请求错误');		$sale_id = iv('post.sale_id', 'd', '商品错误');		$user_goods_id = iv('post.user_goods_id', 'd', '收货地址错误');		$liuyan = iv('post.liuyan');		if ($liuyan) {			if (!check($liuyan, 'a')) {				ajax('留言格式错误');			}		}		$res = md('sale')->order_up($this->userid, $id, $coinpay, $sale_id, $user_goods_id, $liuyan);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function shouhuo()	{		$this->userid = $this->userid();		if (!$this->userid) {			ajax('请登录', -99);		}		$id = iv('post.id', 'd', '请选择正确的选项');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$user = db::table("user")->where(["id" => $this->userid])->find();		if (empty($user['paypassword'])) {			ajax('交易密码非法');		}		if (hashs($paypassword) != $user['paypassword']) {			ajax('交易密码错误');		}		$sale_log = db::table("sale_log")->where(["id" => $id])->find();		if ($sale_log["status"] != 2) {			ajax("当前状态不能确认收货");		}		$sale = db::table("sale")->where(["id" => $sale_log["saleid"]])->find();		if (!$sale) {			ajax('参数错误!');		}		if ($sale_log['userid'] != $this->userid) {			ajax('非法访问2');		}		$res = db::table("sale_log")->where(["id" => $id])->save(["status" => 3]);		if ($res) {			ajax('成功', 1);		} else {			ajax('失败');		}	}}