<?phpnamespace home;use Move\db;use Move\ext\page;class weibo extends home{	public function __construct()	{		parent::__construct();		$this->is_game('weibo');	}	public function index()	{		$this->set_title('微博管理');		$type = iv('get.type');		$allweibo = db::table('weibo')->select();		$count = db::table('weibo')->count();		$page_obj = new page($count, 10);		$show = $page_obj->show();		if (!$type) {			$weibo = db::table('weibo')->order('id desc')->limit($page_obj->firstRow, $page_obj->listRows)->select();		} else {			$weibo = $allweibo;		}		$condition = [];		foreach ($weibo as $k => $value) {			$condition[] = $value['id'];		}		if ($condition) {			$zanlist = @db::table('weibo_log')->where(['art_id#in' => $condition, 'user_id' => $this->user['id']])->select();			$artzan = db::table('weibo_log')->where(['art_id#in' => $condition])->select();		}		foreach ($weibo as $k2 => $v2) {			$weibo[$k2]['zan'] = 0;			$weibo[$k2]['shouchang'] = 0;			foreach ($zanlist as $k3 => $v3) {				if ($v2['id'] == $v3['art_id']) {					$weibo[$k2]['zan'] = $v3['zan'];					$weibo[$k2]['shouchang'] = $v3['shouchang'];				}			}		}		foreach ($weibo as $k => $v) {			$weibo[$k]['zannum'] = 0;			foreach ($artzan as $k2 => $v2) {				if ($v['id'] == $v2['art_id'] && $v2['zan'] == 1) {					$weibo[$k]['zannum'] = $weibo[$k]['zannum'] + 1;				}			}		}		$huati = [];		$huatiList = [];		foreach ($allweibo as $k => $v) {			$huati[] = $v['title'];		}		$huati = array_unique($huati);		foreach ($huati as $value) {			$a = [];			$a['title'] = $value;			$a['num'] = 0;			$huatiList[] = $a;		}		foreach ($allweibo as $k => $v) {			foreach ($huatiList as $k2 => $v2) {				if ($v['title'] == $v2['title']) {					$huatiList[$k2]['num'] = $v2['num'] + 1;				}			}		}		foreach ($huatiList as $key => $row) {			$num1[$key] = $row ['num'];		}		$remen = [];		if ($huatiList) {			array_multisort($num1, SORT_DESC, $huatiList);			$remen = array_slice($huatiList, 0, 10);			$this->assign('remen', $remen);		}		$weibo_auther_condition = [];		$weibo_auther = [];		foreach ($weibo as $k => $value) {			$weibo_auther_condition[] = $value['auther_id'];			$weibo_auther[$k]['auther_id'] = $value['auther_id'];		}		if ($weibo_auther_condition) {			$weibo_user = db::table('user')->where(['id#in' => $weibo_auther_condition])->select();			$weibo_config = db::table('weibo_config')->where(['user_id#in' => $weibo_auther_condition])->select();		} else {			$weibo_user = [];			$weibo_config = [];		}		foreach ($weibo_auther as $kk => $vv) {			foreach ($weibo_user as $k2 => $v2) {				if ($vv['auther_id'] == $v2['id']) {					$weibo_auther[$kk]['auther_username'] = $v2['username'];				}			}		}		$imgArr = [];		foreach ($weibo_auther as $kk => $vv) {			foreach ($weibo_config as $k2 => $v2) {				if ($vv['auther_id'] == $v2['user_id']) {					$weibo_auther[$kk]['img_id'] = $v2['img'];					if (!in_array($v2['img'], $imgArr)) {						$imgArr[] = $v2['img'];					}				}			}		}		$guanzhu = @db::table('weibo_guanzhu')->where(['user_id' => $this->user['id']])->select();		foreach ($weibo_auther as $k2 => $v2) {			$weibo[$k2]['guanzhu'] = 0;			foreach ($guanzhu as $k3 => $v3) {				if ($v2['auther_id'] == $v3['guanzhu_id']) {					$weibo[$k2]['guanzhu'] = 1;				}			}		}		if ($imgArr) {			$weibo_img = db::table('weibo_img')->where(['id#in' => $imgArr])->select();		}		foreach ($weibo_auther as $kk => $vv) {			foreach ($weibo_img as $k2 => $v2) {				if ($vv['img_id'] == $v2['id']) {					$weibo_auther[$kk]['img'] = $v2['img'];				}			}		}		foreach ($weibo as $k => $v) {			foreach ($weibo_auther as $k2 => $v2) {				if ($v['auther_id'] == $v2['auther_id']) {					$weibo[$k]['img'] = $v2['img'];					$weibo[$k]['auther_name'] = $v2['auther_username'];					$weibo[$k]['addtime'] = addtime($v['addtime']);				}			}		}		$pinlunlist = [];		$replylist = [];		if ($condition) {			$data = db::table('weibo_pinlun')->where(['art_id#in' => $condition])->select();			foreach ($data as $k => $value) {				if ($value['type'] == 1) {					$pinlunlist[] = $value;				}				if ($value['type'] == 2) {					$replylist[] = $value;				}			}		}		$select_user = [];		foreach ($weibo as $k2 => $v2) {			$hasComment = false;			foreach ($pinlunlist as $k3 => $v3) {				if ($v2['id'] == $v3['art_id']) {					$pinlun = [];					$pinlun['user_id'] = $v3['user_id'];					$pinlun['content'] = $v3['content'];					$pinlun['id'] = $v3['id'];					$pinlun['reply'] = [];					foreach ($replylist as $k4 => $v4) {						if ($v3['id'] == $v4['pinlun_id']) {							$reply = [];							$reply['id'] = $v4['id'];							$reply['user_id'] = $v4['user_id'];							$reply['content'] = $v4['content'];							$reply['reply_id'] = db::table('weibo_pinlun')->where(['id' => $v4['reply_id']])->find('user_id');							$pinlun['reply'][] = $reply;							$select_user[] = $v4['user_id'];						}					}					$weibo[$k2]['pinlun'][] = $pinlun;					$select_user[] = $pinlun['user_id'];					$hasComment = true;				}			}			if (!$hasComment) {				$weibo[$k2]['pinlun'] = [];			}		};		$userList = [];		if ($select_user) {			$userList = db::table('user')->where(['id#in' => $select_user])->select();		}		foreach ($weibo as $k2 => $v2) {			foreach ($userList as $k3 => $v3) {				if ($v2['pinlun']) {					foreach ($v2['pinlun'] as $k => $value) {						if ($value['reply']) {							foreach ($value['reply'] as $k4 => $value4) {								if ($value4['user_id'] == $v3['id']) {									$weibo[$k2]['pinlun'][$k]['reply'][$k4]['username'] = $v3['username'];								}								if ($value4['reply_id'] == $v3['id']) {									$weibo[$k2]['pinlun'][$k]['reply'][$k4]['replyname'] = $v3['username'];								}							}						}						if ($v3['id'] == $value['user_id']) {							$weibo[$k2]['pinlun'][$k]['username'] = $v3['username'];						}					}				}			}		}		$guanzhu = [];		$log = [];		$shouchang = [];		foreach ($weibo as $k => $v) {			if ($v['guanzhu']) {				$guanzhu[] = $v;			}			if ($v['auther_id'] == @$this->user['id']) {				$log[] = $v;			}			if ($v['shouchang']) {				$shouchang[] = $v;			}		}		$this->assign('guanzhu', $guanzhu);		$pages = ["list" => $weibo, "show" => $show];		if ($type == 'guanzhu') {			$pages = ["list" => $guanzhu];		}		if ($type == 'log') {			$pages = ["list" => $log];		}		if ($type == 'shouchang') {			$pages = ["list" => $shouchang];		}		$this->assign('type', $type);		if (!$type) {			$this->assign('pages', $pages);		}		$this->display();	}	public function zan()	{		$this->set_title('微博管理');		$id = iv('post.id', 'd', '微博id格式错误');		if (!$this->userid) {			ajax('请登录');		}		$res = md('weibo')->zan($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function like()	{		$this->set_title('微博管理');		$id = iv('post.id', 'd', '微博id格式错误');		if (!$this->userid) {			ajax('请登录');		}		$res = md('weibo')->like($this->user['id'], $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function send_weibo()	{		$this->set_title('微博管理');		if (!$this->userid) {			ajax('请登录');		}		md('weibo')->weibo_config($this->userid);		$title = iv('post.title');		$content = iv('post.content');		$res = md('weibo')->send_weibo($this->user['id'], $title, $content);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function delete_weibo()	{		$this->set_title('微博管理');		$id = iv('post.id', 'd', '微博id格式错误');		if (!$this->userid) {			ajax('请登录');		}		$res = md('weibo')->delete_weibo($this->user['id'], $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function add_pinlun()	{		$this->set_title('微博管理');		if (!$this->userid) {			ajax('请登录');		}		md('weibo')->weibo_config($this->userid);		$art_id = iv('post.art_id');		$content = iv('post.content');		$res = md('weibo')->add_pinlun($this->user['id'], $art_id, $content);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function reply()	{		$this->set_title('微博管理');		$reply_id = iv('post.reply_id');		$content = iv('post.content');		if (!$this->userid) {			ajax('请登录');		}		$res = md('weibo')->reply($this->user['id'], $reply_id, $content);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function delete_pinlun()	{		$this->set_title('微博管理');		$id = iv('post.id', 'd', '回复id格式错误');		if (!$this->userid) {			ajax('请登录');		}		$res = md('weibo')->delete_pinlun($this->user['id'], $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function guanzhu()	{		$this->set_title('微博管理');		$id = iv('post.id', 'd', '关注人id格式错误');		if (!$this->userid) {			ajax('请登录');		}		$res = md('weibo')->guanzhu($this->user['id'], $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}}