<?phpnamespace home;use Move\db;use Move\ext\page;class issue extends home{	public function __construct()	{		parent::__construct();		// $this->is_game('issue');	}	public function index()	{		$this->set_title('认购中心');		$where = ["status" => 1];		$count = db::table('issue')->where($where)->count();		$page_obj = new page($count, 5);		$show = $page_obj->show();		$list = db::table('issue')->where($where)->order('`sort` asc ,id desc')->limit($page_obj->firstRow, $page_obj->listRows)->select();		if ($list) {			$mymc_coin = new \mymc\coin();			foreach ($list as $k => $v) {				$list[$k]["coin"] = $mymc_coin->find($v["coinname"]);			}		}		$pages = ["list" => $list, "show" => $show];		$this->assign('pages', $pages);		$this->display();	}	public function buy()	{		$this->set_title('立即认购');		$this->token = token('home_issue_buy');		$id = iv('get.id', 'd', '参数错误');		$issue = db::table("issue")->where(["id" => $id])->find();		if ($issue) {			$mymc_coin = new \mymc\coin();			$coin_coinname = $mymc_coin->find($issue["coinname"]);			$coin_buycoin = $mymc_coin->find($issue["buycoin"]);			if (!isset($coin_coinname['img']) || !$coin_coinname['img']) {				$coin_coinname['img'] = '';			}			$issue["img"] = $coin_coinname['img'];			$issue["bili"] = num($issue["deal"] / $issue["num"] * 100);			$issue["jieshu"] = ($issue["sndtime"] > time()) ? 1 : 0;			$issue["kaishi"] = ($issue["strtime"] > time()) ? 1 : 0;			$issue["buycoininfo"] = $coin_buycoin;			$issue["coininfo"] = $coin_coinname;		} else {			ajax('项目不存在');		}		$this->assign('issue', $issue);		if (session("userid")) {			$user = db::table('user')->where(['id' => session("userid")])->find();			$user_coin = db::table('user_coin')->where(['userid' => session("userid")])->find();		} else {			$user_coin = [];		}		$this->assign('user_coin', $user_coin);		$this->assign('user', $user);		$where = ["status#>=" => 0, "issueid" => $id];		$count = db::table('issue_log')->where($where)->count();		$page_obj = new page($count, 10);		$show = $page_obj->show();		$list = db::table('issue_log')->where($where)->order('`sort` asc ,id desc')->limit($page_obj->firstRow, $page_obj->listRows)->select();		if ($list) {			foreach ($list as $k => $v) {				$mymc_coin = new \mymc\coin();				$coin_coinname = $mymc_coin->find($v["coinname"]);				if (!isset($coin_coinname['img']) || !$coin_coinname['img']) {					$coin_coinname['img'] = '';				}				$list[$k]["coin"] = $coin_coinname;				$list[$k]["img"] = $coin_coinname['img'];				$list[$k]["username"] = db::table("user")->where(["id" => $v["userid"]])->find("username");				$list[$k]["username"] = substr_replace(str_replace("|", " ", $list[$k]["username"]), '**', 3, 2);			}		}		$pages = ["list" => $list, "show" => $show];		$this->assign('pages', $pages);		$this->display();	}	public function up()	{		$this->check_up('认购中心立即认购');		if (!session('home_issue_buy')) {			ajax('非法访问');		}		$token = iv("post.token", 'dw', '令牌错误');		$id = iv('post.id', 'd', '参数错误');		$num = iv('post.num', 'd', '认购数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		if (!$token || $token != session('home_issue_buy')) {			ajax('恶意访问');		}		if (!$this->userid) {			ajax('请先登录');		}		$res = md('issue')->up(session("userid"), $id, $num, $paypassword);		if (isset($res[1]) && $res[1]) {			session('home_issue_buy', null);			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function log()	{		$this->set_title('认购记录');		if ($this->userid) {			$where = ['userid' => $this->userid];			$count = db::table('issue_log')->where($where)->count();			$page_obj = new page($count, 15);			$show = $page_obj->show();			$list = db::table('issue_log')->where($where)->order('`sort` asc ,id desc')->limit($page_obj->firstRow, $page_obj->listRows)->select();			if ($list) {				foreach ($list as $k => $v) {					$mymc_coin = new \mymc\coin();					$coin_coinname = $mymc_coin->find($v["coinname"]);					if (!isset($coin_coinname['img']) || !$coin_coinname['img']) {						$coin_coinname['img'] = '';					}					$list[$k]["img"] = $coin_coinname['img'];					if ($v["ci"]) {						$list[$k]["shen"] = num((($v["ci"] - $v["jd"]) * $v["num"] / $v["ci"]), 8);					} else {						$list[$k]["shen"] = 0;					}				}			}		} else {			$list = [];			$show = '';		}		$this->pages = ["list" => $list, "show" => $show];		$this->display();	}	public function jiedong()	{		$this->check_up('认购中心解冻');		$id = iv('post.id', 'd', '请选择解冻项');		if (!$this->userid) {			ajax('请先登录');		}		$res = md('issue')->jiedong($this->userid, $id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function invit()	{		$this->set_title('认购赠送');		if ($this->userid) {			$where = ["userid" => $this->userid];			$count = db::table("issue_invit")->where($where)->count();			$PageObj = new page($count, 12);			$show = $PageObj->show();			$list = db::table("issue_invit")->where($where)->order("`id` desc")->limit($PageObj->firstRow, $PageObj->listRows)->select();			foreach ($list as $k => $v) {				if ($v['invit'] != 0) {					$list[$k]['invitname'] = db::table("user")->where(["id" => $v["invit"]])->find("username");				} else {					$list[$k]['invitname'] = '系统';				}			}		} else {			$list = [];			$show = '';		}		$this->pages = ["list" => $list, "show" => $show];		$this->display();	}} 