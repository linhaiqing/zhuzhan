<?phpnamespace home;use Move\db;use Move\config;use Move\cache;use move\ext\page;class xissue extends home{	public function __construct()	{		parent::__construct();		$this->is_game('xissue');	}	public function index()	{		show_msg("开发中....");		$banner = db::table("sys_ad")->where(["type" => "issue", "status" => 1])->order("sort asc ,id desc")->select();		$user_coin = md('user')->get_coin_info($this->userid);		$mymc_coin = new \mymc\coin();		$coinlist = $mymc_coin->select(1);		foreach ($coinlist as $k => $v) {			$arr = db::table("issue")->where(["status" => 1, "coinname" => $v["name"]])->count();			$PageObj = new page($arr, 10);			$show = $PageObj->show();			$list = db::table("issue")->where(["status" => 1, "coinname" => $v["name"]])->field("id,name,coinname,buycoin,num,deal,price,ci,jian,strtime,sndtime")->order("`id` desc")->limit($PageObj->firstRow, $PageObj->listRows)->select();			$pages = ['show' => $show, 'list' => $list];			$coinlist[$k]["data"] = $pages;			if (empty($pages["list"])) {				unset($coinlist[$k]);			}		}		$end = db::table("issue")->where(["status" => 1, "sndtime#<" => time()])->field("id,name,coinname,buycoin,num,deal,price,ci,jian,strtime,sndtime")->order("sndtime desc")->limit(1)->find();		$new = db::table("issue")->where(["status" => 1, "strtime#>" => time()])->field("id,name,coinname,buycoin,num,deal,price,ci,jian,strtime,sndtime")->order("strtime asc")->limit(1)->find();		$hot = db::table("issue")->where(["status" => 1, "sndtime#<" => time()])->field("id,name,coinname,buycoin,num,deal,price,ci,jian,strtime,sndtime")->order("deal desc")->limit(1)->find();		$this->assign("banner", $banner);		$this->assign("user_coin", $user_coin);		$this->assign("data", $coinlist);		$this->assign("end", $end);		$this->assign("new", $new);		$this->assign("hot", $hot);		$this->display();	}	public function buy()	{		$this->set_title('立即认购');		$token = token('home_issue_buy');		$id = iv('get.id', 'd', '参数错误');		$pages = md('issue')->page_buy($id);		if ($pages && isset($pages['list'])) {			foreach ($pages['list'] as $k => $v) {				$pages['list'][$k]['username'] = substr_replace(str_replace("|", " ", $v['username']), '**', 3, 2);			}		}		$issue = md('issue')->get_info($id);		$user_coin = md('user')->get_coin_info($this->userid);		$this->assign("issue", $issue);		$this->assign("token", $token);		$this->assign("pages", $pages);		$this->assign("user_coin", $user_coin);		$this->display();	}	public function up()	{		if (!session('home_issue_buy')) {			ajax('非法访问');		}		$token = iv("post.token", 'dw', '令牌错误');		if (!$token || $token != session('home_issue_buy')) {			ajax('恶意访问');		}		$id = iv('post.id', 'd', '参数错误');		$num = iv('post.num', 'd', '认购数量格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		$res = md('issue')->up($this->userid, $id, $num, $paypassword);		if (isset($res[1])) {			session('home_issue_buy', null);		}		show($res);	}	public function log()	{		$this->set_title('认购记录');		$pages = md('issue')->page_log(['userid' => $this->userid]);		$this->assign("pages", $pages);		$this->display();	}	public function jiedong()	{		$id = iv('post.id', 'd', '请选择解冻项');		show(md('issue')->jiedong($this->userid, $id));	}	public function invit()	{		$this->set_title('认购赠送');		$where = ["userid" => session("userid")];		$count = db::table("issue_invit")->where($where)->count();		$PageObj = new page($count, 12);		$show = $PageObj->show();		$list = db::table("issue_invit")->where($where)->order("`id` desc")->limit($PageObj->firstRow, $PageObj->listRows)->select();		foreach ($list as $k => $v) {			if ($v['invit'] != 0) {				$list[$k]['invitname'] = md('user')->find(['id' => $v['invit']], 'username');			} else {				$list[$k]['invitname'] = '系统';			}		}		$pages = ['show' => $show, 'list' => $list];		$this->assign('pages', $pages);		$this->display();	}}