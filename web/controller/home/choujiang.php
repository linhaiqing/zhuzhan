<?phpnamespace home;use Move\db;use Move\ext\page;class choujiang extends home{	public function __construct()	{		parent::__construct();		$this->is_game('choujiang');	}	public function check_table()	{		$cunzai = db::query("SHOW TABLES LIKE 'move_choujiang';");		if (isset($cunzai[0])) {			$choujiang = db::table('choujiang')->find();			if (!$choujiang) {				for ($i = 1; $i < 13; $i++) {					db::table('choujiang')->add(['id' => $i, 'title' => '请设置']);				}			}		}	}	public function index()	{		$this->set_title('幸运抽奖');		$this->check_table();		$coin_list = db::table("choujiang_coinlist")->where(["status" => 1])->select();		$choujiang = db::table("choujiang")->select();		if ($this->userid) {			$choujiang_num = db::table("choujiang_num")->where(["userid" => $this->userid])->find();		} else {			$choujiang_num = [];		}		$choujiang_log = db::table("choujiang_log")->where(["status#!=" => 0])->order("`id` desc")->limit(7)->select();		if ($choujiang_log) {			foreach ($choujiang_log as $k => $v) {				$users = db::table("user")->where(["id" => $v["userid"]])->find();				$choujiang_log[$k]["userid"] = substr_replace(str_replace("|", " ", $users['username']), '**', 3, 2);;			}		}		if ($this->userid) {			$where = ["userid" => $this->userid, "status#!=" => 0];			$count = db::table("choujiang_log")->where($where)->count();			$PageObj = new page($count, 15);			$show = $PageObj->show();			$list = db::table("choujiang_log")->where($where)->order("`id` desc")->limit($PageObj->firstRow, $PageObj->listRows)->select();		} else {			$show = [];			$list = [];		}		$pages = ['show' => $show, 'list' => $list];		$this->assign('pages', $pages);		$this->assign('coin_list', $coin_list);		$this->assign('choujiang', $choujiang);		$this->assign('choujiang_num', $choujiang_num);		$this->assign('choujiang_log', $choujiang_log);		$this->display();	}	public function buy()	{		$this->check_up('幸运抽奖购买奖券');		$coinid = iv('post.coinid', 'd', '币种格式错误');		$num = iv('post.num', 'd', '购买数量 格式错误');		$paypassword = iv('post.paypassword', 'password', '交易密码格式错误');		if (!$this->userid) {			ajax("请先登录");		}		$user = db::table("user")->where(["id" => $this->userid])->find();		if (empty($user['paypassword'])) {			ajax('交易密码非法');		}		if (hashs($paypassword) != $user['paypassword']) {			ajax('交易密码错误');		}		$res = md('choujiang')->buy($coinid, $num, $this->userid);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function up()	{		$this->check_up('幸运抽奖');		$res = md('choujiang')->up($this->userid);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1, $res[2]);		} else {			ajax($res[0]);		}	}}