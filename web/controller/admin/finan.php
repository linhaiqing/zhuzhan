<?phpnamespace admin;use Move\db;use Move\ext\client;use Move\ext\page;class finan extends admin{	public function __construct()	{		parent::__construct();	}	public function index()	{		$builder = new builder('finan');		$builder->title('财务明细', '<a href="http://www.movesay.com/article/detail/id/19.html" target="_blank"> 功能说明 http://www.movesay.com/article/detail/id/19.html</a>', '明细列表', '/finance/index')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '禁用', '2' => '启用'], 'select')->search('field', ['name' => '名称', 'title' => '标题',], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('userid', '用户名', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('addtime', '添加时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">禁用</span>', 1 => '<span style="color:#3498db;">启用</span>'])->key("ext", '操作', 'link', [['type' => 'button3', 'url' => '/finance/edit/id/###', 'title' => '编辑', 'field' => 'id', 'color' => '',],])->lists();	}	public function statistics()	{		$coin = iv('get.coin', 'w', '参数个数错误', 1);		if (!$coin) {			$mymc_coin = new \mymc\coin();			$coin_list = $mymc_coin->select();		}		$this->display();	}	public function wanneng()	{		if (empty($_POST)) {			$mymc_coin = new \mymc\coin();			$coin = $mymc_coin->select();			$coin_select = [];			if ($coin) {				foreach ($coin as $k => $v) {					$coin_select[$v['name']] = $v['title'];				}			}			$id = input('get.id');			$data['list'] = [];			$builder = new builder();			$builder->data($data)->url()->title(($id ? '编辑万能充值' : '万能充值'), '<a href="http://www.movesay.com/article/detail/id/19.html" target="_blank"> 功能说明 http://www.movesay.com/article/detail/id/19.html</a>', '财务中心', '/finan/wanneng')->key('coinname', '币种', 'select', $coin_select, '币种')->key('username', '用户名', 'text', '', '用户名')->key('num', '数量', 'text', '', '充值数量')->edit();		} else {			$data['coinname'] = iv('post.coinname', 'w', '币种格式错误');			$data['username'] = iv('post.username', 'username', '用户名格式错误');			$data['num'] = iv('post.num', 'xnb', '充值数量格式错误');			$res = md('finan')->wanneng($data['username'], $data['num'], $data['coinname']);			if (isset($res[1]) && $res[1]) {				ajax($res[0], 1);			} else {				ajax($res[0]);			}		}	}	public function kouqian()	{		if (empty($_POST)) {			$mymc_coin = new \mymc\coin();			$coin = $mymc_coin->select();			$coin_select = [];			if ($coin) {				foreach ($coin as $k => $v) {					$coin_select[$v['name']] = $v['title'];				}			}			$id = input('get.id');			$data['list'] = [];			$builder = new builder();			$builder->data($data)->url()->title(($id ? '编辑万能扣钱' : '万能扣钱'), '这里可以减少用户的财产', '万能扣钱', '/finan/kouqian')->key('coinname', '币种', 'select', $coin_select, '币种')->key('username', '用户名', 'text', '', '用户名')->key('num', '数量', 'text', '', '充值数量')->edit();		} else {			$data['coinname'] = iv('post.coinname', 'w', '币种格式错误');			$data['username'] = iv('post.username', 'username', '用户名格式错误');			$data['num'] = iv('post.num', 'xnb', '充值数量格式错误');			$res = md('finan')->kouqian($data['username'], $data['num'], $data['coinname']);			if (isset($res[1]) && $res[1]) {				ajax($res[0], 1);			} else {				ajax($res[0]);			}		}	}	public function config()	{		if (empty($_POST)) {			$data['list'] = md('sys_config')->lists();			$mymc_coin = new \mymc\coin();			$coin_list = $mymc_coin->select();			$coin_list_select = [];			if ($coin_list) {				foreach ($coin_list as $k => $v) {					$coin_list_select[$v['name']] = $v['title'];				}			}			$builder = new builder();			$builder->data($data)->url()->title('充值配置', '<a href="http://www.movesay.com/article/detail/id/19.html" target="_blank"> 功能说明 http://www.movesay.com/article/detail/id/19.html</a>')->key('pay_invit', '开启充值赠送', 'select', [0 => '禁止', 1 => '赠送'], '开启充值赠送')->key('pay_coin', '充值赠送币种', 'select', $coin_list_select, '充值赠送币种')->key('pay_invit_fee', '赠送比例', 'text', '', '% 赠送比例 (只计算整数部分 赠送给自己)')->key('pay_invit_1', '一代赠送比例', 'text', '', '% 一代赠送比例 (只计算整数部分)')->key('pay_invit_2', '二代赠送比例', 'text', '', '% 二代赠送比例 (只计算整数部分)')->key('pay_invit_3', '三代赠送比例', 'text', '', '% 三代赠送比例 (只计算整数部分)')->edit();		} else {			if (APP_DEMO) {				ajax('测试站暂时不能修改');			}			$data['pay_coin'] = iv('post.pay_coin', 'w', '充值赠送币种 格式错误', 1);			$data['pay_invit'] = iv('post.pay_invit', 'd', '开启充值赠送 格式错误', 1);			$data['pay_invit_fee'] = iv('post.pay_invit_fee', 'cny', '赠送数量 格式错误', 1);			$data['pay_invit_1'] = iv('post.pay_invit_1', 'cny', '一代赠送数量 格式错误', 1);			$data['pay_invit_2'] = iv('post.pay_invit_2', 'cny', '二代赠送数量 格式错误', 1);			$data['pay_invit_3'] = iv('post.pay_invit_3', 'cny', '三代赠送数量 格式错误', 1);			$res = 0;			foreach ($data as $k => $v) {				if (md('sys_config')->setValueOrName($k, $v)) {					$res = 1;				}			}			if ($res) {				mc("msphp_sys_config", null);				ajax('操作成功', 1);			} else {				ajax('操作失败');			}		}	}	public function paiming()	{		$page = iv('page', 'd', '参数错误', 1);		$coin = iv('get.coin', 'w', '币种格式错误', 1);		if (!$coin) {			$coin = md('sys_config')->get('mr_coin');		}		$this->assign('coin', $coin);		$mymc_coin = new \mymc\coin();		$coin_list = $mymc_coin->select();		$this->assign('coin_list', $coin_list);		$where = [];		if (!$page) {			$page = 1;		}		if ($page == 1) {			$page = 1;		}		$count = db::table("user_coin")->where($where)->count();		$PageObj = new page($count, 18);		$show = $PageObj->show();		$list = db::query('select id,' . $coin . ',' . $coin . 'd,userid,sum(' . $coin . '+' . $coin . 'd)as zong from move_user_coin  where id>0  group by id order by zong desc limit ' . $PageObj->firstRow . ',' . $PageObj->listRows . ';');		foreach ($list as $k => $v) {			$username = db::table("user")->where(["id" => $v["userid"]])->find();			$list[$k]["username"] = $username["username"];			$list[$k]["zong"] = $v['zong'];			$list[$k]["paiming"] = ($k + 1) + ($page - 1) * 18;		}		$pages = ['show' => $show, 'list' => $list];		$this->assign('pages', $pages);		$this->display();	}	public function pay()	{		$list = db::table('finan_type')->order('sort asc,id desc ')->select();		$list_select[0] = '全部方式';		if ($list) {			foreach ($list as $k => $v) {				$list_select[$v['name']] = $v['title'];			}		}		$mymc_coin = new \mymc\coin();		$coin = $mymc_coin->all_rmb();		$coin_select[0] = '全部币种';		if ($coin) {			foreach ($coin as $k => $v) {				$coin_select[$v['name']] = $v['title'];			}		}		$builder = new builder('finan_pay');		$builder->title('账户充值', '<a href="http://www.movesay.com/article/detail/id/19.html" target="_blank"> 功能说明 http://www.movesay.com/article/detail/id/19.html</a>', '账户充值列表', '/finan/pay')->button('del', '删除', '/finan/pay_status/type/-1')->button('ext', '导出选中', '/finan/pay_excel')->button('add', '导出所有', '/finan/pay_excel_all')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '未付款', '2' => '充值成功', '3' => '人工到账', '4' => '处理中', '5' => '订单已撤销'], 'select')->search('type', $list_select, 'select')->search('coinname', $coin_select, 'select')->search('field', ['userid_c_user_c_id_c_username' => '用户名', 'userid_c_user_c_id_c_moble' => '手机号', 'type' => '充值方式', 'tradeno' => '充值订单', 'num' => '充值金额',], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('userid', '用户名', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('coinname', '充值币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'coinname', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coinname', 'color' => '',]])->key('num', '充值金额', 'text')->key('fee', '赠送数量', 'text')->key('feecoin', '赠送币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'feecoin', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'feecoin', 'color' => '',]])->key('mum', '到账金额', 'text')->key('type', '充值方式', 'link', [['type' => 'button', 'url' => '/finan/type/field/name/name/###', 'title' => ['from_id' => 'type', 'table' => 'finan_type', 'to_id' => 'name', 'title' => 'title'], 'field' => 'type', 'color' => '',]])->key('tradeno', '充值订单', 'text')->key('addtime', '充值时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">未付款<pan>', 1 => '<span style="color:#3498db;">充值成功</span>', 2 => '<span style="color:#3498db;">人工到账</span>', 3 => '<span style="color:#3498db;">处理中</span>', 4 => '<span style="color:#ff3300;">订单已撤销</span>',])->key("ext", '操作', 'link', [['type' => 'button2', 'url' => '/finan/pay_queren/id/###', 'title' => '确认到账', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0, 3]],], ['type' => 'button2', 'url' => '/finan/pay_chexiao/id/###', 'title' => '取消订单', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],]])->lists();	}	public function pay_status()	{		$id = input('post.id');		$type = input('get.type');		$builder = new builder();		$builder->set_status($id, $type, 'finan_pay');	}	public function pay_queren()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id', 'd', '参数错误');		$res = md('finan')->pay_queren($id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function pay_chexiao()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id', 'd', '参数错误');		$finan_pay = db::table("finan_pay")->where(['id' => $id])->find();		if (empty($finan_pay)) {			ajax("订单不存在");		}		$res = db::table("finan_pay")->where(['id' => $id])->save(['status' => 4]);		if ($res) {			ajax('操作成功', 1);		} else {			ajax('操作失败');		}	}	public function type()	{		$mymc_coin = new \mymc\coin();		$coin = $mymc_coin->all_rmb();		$coin_select[0] = '全部币种';		if ($coin) {			foreach ($coin as $k => $v) {				$coin_select[$v['name']] = $v['title'];			}		}		$builder = new builder('finan_type');		$builder->title('充值方式', '这里是充值方式')->button('add', '添加', '/finan/type_edit')->button('no', '禁用', '/finan/type_status/type/0')->button('off', '启用', '/finan/type_status/type/1')->button('del', '删除', '/finan/type_status/type/-1')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '禁用', '2' => '启用'], 'select')->search('coinname', $coin_select, 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('coinname', '币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'coinname', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coinname', 'color' => '',]])->key('name', '接口名称', 'text')->key('title', '接口标题', 'text')->key('img', '接口图片', 'img')->key('username', '官方账号', 'text')->key('code', '二维码', 'img')->key('truename', '开户姓名', 'text')->key('value', '开户地址', 'text')->key('min', '最小充值', 'text')->key('max', '最大充值', 'text')->key('addtime', '添加时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">禁用</span>', 1 => '<span style="color:#3498db;">启用</span>'])->key("ext", '操作', 'link', [['type' => 'button3', 'url' => '/finan/type_edit/id/###', 'title' => '编辑', 'field' => 'id', 'color' => '',],])->lists();	}	public function type_status()	{		$id = input('post.id');		$type = input('get.type');		$builder = new builder();		$builder->set_status($id, $type, 'finan_type');	}	public function pay_excel()	{		if ($_POST) {			$id = $_POST['id'];		} else {			$id = $_GET['id'];		}		if (empty($id)) {			show_msg('请选择要操作的数据!');		}		$tables = 'move_finan_pay';		$xls_name = $tables;		$xls_zd = [];		$db_config = config("DB_CONF");		$zd = db::query("select COLUMN_NAME,COLUMN_COMMENT from information_schema.COLUMNS where TABLE_SCHEMA = '" . $db_config['db_name'] . "' and TABLE_NAME = '" . $tables . "';");		foreach ($zd as $k => $v) {			$xls_zd[$k] = $v['COLUMN_COMMENT'] ? $v['COLUMN_COMMENT'] : $v['COLUMN_NAME'];		}		$xls_rs = db::table('finan_pay')->where(['id#in' => $id])->select();		foreach ($xls_rs as $k => $v) {			$xls_rs[$k]['userid'] = db::table('user')->where(['id' => $v['userid']])->find('username');			$xls_rs[$k]['addtime'] = addtime($v['addtime']);			if ($xls_rs[$k]['status'] == 0) {				$xls_rs[$k]['status'] = '未付款';			} elseif ($xls_rs[$k]['status'] == 1) {				$xls_rs[$k]['status'] = '充值成功';			} elseif ($xls_rs[$k]['status'] == 2) {				$xls_rs[$k]['status'] = '人工到账';			} elseif ($xls_rs[$k]['status'] == 3) {				$xls_rs[$k]['status'] = '处理中';			} elseif ($xls_rs[$k]['status'] == 4) {				$xls_rs[$k]['status'] = '订单已撤销';			}		}		$excel = new \ext\excel();		$excel->export($xls_name, $xls_zd, $xls_rs);	}	public function pay_excel_all()	{		$tables = 'move_finan_pay';		$xls_name = $tables;		$xls_zd = [];		$db_config = config("DB_CONF");		$zd = db::query("select COLUMN_NAME,COLUMN_COMMENT from information_schema.COLUMNS where TABLE_SCHEMA = '" . $db_config['db_name'] . "' and TABLE_NAME = '" . $tables . "';");		foreach ($zd as $k => $v) {			$xls_zd[$k] = $v['COLUMN_COMMENT'] ? $v['COLUMN_COMMENT'] : $v['COLUMN_NAME'];		}		$xls_rs = db::table('finan_pay')->select();		foreach ($xls_rs as $k => $v) {			$xls_rs[$k]['userid'] = db::table('user')->where(['id' => $v['userid']])->find('username');			$xls_rs[$k]['addtime'] = addtime($v['addtime']);			if ($xls_rs[$k]['status'] == 0) {				$xls_rs[$k]['status'] = '未付款';			} elseif ($xls_rs[$k]['status'] == 1) {				$xls_rs[$k]['status'] = '充值成功';			} elseif ($xls_rs[$k]['status'] == 2) {				$xls_rs[$k]['status'] = '人工到账';			} elseif ($xls_rs[$k]['status'] == 3) {				$xls_rs[$k]['status'] = '处理中';			} elseif ($xls_rs[$k]['status'] == 4) {				$xls_rs[$k]['status'] = '订单已撤销';			}		}		$excel = new \ext\excel();		$excel->export($xls_name, $xls_zd, $xls_rs);	}	public function type_edit()	{		if (empty($_POST)) {			$mymc_coin = new \mymc\coin();			$coin = $mymc_coin->all_rmb();			$coin_select = [];			if ($coin) {				foreach ($coin as $k => $v) {					$coin_select[$v['name']] = $v['title'];				}			}			$id = input('get.id');			$builder = new builder("finan_type", ["id" => $id], "edit");			$builder->title(($id ? '编辑充值方式' : '添加充值方式'), '<a href="http://www.movesay.com/article/detail/id/19.html" target="_blank"> 功能说明 http://www.movesay.com/article/detail/id/19.html</a>', '充值方式', '/finan/type')->key('id', '编号', 'readonly', '', '数据编号')->key('id', '编号', 'hidden', '', '数据编号')->key('coinname', '币种', 'select', $coin_select, '币种')->key('name', '接口名称', 'text', '', '和订单记录关联不要随便修改')->key('title', '接口标题', 'text', '', '显示标题')->key('type', '接口类型', 'select', ['pay' => '普通转账', 'online' => '即时到账'], '1.普通转账:通过购买官方及时充值软件可实现即时到账 2.即时到账:联系官方配置对接')->key('remark', '接口简介', 'text', '', '')->key('shuoming', '接口说明', 'textarea', '', '')->key('img', '接口图片', 'image', '', '前台显示')->key('code', '二维码', 'image', '', '')->key('truename', '开户姓名', 'text', '', '')->key('username', '官方账号', 'text', '', '')->key('password', '接口密匙', 'password', '', '')->key('value', '开户地址', 'text', '', '')->key('min', '最小充值', 'text', '', '')->key('max', '最大充值', 'text', '', '')->key('addtime', '添加时间', 'time', '', '添加时间 (只能时间)')->key('status', '状态', 'select', [0 => '禁用', 1 => '启用'], '状态')->edit();		} else {			if (APP_DEMO) {				ajax('测试站暂时不能修改');			}			$data['coinname'] = iv('post.coinname');			$data['name'] = iv('post.name', 'a', '接口名称 格式错误');			$data['type'] = iv('post.type', 'a', '接口类型 格式错误');			$data['title'] = iv('post.title', 'a', '接口名称 格式错误');			$data['img'] = iv('post.img', 'a', '接口图片 格式错误', 1);			$data['code'] = iv('post.code', 'a', '二维码 格式错误', 1);			$data['remark'] = iv('post.remark');			$data['shuoming'] = iv('post.shuoming');			$data['truename'] = iv('post.truename', 'a', '开户姓名 格式错误', 1);			$data['username'] = iv('post.username', 'a', '开户账号 格式错误', 1);			$data['password'] = iv('post.password', 'a', '借口密匙 格式错误', 1);			$data['value'] = iv('post.value', 'a', '开户地址 格式错误', 1);			$data['min'] = iv('post.min', 'a', '最小充值 格式错误', 1);			$data['max'] = iv('post.max', 'a', '最大充值 格式错误', 1);			$data['addtime'] = iv('post.addtime', 'time', '添加时间格式错误');			$data['status'] = iv('post.status', 'd', '状态格式错误');			$id = iv('post.id');			if ($id) {				$res = db::table('finan_type')->where(['id' => $id])->save($data);			} else {				$res = db::table('finan_type')->add($data);			}			if ($res) {				ajax('操作成功', 1);			} else {				ajax('操作失败');			}		}	}	public function out()	{		$builder = new builder('finan_out');		$builder->title('提现记录', '这里是提现记录')->button('ext', '导出选中', '/finan/out_excel')->button('add', '导出所有', '/finan/out_excel_all')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '已申请', '2' => '提现成功', '3' => '已撤销', '4' => '正在处理'], 'select')->search('field', ['userid_c_user_c_id_c_username' => '用户名', 'userid_c_user_c_id_c_moble' => '手机号', 'bank' => '提现银行', 'num' => '提现金额',], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('userid', '用户名', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('num', '提现金额', 'text')->key('coinname', '币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'coinname', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coinname', 'color' => '',]])->key('fee', '提现手续费', 'text')->key('mum', '到账金额', 'text')->key('truename', '提现姓名', 'text')->key('bank', '提现银行', 'text')->key('bankprov', '提现银行省份', 'text')->key('bankcity', '提现银行城市', 'text')->key('bankaddr', '提现银行支行', 'text')->key('bankcard', '提现银行账号', 'text')->key('addtime', '提现时间', 'time')->key('endtime', '处理时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">已申请<pan>', 1 => '<span style="color:#3498db;">提现成功</span>', 2 => '<span style="color:#3498db;">已撤销</span>', 3 => '<span style="color:#3498db;">正在处理</span>',])->key("ext", '操作', 'link', [['type' => 'button2', 'url' => '/finan/out_huakuan/id/###', 'title' => '已划款', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0, 3]],], ['type' => 'button2', 'url' => '/finan/out_chuli/id/###', 'title' => '处理', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],], ['type' => 'button2', 'url' => '/finan/out_chexiao/id/###', 'title' => '撤销', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [3]],], ['type' => 'button2', 'url' => '/finan/out_chexiao/id/###', 'title' => '撤销', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],]])->lists();	}	public function out_chuli()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id');		if (empty($id)) {			ajax('请选择要操作的数据!');		}		if (db::table('finan_out')->where(['id' => $id])->find('status') == 2) {			ajax('该订单已撤销');		}		if (db::table('finan_out')->where(['id' => $id])->save(['status' => 3])) {			ajax('操作成功', 1);		} else {			ajax('操作失败');		}	}	public function out_chexiao()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id');		if (empty($id)) {			ajax('请选择要操作的数据!');		}		$finan_out = db::table("finan_out")->where(["id" => $id])->find();		$res = md('finan')->pay_chexiao($id, $finan_out["userid"]);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function out_huakuan()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$res = md('finan')->out_huakuan();		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function out_excel()	{		if ($_POST) {			$id = $_POST['id'];		} else {			$id = $_GET['id'];		}		if (empty($id)) {			show_msg('请选择要操作的数据!');		}		$tables = 'move_finan_out';		$xls_name = $tables;		$xls_zd = [];		$db_config = config("DB_CONF");		$zd = db::query("select COLUMN_NAME,COLUMN_COMMENT from information_schema.COLUMNS where TABLE_SCHEMA = '" . $db_config['db_name'] . "' and TABLE_NAME = '" . $tables . "';");		foreach ($zd as $k => $v) {			$xls_zd[$k] = $v['COLUMN_COMMENT'] ? $v['COLUMN_COMMENT'] : $v['COLUMN_NAME'];		}		$xls_rs = db::table('finan_out')->where(['id#in' => $id])->select();		foreach ($xls_rs as $k => $v) {			$xls_rs[$k]['userid'] = db::table('user')->where(['id' => $v['userid']])->find('username');			$xls_rs[$k]['addtime'] = addtime($v['addtime']);			if ($xls_rs[$k]['status'] == 0) {				$xls_rs[$k]['status'] = '未处理';			} elseif ($xls_rs[$k]['status'] == 1) {				$xls_rs[$k]['status'] = '已划款';			} elseif ($xls_rs[$k]['status'] == 2) {				$xls_rs[$k]['status'] = '已撤销';			} else {				$xls_rs[$k]['status'] = '错误';			}			$xls_rs[$k]['bankcard'] = ' ' . $v['bankcard'] . ' ';		}		$excel = new \ext\excel();		$excel->export($xls_name, $xls_zd, $xls_rs);	}	public function out_excel_all()	{		$tables = 'move_finan_out';		$xls_name = $tables;		$xls_zd = [];		$db_config = config("DB_CONF");		$zd = db::query("select COLUMN_NAME,COLUMN_COMMENT from information_schema.COLUMNS where TABLE_SCHEMA = '" . $db_config['db_name'] . "' and TABLE_NAME = '" . $tables . "';");		foreach ($zd as $k => $v) {			$xls_zd[$k] = $v['COLUMN_COMMENT'] ? $v['COLUMN_COMMENT'] : $v['COLUMN_NAME'];		}		$xls_rs = db::table('finan_out')->select();		foreach ($xls_rs as $k => $v) {			$xls_rs[$k]['userid'] = db::table('user')->where(['id' => $v['userid']])->find('username');			$xls_rs[$k]['addtime'] = addtime($v['addtime']);			if ($xls_rs[$k]['status'] == 0) {				$xls_rs[$k]['status'] = '未处理';			} elseif ($xls_rs[$k]['status'] == 1) {				$xls_rs[$k]['status'] = '已划款';			} elseif ($xls_rs[$k]['status'] == 2) {				$xls_rs[$k]['status'] = '已撤销';			} else {				$xls_rs[$k]['status'] = '错误';			}			$xls_rs[$k]['bankcard'] = ' ' . $v['bankcard'] . ' ';		}		$excel = new \ext\excel();		$excel->export($xls_name, $xls_zd, $xls_rs);	}	public function coinin_excel()	{		if ($_POST) {			$id = $_POST['id'];		} else {			$id = $_GET['id'];		}		if (empty($id)) {			show_msg('请选择要操作的数据!');		}		$tables = 'move_coin_in';		$xls_name = $tables;		$xls_zd = [];		$db_config = config("DB_CONF");		$zd = db::query("select COLUMN_NAME,COLUMN_COMMENT from information_schema.COLUMNS where TABLE_SCHEMA = '" . $db_config['db_name'] . "' and TABLE_NAME = '" . $tables . "';");		foreach ($zd as $k => $v) {			$xls_zd[$k] = $v['COLUMN_COMMENT'] ? $v['COLUMN_COMMENT'] : $v['COLUMN_NAME'];		}		$xls_rs = db::table('coin_in')->where(['id#in' => $id])->select();		foreach ($xls_rs as $k => $v) {			$xls_rs[$k]['userid'] = db::table('user')->where(['id' => $v['userid']])->find('username');			$xls_rs[$k]['addtime'] = addtime($v['addtime']);			if ($xls_rs[$k]['status'] == 0) {				$xls_rs[$k]['status'] = '等待处理';			} elseif ($xls_rs[$k]['status'] == 1) {				$xls_rs[$k]['status'] = '转入成功';			} elseif ($xls_rs[$k]['status'] == 2) {				$xls_rs[$k]['status'] = '已撤销';			} else {				$xls_rs[$k]['status'] = '错误';			}		}		$excel = new \ext\excel();		$excel->export($xls_name, $xls_zd, $xls_rs);	}	public function coinout_excel()	{		if ($_POST) {			$id = $_POST['id'];		} else {			$id = $_GET['id'];		}		if (empty($id)) {			show_msg('请选择要操作的数据!');		}		$tables = 'move_coin_out';		$xls_name = $tables;		$xls_zd = [];		$db_config = config("DB_CONF");		$zd = db::query("select COLUMN_NAME,COLUMN_COMMENT from information_schema.COLUMNS where TABLE_SCHEMA = '" . $db_config['db_name'] . "' and TABLE_NAME = '" . $tables . "';");		foreach ($zd as $k => $v) {			$xls_zd[$k] = $v['COLUMN_COMMENT'] ? $v['COLUMN_COMMENT'] : $v['COLUMN_NAME'];		}		$xls_rs = db::table('coin_out')->where(['id#in' => $id])->select();		foreach ($xls_rs as $k => $v) {			$xls_rs[$k]['userid'] = db::table('user')->where(['id' => $v['userid']])->find('username');			$xls_rs[$k]['addtime'] = addtime($v['addtime']);			if ($xls_rs[$k]['status'] == 0) {				$xls_rs[$k]['status'] = '等待处理';			} elseif ($xls_rs[$k]['status'] == 1) {				$xls_rs[$k]['status'] = '已审核';			} elseif ($xls_rs[$k]['status'] == 2) {				$xls_rs[$k]['status'] = '已撤销';			} else {				$xls_rs[$k]['status'] = '错误';			}		}		$excel = new \ext\excel();		$excel->export($xls_name, $xls_zd, $xls_rs);	}	public function out_status()	{		$id = input('post.id');		$type = input('get.type');		$builder = new builder();		$builder->set_status($id, $type, 'finan_out');	}	public function out_config()	{		if (empty($_POST)) {			$sys_config = db::table('sys_config')->select();			foreach ($sys_config as $k => $v) {				$data['list'] [$v['name']] = $v['value'];			}			$builder = new builder();			$builder->data($data)->url()->title('提现配置', '这里是提现配置')->key('out_fee', '提现手续费', 'text', '', '%提现手续费')->key('out_min', '提现最小金额', 'text', '', '最小提现金额')->key('out_max', '提现最大金额', 'text', '', '最大提现金额')->key('out_bei', '提现金额倍数', 'text', '', '提现整倍数')->key('out_shuoming', '提现说明', 'text', '', 'APP提现的说明文字')->key('out_bank', '提现银行', 'text', '', '提现银行 多个用"|"分割')->key('out_coin', '额外扣除币种', 'select', 'coin_c_name_c_title', '额外收取币种')->key('out_coin_fee', '额外币种比例', 'text', '', '支持2位小数 额外币种比例 比如设置10  那么提现100人民币就扣10个额外币种 设置0 或者不设置 不扣除')->edit();		} else {			if (APP_DEMO) {				ajax('测试站暂时不能修改');			}			$data['out_fee'] = iv('post.out_fee', 'a', '%提现手续费 格式错误');			$data['out_min'] = iv('post.out_min', 'a', '最小提现金额 格式错误');			$data['out_max'] = iv('post.out_max', 'a', '最大提现金额 格式错误');			$data['out_bei'] = iv('post.out_bei', 'a', '提现整倍数 格式错误');			$data['out_shuoming'] = iv('post.out_shuoming', 'a', '提现说明 格式错误');			$data['out_bank'] = iv('post.out_bank', 'a', '提现银行 格式错误');			$data['out_coin'] = iv('post.out_coin', 'w', '额外扣除币种 格式错误');			$data['out_coin_fee'] = iv('post.out_coin_fee', 'cny', '额外币种比例 格式错误 支持2位小数');			$res = 0;			foreach ($data as $k => $v) {				if (md('sys_config')->setValueOrName($k, $v)) {					$res = 1;				}			}			if ($res) {				mc("msphp_sys_config", null);				ajax('操作成功', 1);			} else {				ajax('操作失败');			}		}	}	public function coinin()	{		$mymc_coin = new \mymc\coin();		$list = $mymc_coin->select();		$list_select[0] = '全部币种';		if ($list) {			foreach ($list as $k => $v) {				$list_select[$v['name']] = $v['title'];			}		}		$builder = new builder('coin_in');		$builder->title('虚拟币转入', '这里是虚拟币转入')->button('del', '删除', '/finan/coinin_status/type/-1')->button('ext', '导出选中', '/finan/coinin_excel')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '等待处理', '2' => '转入成功'], 'select')->search('coinname', $list_select, 'select')->search('field', ['userid_c_user_c_id_c_username' => '用户名', 'zhuanchu' => '地址',], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('userid', '用户名', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('coinname', '币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'coinname', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coinname', 'color' => '',]])->key('type', '类型', 'text')->key('zhuanchu', '转出地址', 'text')->key('num', '转入数量', 'text')->key('mum', '实际到账', 'text')->key('queren', '确认次数', 'text')->key('addtime', '转入时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">等待处理</span>', 1 => '<span style="color:#3498db;">转入成功</span>', 2 => '<span style="color:#DA9151;">已经撤销</span>'])->key("ext", '操作', 'link', [['type' => 'button2', 'url' => '/finan/coinin_queren/id/###', 'title' => '确认到账', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],], ['type' => 'button2', 'url' => '/finan/coinin_chexiao/id/###', 'title' => '撤销', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],]])->lists();	}	public function coinin_status()	{		$id = input('post.id');		$type = input('get.type');		$builder = new builder();		$builder->set_status($id, $type, 'coin_in');	}	public function coinin_queren()	{		if (APP_DEMO) {		}		$id = iv('get.id', 'd', '参数错误');		$res = md('finan')->coinin_queren($id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function coinin_chexiao()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id', 'd', '参数错误');		$coin_in = db::table("coin_in")->where(["id" => $id])->find();		if ($coin_in["status"] != 0) {			ajax("已经处理禁止再次操作");		}		$user = db::table("user")->where(["id" => $coin_in["userid"]])->find();		if (!$user) {			ajax("用户错误");		}		$res = db::table("coin_in")->where(["id" => $coin_in["id"]])->save(["status" => 2, "endtime" => time()]);		if ($res) {			ajax("操作成功", 1);		} else {			ajax("操作失败");		}	}	public function coinin_loudan()	{		$coin = iv('get.coin', 'w', '参数错误', 1);		$mymc_coin = new \mymc\coin();		if (!$coin) {			$coin = $mymc_coin->all_qbb();		}		$coin_qbb_list = $mymc_coin->all_qbb();		$this->assign('coin_qbb_list', $coin_qbb_list);		$this->assign('coin', $coin);		$this->display();	}	public function coinin_loudan_cha()	{		$coin = iv('get.coin', 'w', '币种错误', 1);		if (!$coin) {			ajax("您还没有符合条件的钱包币");		}		$ci = iv('get.ci', 'd', '次数错误');		$num = iv('get.num', 'd', '条数错误');		$limit = iv('get.limit', 'd', '每次错误');		if ($ci * $limit >= $num) {			ajax('查询完成', 1);		}		$mymc_coin = new \mymc\coin();		$coin_info = $mymc_coin->find($coin);		if (!$coin_info) {			ajax('币种不存在');		}		$client = new client($coin_info["dj_yh"], $coin_info["dj_mm"], $coin_info["dj_zj"], $coin_info["dj_dk"], 10, [], 1);		if (!$client) {			ajax('链接钱包失败');		}		$getinfo = $client->execute("getinfo");		if (!$getinfo) {			ajax('获取钱包信息失败');		}		if (!isset($getinfo["version"]) || !$getinfo["version"]) {			ajax('获取钱包版本失败');		}		$listtransactions = $client->execute("listtransactions", ["*", (int)$limit, (int)($ci * $limit)]);		if (!$listtransactions) {			ajax(('记录获取失败或全部完成'));		} else {			krsort($listtransactions);		}		$data = [];		$k = 0;		foreach ($listtransactions as $v) {			if ($v["category"] == "receive") {				$data [$k]['id'] = $ci * $limit + $k + 1;				$data [$k]['username'] = $v['account'];				$data [$k]['num'] = $v['amount'];				$data [$k]['zhuanchu'] = $v['address'];				$data [$k]['addtime'] = addtime($v['time']);				$data [$k]['txid'] = $v['txid'];				if (db::table("coin_in")->where(["coinname" => $coin, "txid" => $v["txid"]])->find()) {					$data [$k]['daozhang'] = 1;				} else {					$data [$k]['daozhang'] = 0;				}			}			$k++;		}		ajax($data, 1);	}	public function coinin_loudan_daohzhang()	{		$username = iv('get.address', '', '参数错误');		$coinname = iv('get.coin', '', '参数错误');		$txid = iv('get.txid', '', '参数错误');		$num = iv('get.num', '', '参数错误');		$res = md('finan')->coinin_loudan_daohzhang($username, $coinname, $txid, $num);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function coinin_qianbao()	{		$mymc_coin = new \mymc\coin();		$list = $mymc_coin->select();		$list_select[0] = '全部币种';		if ($list) {			foreach ($list as $k => $v) {				if ($v['wallet'] == 'newcoin') {					$list_select[$v['name']] = $v['title'];				}			}		}		$builder = new builder('user_qianbao', ['type' => 1]);		$builder->title('转入地址管理', '这里是虚拟币转入地址管理')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '待审核', '2' => '绑定成功'], 'select')->search('coinname', $list_select, 'select')->search('field', ['userid_c_user_c_id_c_username' => '用户名', 'addr' => '地址',], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('userid', '用户名', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('coinname', '币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'coinname', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coinname', 'color' => '',]])->key('addr', '绑定地址', 'text')->key('addtime', '转入时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">等待审核</span>', 1 => '<span style="color:#3498db;">绑定成功</span>'])->key("ext", '操作', 'link', [['type' => 'button2', 'url' => '/finan/del_qianbao/id/###', 'title' => '虚假信息', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],], ['type' => 'button2', 'url' => '/finan/pass_qianbao/id/###', 'title' => '审核通过', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],]])->lists();	}	public function del_qianbao()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id');		if (empty($id)) {			ajax('请选择要操作的数据!');		}		if (db::table('user_qianbao')->where(['id' => $id])->delete()) {			ajax('操作成功', 1);		} else {			ajax('操作失败');		}	}	public function pass_qianbao()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id');		if (empty($id)) {			ajax('请选择要操作的数据!');		}		if (db::table('user_qianbao')->where(['id' => $id])->save(['status' => 1])) {			ajax('操作成功', 1);		} else {			ajax('操作失败');		}	}	public function coinout()	{		$builder = new builder('coin_out');		$builder->title('虚拟币转出', '这里是虚拟币转出')->button('ext', '导出选中', '/finan/coinout_excel')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '等等处理', '2' => '转出成功', '3' => '已经审核', '4' => '已经撤销'], 'select')->search('field', ['userid_c_user_c_id_c_username' => '用户名', 'username' => '接收地址'], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('userid', '用户名', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('coinname', '币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'coinname', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coinname', 'color' => '',]])->key('type', '类型', 'text')->key('username', '接收地址', 'text')->key('txid', 'txid', 'text')->key('num', '转出数量', 'text')->key('fee', '转出手续费', 'text')->key('addtime', '申请时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">等待处理</span>', 1 => '<span style="color:#3498db;">转出成功</span>', 2 => '<span style="color:#3498db;">已经审核</span>', 3 => '<span style="color:#3498db;">已经撤销</span>'])->key("ext", '操作', 'link', [['type' => 'button2', 'url' => '/finan/coinout_rengong/id/###', 'title' => '已经人工转账', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [2]],], ['type' => 'button2', 'url' => '/finan/coinout_queren/id/###', 'title' => '审核通过', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],], ['type' => 'button2', 'url' => '/finan/coinout_chexiao/id/###', 'title' => '撤销', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [0]],], ['type' => 'button2', 'url' => '/finan/coinout_bufa/id/###', 'title' => '发送失败重新补发 谨慎操作', 'field' => 'id', 'color' => '', 'ajax' => '', 'exts' => ["status" => [1]],]])->lists();	}	public function coinout_queren()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id');		if (empty($id)) {			ajax('请选择要操作的数据!');		}		if (db::table('coin_out')->where(['id' => $id])->save(['status' => 2])) {			ajax('操作成功', 1);		} else {			ajax('操作失败');		}	}	public function coinout_bufa()	{		if (empty($_POST)) {			$id = input('get.id');			$builder = new builder("coin_out", ["id" => $id], "edit");			$builder->title(($id ? '重新补发' : '添加重新补发'), ($id ? '这里是重新补发' : '这里是添加重新补发'), '虚拟币转出', '/finan/coinout')->key('id', '编号', 'readonly', '', '数据编号')->key('id', '编号', 'hidden', '', '数据编号')->key('userid', '用户ID', 'text', '', '')->key('coinname', '币种', 'text', '', '')->key('username', '地址', 'text', '', '')->key('type', '类型', 'text', '', '')->key('status', '状态', 'select', [1 => '转出成功', 2 => '重新补发'], '如果钱包服务器发送失败 请修改为重新补发')->edit();		} else {			$data['status'] = iv('post.status', 'd', '状态格式错误');			$id = iv('post.id');			if ($id) {				$res = db::table('coin_out')->where(['id' => $id])->save($data);			} else {				ajax('数据异常');			}			if ($res) {				ajax('操作成功', 1);			} else {				ajax('操作失败');			}		}	}	public function coinout_rengong()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id');		if (empty($id)) {			ajax('请选择要操作的数据!');		}		if (db::table('coin_out')->where(['id' => $id])->save(['status' => 1])) {			ajax('操作成功', 1);		} else {			ajax('操作失败');		}	}	public function coinout_chexiao()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = iv('get.id', 'd', '参数错误');		$res = md('finan')->coinout_chexiao($id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function invit()	{		$builder = new builder('user_invit');		$builder->title('推荐赠送', '这里是推荐赠送记录')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '已申请', '2' => '提现成功', '3' => '已撤销', '4' => '正在处理'], 'select')->search('field', ['userid_c_user_c_id_c_username' => '用户名',], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('invit', '用户名', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'invit', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'invit', 'color' => '',]])->key('userid', '推荐人', 'link', [['type' => 'button', 'url' => '/user/index/field/id/name/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('type', '奖励类型', 'text')->key('name', '奖励说明', 'text')->key('num', '操作数量', 'text')->key('fee', '到账数量', 'text')->key('feecoin', '币种', 'link', [['type' => 'button', 'url' => '/coin/index/field/name/name/###', 'title' => ['from_id' => 'feecoin', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'feecoin', 'color' => '',]])->key('addtime', '操作时间', 'time')->lists();	}	public function stats()	{		$mymc_coin = new \mymc\coin();		$coin_list = $mymc_coin->select();		$coin = iv('get.coin');		if (!$coin) {			if ($coin_list) {				$coin = $coin_list['cny']['name'];			}		}		$this->assign('coin', $coin);		$coin_list_data = [];		if ($coin_list) {			foreach ($coin_list as $k => $v) {				$coin_list_data[$v['name']] = $v;			}		}		$coin_list = $coin_list_data;		$this->assign('coin_list', $coin_list);		if ($coin) {			$zheng = db::table('user_coin')->sum($coin);			$dong = db::table('user_coin')->sum($coin . 'd');		} else {			$zheng = 0;			$dong = 0;		}		if (!$zheng) {			$zheng = 0;		}		if (!$dong) {			$dong = 0;		}		$zong = $zheng + $dong;		$this->assign('zheng', $zheng);		$this->assign('dong', $dong);		$this->assign('zong', $zong);		$data = [];		$res = db::table('sys_stats')->where(['name' => 'user_coin', 'type' => $coin])->order('id desc')->limit(200)->select();		krsort($res);		$res = array_values($res);		foreach ($res as $k => $v) {			$tmp = json_decode($v['data']);			$data[] = ['date' => addtime($v['addtime']), 'zheng' => $tmp[0], 'dong' => $tmp[1], 'zong' => $tmp[2]];		}		$this->assign('datas', json_encode($data));		$this->display();	}	public function stats_up()	{		$finan_kaiqi = iv('post.finan_kaiqi', 'd', '开启参数错误');		$finan_zhang = iv('post.finan_zhang', 'd', '上涨格式错误');		$finan_die = iv('post.finan_die', 'd', '下跌格式错误');		$coin = iv('post.coin', 'w', '币种错误');		$mymc_coin = new \mymc\coin();		$res = $mymc_coin->find($coin);		if ($res) {			if (db::table('coin')->where(['name' => $coin])->save(['finan_kaiqi' => $finan_kaiqi, 'finan_zhang' => $finan_zhang, 'finan_die' => $finan_die])) {				ajax('保持成功', 1);			} else {				ajax('保持失败');			}		} else {			ajax('币种错误');		}	}}