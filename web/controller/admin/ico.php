<?phpnamespace admin;use Move\db;class ico extends admin{	public function __construct()	{		parent::__construct();		if (!$this->is_game('ico')) {			ajax('这个应用你没有购买');		}	}	public function index()	{		$builder = new builder("ico");		$builder->title('ICO众筹', '这里是ICO众筹', 'ICO众筹列表', '/ico/index')->button('add', '添加', '/ico/edit')->button('no', '禁用', '/ico/status/type/0')->button('off', '启用', '/ico/status/type/1')->button('del', '删除', '/ico/status/type/-1')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '禁用', '2' => '进行中', 3 => "已完成", "4" => "已回报", 5 => "已撤销"], 'select')->search('field', ['title' => '众筹名称', 'coin' => '众筹币种', "coin_back" => "回报币种"], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('img', '众筹图片', 'img')->key('title', '众筹名称', 'text')->key('coin', '众筹币种', 'link', [['type' => 'button', 'url' => '/coin/edit/id/###', 'title' => ['from_id' => 'coin', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coin', 'color' => '',]])->key('coin_back', '回报币种', 'link', [['type' => 'button', 'url' => '/coin/edit/id/###', 'title' => ['from_id' => 'coin_back', 'table' => 'coin', 'to_id' => 'name', 'title' => 'title'], 'field' => 'coin_back', 'color' => '',]])->key('mum', '众筹数量', 'text')->key('gete', '获得数', 'text')->key('addtime', '添加时间', 'time')->key('strtime', '开始时间', 'time')->key('endtime', '结束时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">禁用</span>', 1 => '<span style="color:#3498db;">进行中</span>', 2 => '<span style="color:#3498db;">已结束</span>', 3 => "已回报", "4" => "已撤销"])->key("ext1", '比例管理', 'link', [['type' => 'button3', 'url' => '/ico/bili/field/pid/name/###', 'title' => '管理比例', 'field' => 'id', 'color' => '',],])->key("ext", '操作', 'link', [['type' => 'button3', 'url' => '/ico/edit/id/###', 'title' => '编辑', 'field' => 'id', 'color' => '',], ['type' => 'button2', 'url' => '/ico/send/id/###', 'title' => '发放回报', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [2]],], ['type' => 'button2', 'url' => '/ico/chexiao/id/###', 'title' => '项目撤销', 'field' => 'id', 'color' => '', 'ajax' => 'get', 'exts' => ["status" => [2]],],])->lists();	}	public function edit()	{		$mymc_coin = new \mymc\coin();		$coin = $mymc_coin->select();		if (empty($_POST)) {			$id = input('get.id');			$data_list = [];			$cz_data = [];			if ($id) {				$data['list'] = db::table('ico')->where(['id' => $id])->find();				if ($data['list']) {					$cz_data = explode(',', $data['list'] ['coin_data']);;				}			} else {				$data = null;			}			if ($coin) {				foreach ($coin as $kk => $vv) {					$data_list[$vv['id']]['title'] = $vv['title'];					if (in_array($vv['id'], $cz_data)) {						$data_list[$vv['id']]['status'] = 1;					} else {						$data_list[$vv['id']]['status'] = 0;					}				}			}			$builder = new builder("ico", ["id" => $id], "edit");			$builder->title(($id ? '编辑ICO众筹' : '添加ICO众筹'), ($id ? '这里是编辑ICO众筹' : '这里是添加ICO众筹'), 'ICO众筹', '/ico/index');			if ($id) {				$builder->key('id', '编号', 'readonly', '', '数据编号');				$builder->key('id', '编号', 'hidden', '', '数据编号');			}			$builder->key('title', '众筹标题', 'text', '', '众筹标题')->key('f_title', '众筹副标题', 'text', '', '众筹副标题')->key('img', '图片', 'image', '', '图片')->key('coin', '众筹币种', 'select', 'coin_c_name_c_title', '众筹币种 ')->key('coin_back', '回报币种', 'select', 'coin_c_name_c_title', '回报币种 ,奖励给用户的币种')->key('mum', '众筹数量', 'text', '', '众筹数量(整数)')->key('coin_data', '可参与币种', 'checkbox', $data_list, '可参与币种 ')->key('content', '众筹介绍', 'editor', '', '内容 (全部)')->key('addtime', '添加时间', 'time', '', '添加时间 (只能时间)')->key('strtime', '开始时间', 'time', '', '开始时间 (只能时间)')->key('endtime', '结束时间', 'time', '', '结束时间 (只能时间)')->key('status', '状态', 'select', [0 => '禁用', 1 => '进行中', 2 => '已结束'], '')->edit();		} else {			if (APP_DEMO) {				ajax('测试站暂时不能修改');			}			$data['coin_data'] = '';			if ($coin) {				foreach ($coin as $kk => $vv) {					if (isset($_POST['coin_data_' . $vv['id']])) {						$data['coin_data'] .= $vv['id'] . ',';					}				}			}			$data['title'] = iv('post.title', 'a', '众筹标题 格式错误', 1);			$data['f_title'] = iv('post.f_title');			$data['coin'] = iv('post.coin', 'w', '众筹币种 格式错误');			$data['coin_back'] = iv('post.coin_back', 'w', '回报币种 格式错误');			$data['mum'] = iv('post.mum', "d", "众筹数量格式错误");			$data['img'] = iv('post.img', "image", "图片格式错误");			$data['content'] = iv('post.content');			$data['addtime'] = iv('post.addtime', 'time', '添加时间 格式错误', 1);			$data['strtime'] = iv('post.strtime', 'time', '开始时间 格式错误', 1);			$data['endtime'] = iv('post.endtime', 'time', '结束时间 格式错误', 1);			$data['status'] = iv('post.status', "d", "状态格式错误");;			$id = iv('post.id');			if ($id) {				$res = db::table('ico')->where(['id' => $id])->save($data);			} else {				$res = db::table('ico')->add($data);			}			if ($res) {				ajax('操作成功', 1);			} else {				ajax('操作失败');			}		}	}	public function status()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = input('post.id');		$type = input('get.type');		$builder = new builder();		show($builder->set_status($id, $type, 'ico'));	}	public function bili()	{		$id = iv('get.name', 'd', '格式错误', 1);		$builder = new builder("ico_bili");		$builder->title('回报比例', '这里是回报比例', '比例列表', '/ico/bili')->button('add', '添加', '/ico/bili_edit/pid/' . $id)->button('no', '禁用', '/ico/bili_status/type/0')->button('off', '启用', '/ico/bili_status/type/1')->button('del', '删除', '/ico/bili_status/type/-1')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '禁用', '2' => '启用'], 'select')->search('field', ['pid' => '众筹编号', "coin" => "众筹币种"], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('pid', '众筹标题', 'link', [['type' => 'button', 'url' => '/ico/index/field/id/name/###', 'title' => ['from_id' => 'pid', 'table' => 'ico', 'to_id' => 'id', 'title' => 'title'], 'field' => 'pid', 'color' => '',]])->key('bili', '比例', 'text')->key('strtime', '区间开始时间', 'time')->key('endtime', '区间结束时间', 'time')->key('sort', '排序', 'text')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">禁用</span>', 1 => '<span style="color:#3498db;">启用</span>'])->key("ext", '操作', 'link', [['type' => 'button3', 'url' => '/ico/bili_edit/id/###', 'title' => '编辑', 'field' => 'id', 'color' => '',],])->lists();	}	public function bili_edit()	{		if (empty($_POST)) {			$id = input('get.id');			$builder = new builder("ico_bili", ["id" => $id], "edit");			if (!$id) {				$pid = iv('get.pid', 'd', '项目id 格式错误', 1);				if ($pid) {					$data['list']['pid'] = $pid;				} else {					$data['list']['pid'] = '';				}				$builder->data($data);			}			$builder->title(($id ? '编辑类型' : '添加类型'), ($id ? '这里是编辑类型' : '这里是添加类型'), '类型管理', '/ico/bili');			if ($id) {				$builder->key('id', '编号', 'readonly', '', '数据编号');				$builder->key('id', '编号', 'hidden', '', '数据编号');			}			$builder->key('pid', '项目ID', 'readonly', "", '项目id')->key('pid', '项目ID', 'hidden', "", '项目id')->key('bili', '比例', 'text', '', '比例  (1众筹币 获得 bili个回报币)')->key('strtime', '开始时间', 'time', '', '开始时间  (该区间开始时间)')->key('endtime', '结束时间', 'time', '', '结束时间  (该区间结束时间)')->key('addtime', '添加时间', 'time', '', '添加时间  (时间格式)')->key('sort', '排序', 'text', '', '排序  (整数格式)')->key('status', '状态', 'select', [0 => '禁用', 1 => '启用'], '')->edit();		} else {			if (APP_DEMO) {				ajax('测试站暂时不能修改');			}			$data['pid'] = iv('post.pid', 'd', '标题 格式错误', 1);			$data['bili'] = iv('post.bili', 'xnb', '比例 格式错误', 1);			$data['sort'] = iv('post.sort', 'd', '排序格式错误', 1);			$data['addtime'] = iv('post.addtime', 'time', '添加时间格式错误');			$data['strtime'] = iv('post.strtime', 'time', '开始时间格式错误');			$data['endtime'] = iv('post.endtime', 'time', '结束时间格式错误');;			$data['status'] = iv('post.status', 'd', '状态格式错误', 1);			$id = iv('post.id');			if ($data['endtime'] <= $data['strtime']) {				ajax("上限必须大于下限");			}			$bili_a = db::table("ico_bili")->where(["pid" => $data['pid'], "strtime#<=" => $data['strtime'], "endtime#>=" => $data['strtime']])->find();			if ($bili_a && $bili_a["id"] != $id) {				ajax("与前一区间重合");			}			$bili_b = db::table("ico_bili")->where(["pid" => $data['pid'], "strtime#<" => $data['endtime'], "endtime#>" => $data['endtime']])->find();			if ($bili_b && $bili_b["id"] != $id) {				ajax("与后一区间重合");			}			$bili_c = db::table("ico_bili")->where(["pid" => $data['pid'], "strtime#>" => $data['strtime'], "endtime#>" => $data['endtime']])->find();			if ($bili_c && $bili_c["id"] != $id) {				ajax("包含前面的区间");			}			if ($id) {				$res = db::table('ico_bili')->where(['id' => $id])->save($data);			} else {				$res = db::table('ico_bili')->add($data);			}			if ($res) {				ajax('操作成功', 1);			} else {				ajax('操作失败');			}		}	}	public function bili_status()	{		if (APP_DEMO) {			ajax('测试站暂时不能修改');		}		$id = input('post.id');		$type = input('get.type');		$builder = new builder();		show($builder->set_status($id, $type, 'ico_bili'));	}	public function log()	{		$builder = new builder("ico_log");		$builder->title('众筹记录', '这里是分红记录', '众筹记录', '/ico/log')->search('addtime_str', '开始时间', 'time')->search('addtime_end', '结束时间', 'time')->search('order', ['id_desc' => 'ID降序', 'id_asc' => 'ID升序', 'sort_desc' => '索引降序', 'sort_asc' => '索引升序', 'addtime_desc' => '时间降序', 'addtime_asc' => '时间升序',], 'select')->search('status', ['0' => '全部状态', '1' => '未到账', '2' => '已到账', "3" => "已撤销"], 'select')->search('field', ["ico_id_c_ico_c_id_c_title" => "众筹标题", 'userid_c_user_c_id_c_username' => '用户名', 'coin' => '众筹币种',], 'select')->search('name', '请输入查询内容', 'text')->key('id', 'ID', 'text')->key('userid', '用户名', 'link', [['type' => 'button', 'url' => '/user/edit/id/###', 'title' => ['from_id' => 'userid', 'table' => 'user', 'to_id' => 'id', 'title' => 'username'], 'field' => 'userid', 'color' => '',]])->key('ico_id', '众筹名称', 'link', [['type' => 'button', 'url' => '/ico/index/field/id/name/###', 'title' => ['from_id' => 'ico_id', 'table' => 'ico', 'to_id' => 'id', 'title' => 'title'], 'field' => 'ico_id', 'color' => '',]])->key('num', '本次众筹数量', 'text')->key('paycoin', '支付币种', 'text')->key('paynum', '支付数量', 'text')->key('paycoin', '参与币种', 'text')->key('bili', '回报比', 'text')->key('backcoin', '回报币种', 'text')->key('addtime', '众筹时间', 'time')->key('status', '状态', 'select', [0 => '<span style="color:#DA9151;">未发放</span>', 1 => '<span style="color:#3498db;">已到账</span>', 2 => '<span style="color:#3498db;">已取消</span>'])->lists();	}	public function send()	{		$id = iv("id", "d", "参数错误");		$res = md('ico')->send($id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}	public function chexiao()	{		$id = iv("id", "d", "参数错误");		$res = md('ico')->chexiao($id);		if (isset($res[1]) && $res[1]) {			ajax($res[0], 1);		} else {			ajax($res[0]);		}	}}