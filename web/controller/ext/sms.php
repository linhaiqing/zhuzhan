<?phpnamespace ext;use Move\db;class sms{	public $servicer = "";	public $username = "";	public $password = "";	public $type = "";	public $guojia = "";	public $config = [];	public function __construct($servicer = null)	{		$this->servicer = $servicer;	}	public function send($moble = null, $code = null, $type = "sms", $moban = "reg")	{		if (!$moble) {			return ["接收短信手机号错误"];		}		if (!$code || !check($code, "d")) {			return ["短信验证码错误"];		}		if ($this->servicer) {			$this->config = db::table("sys_sms")->where(["name" => $this->servicer])->find();		} else {			$this->config = db::table("sys_sms")->where(["status" => 1])->find();		}		if (!$this->config) {			return ["短信服务商配置错误"];		}		if (!isset($this->config["username"]) || !$this->config["username"]) {			return ["短信接口账户配置错误"];		}		if (!isset($this->config["password"]) || !$this->config["password"]) {			return ["短信接口密匙配置错误"];		}		if ($type == "sms" && !$this->config["sms"]) {			return ["短信服务商暂时没有开通文本短信"];		}		if ($type == "tel" && !$this->config["tel"]) {			return ["短信服务商暂时没有开通语音短信"];		}		if (stripos($moble, "|") == false) {			$moble_arr[1] = $moble;		} else {			$moble_arr = explode("|", $moble);			if ($moble_arr[0] != "+86" && $this->config["guoji"] != 1) {				return ["国际短信暂时没有开通"];			}		}		if (!isset($this->config[$moban]) || !$this->config[$moban]) {			$content = "你的短信验证码为:" . $code;		} else {			$content = str_replace("{code}", $code, $this->config[$moban]);		}		if ($this->config["name"] == "smschinese") {			$res = $this->smschinese($this->config["username"], $this->config["password"], $moble_arr[1], $content);		}		if ($this->config["name"] == "smsbao") {			$res = $this->smsbao($this->config["username"], md5($this->config["password"]), $moble_arr[1], $content);		}		if ($this->config["name"] == "yunsms") {			$res = $this->yunsms($this->config["username"], $this->config["password"], $moble_arr[1], $content);		}		if ($this->config["name"] == "meilian") {			$res = $this->meilian($this->config["username"], md5($this->config["password"]), $moble_arr[1], $content);		}		if ($this->config["name"] == "ihuyi") {			if ($moble_arr[0] == "+86") {				if ($type == "sms") {					$res = $this->ihuyi($this->config["username"], $this->config["password"], $moble_arr[1], $content, $type);				} else {					$res = $this->ihuyi($this->config["username"], $this->config["password"], $moble_arr[1], $code, $type);				}			} else {				$res = $this->ihuyi($this->config["g_username"], $this->config["g_password"], $moble, $code, $type);			}		}		if (isset($res[1])) {			return ["短信验证码已发送到你的手机，请查收", 1];		} else {			return [$res[0]];		}	}	public function smschinese($username, $password, $moble, $content)	{		$url = 'http://utf8.sms.webchinese.cn/?Uid=' . $username . '&Key=' . $password . '&smsMob=' . $moble . '&smsText=' . $content;		$ch = curl_init();		$timeout = 5;		curl_setopt($ch, CURLOPT_URL, $url);		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);		$file_contents = curl_exec($ch);		curl_close($ch);		if ($file_contents > 0) {			return [$file_contents, 1];		} else {			return [$file_contents];		}	}	public function smsbao($username, $password, $moble, $content)	{		$url = 'http://api.smsbao.com/sms?u=' . $username . '&p=' . $password . '&m=' . $moble . '&c=' . $content;		if (function_exists('file_get_contents')) {			$file_contents = file_get_contents($url);		} else {			$ch = curl_init();			$timeout = 5;			curl_setopt($ch, CURLOPT_URL, $url);			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);			curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);			$file_contents = curl_exec($ch);			curl_close($ch);		}		if ($file_contents > 0) {			return [$file_contents];		} else {			return [$file_contents, 1];		}	}	public function yunsms($uid, $pwd, $mobile, $content, $time = '', $mid = '')	{		$http = 'http://http.yunsms.cn/tx/';		$fileType = mb_detect_encoding($content, ['UTF-8', 'GBK', 'LATIN1', 'BIG5']);		if ($fileType != 'gbk') {			$content = mb_convert_encoding($content, 'gbk', $fileType);		}		$data = ['uid' => $uid, 'pwd' => strtolower(md5($pwd)), 'mobile' => $mobile, 'content' => $content, 'time' => $time, 'mid' => $mid];		$re = $this->postSMS($http, $data);		if (trim($re) == '100') {			return ["发送成功!", 1];		} else {			return ["发送失败! 状态：" . $re];		}	}	public function postSMS($url, $data = '')	{		$post = '';		$row = parse_url($url);		$host = $row['host'];		$port = isset($row['port']) ? $row['port'] : 80;		$file = $row['path'];		while (list($k, $v) = each($data)) {			$post .= rawurlencode($k) . "=" . rawurlencode($v) . "&";		}		$post = substr($post, 0, -1);		$len = strlen($post);		$fp = @fsockopen($host, $port, $errno, $errstr, 10);		if (!$fp) {			return "$errstr ($errno)\n";		} else {			$receive = '';			$out = "POST $file HTTP/1.0\r\n";			$out .= "Host: $host\r\n";			$out .= "Content-type: application/x-www-form-urlencoded\r\n";			$out .= "Connection: Close\r\n";			$out .= "Content-Length: $len\r\n\r\n";			$out .= $post;			fwrite($fp, $out);			while (!feof($fp)) {				$receive .= fgets($fp, 128);			}			fclose($fp);			$receive = explode("\r\n\r\n", $receive);			unset($receive[0]);			return implode("", $receive);		}	}	public function ihuyi($username, $password, $moble, $content, $type)	{		$moble_arr = explode("|", $moble);		if (isset($moble_arr[1]) && $moble_arr[0] != "+86") {			$curlPost = "account=" . $username . "&password=" . $password . "&mobile=" . ltrim($moble_arr[0], "+") . " " . $moble_arr[1] . "&content=Your verification code is " . $content . "&format=json";			$url = "http://api.isms.ihuyi.com/webservice/isms.php?method=Submit";			$curl = curl_init();			curl_setopt($curl, CURLOPT_URL, $url);			curl_setopt($curl, CURLOPT_HEADER, false);			curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);			curl_setopt($curl, CURLOPT_NOBODY, true);			curl_setopt($curl, CURLOPT_POST, true);			curl_setopt($curl, CURLOPT_POSTFIELDS, $curlPost);			$return_str = curl_exec($curl);			curl_close($curl);			$data = json_decode($return_str, true);			if (!$data) {				return ['没有返回数据'];			}			if ($data["code"] == 2) {				return [$data["msg"], 1];			} else {				return [$data["msg"]];			}		} else {			if ($type == "sms") {				$url = "http://106.ihuyi.com/webservice/sms.php?method=Submit&account=" . $username . "&password=" . $password . "&mobile=" . $moble . "&content=" . $content . "&format=json";			} else {				$url = "http://api.voice.ihuyi.com/webservice/voice.php?method=Submit&account=" . $username . "&password=" . $password . "&mobile=" . $moble . "&content=" . $content . "&format=json";			}		}		if (function_exists('file_get_contents')) {			$file_contents = file_get_contents($url);		} else {			$ch = curl_init();			curl_setopt($ch, CURLOPT_URL, $url);			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);			curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);			$file_contents = curl_exec($ch);			curl_close($ch);		}		$data = json_decode($file_contents, true);		if (!$data) {			return ['没有返回数据'];		}		if ($data["code"] == 2) {			return [$data["msg"], 1];		} else {			return [$data["msg"]];		}	}	public function meilian($username, $password, $moble, $content)	{		$content = urlencode($content);		$apikey = @file_get_contents(APP_PATH . '/backup/sms_meilian.ini');		$url = "http://m.5c.com.cn/api/send/index.php?";		$send_data = ['username' => $username, 'password_md5' => $password, 'apikey' => $apikey, 'mobile' => $moble, 'content' => $content, 'encode' => 'utf-8',];		$ch = curl_init();		curl_setopt($ch, CURLOPT_URL, $url);		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);		curl_setopt($ch, CURLOPT_TIMEOUT, 30);		curl_setopt($ch, CURLOPT_HEADER, 1);		curl_setopt($ch, CURLOPT_POST, 1);		curl_setopt($ch, CURLOPT_POSTFIELDS, $send_data);		$data = curl_exec($ch);		curl_close($ch);		$res = explode("\r\n\r\n", $data);		$result = $res[2];		if (strpos($result, "success") > -1) {			return [$result, 1];		} else {			return [$result];		}	}}