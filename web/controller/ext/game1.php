<?phpnamespace ext;use Move\db;class game{	public function visit($name = null)	{		if ($name) {			$res = db::table('version_game')->where(["name" => $name])->find();			if ($res) {				if ($res['status'] != 1 || $res['anzhuang'] != 1) {					redirect('/');				}			}		}	}	public function check()	{		$url = "http://auth.movesay.com/movesay/get_game_list/mscode/" . MS_CODE;		$content = json_decode(@file_get_contents($url), true);		if ($content && $content['ext']) {			foreach ($content['ext'] as $k => $v) {				$v["img"] = '/game/' . $v["name"] . '.jpg';				$rs = db::table("version_game")->where(["name" => $v["name"]])->find();				if ($rs) {					db::table("version_game")->where(["name" => $v["name"]])->save(["title" => $v["title"], "img" => $v["img"], "url" => $v["url"], "price" => $v["price"], "class" => $v["class"], "shuoming" => $v["shuoming"], "gongsi" => $v["gongsi"], "sort" => $v["sort"], 'endtime' => time()]);				} else {					db::table("version_game")->add(["name" => $v["name"], "title" => $v["title"], "img" => $v["img"], "url" => $v["url"], "class" => $v["class"], "price" => $v["price"], "shuoming" => $v["shuoming"], "gongsi" => $v["gongsi"], "status" => $v["status"], "sort" => $v["sort"], 'addtime' => time()]);				}			}		}		$url = "http://auth.movesay.com/movesay/get_game/mscode/" . MS_CODE;		$content = json_decode(@file_get_contents($url), true);		$game_arr = explode('|', $content['ext']);		if ($game_arr && isset($game_arr[0])) {			db::table("version_game")->where(["id#>=" => 1])->save(['anzhuang' => 0]);			foreach ($game_arr as $k => $v) {				db::table("version_game")->where(["name" => $v])->save(['anzhuang' => 1]);			}		}		file_put_contents(APP_PATH . "/runtime/debug/check_game.json", 1);		if (MS_CODE == "95D3A7E98EE9F913B462B87C73DS") {		} else {			$this->del_game();		}	}	public function del_table()	{	}	public function del_game()	{		$mm = mm();		if ($mm) {			if (isset($mm['game'])) {				$game_list = db::table('version_game')->select();				if ($game_list) {					foreach ($game_list as $k => $v) {						if (!in_array($v['name'], explode("|", $mm['game']))) {							@unlink(APP_PATH . '/controller/admin/' . $v['name'] . '.php');							@unlink(APP_PATH . '/controller/home/' . $v['name'] . '.php');							@unlink(APP_PATH . '/model/' . $v['name'] . '.php');							$this->deleteAll(APP_PATH . "/template/default/home/" . $v['name']);							$this->deleteAll(APP_PATH . "/template/default/admin/" . $v['name']);							if ($v['name'] == "movesay") {								db::query("DROP TABLE `move_ms_anli`;");								db::query("DROP TABLE `move_ms_banben`;");								db::query("DROP TABLE `move_ms_game`;");								db::query("DROP TABLE `move_ms_ip`;");								db::query("DROP TABLE `move_ms_list`;");							}						}					}				}				if (!in_array('wap', explode("|", $mm['game']))) {					$this->deleteAll(APP_PATH . "/controller/wap");					$this->deleteAll(APP_PATH . "/template/default/wap");					$this->deleteAll(APP_PATH . "/static/default/wap");				}				if (!in_array('app', explode("|", $mm['game'])) && !in_array('wap', explode("|", $mm['game']))) {					$this->deleteAll(APP_PATH . "/controller/app");					$this->deleteAll(APP_PATH . "/template/default/app");				}				if (!in_array('weixin', explode("|", $mm['game']))) {					$this->deleteAll(APP_PATH . "/controller/weixin");					$this->deleteAll(APP_PATH . "/template/default/weixin");				}				if (!in_array('api', explode("|", $mm['game']))) {					$this->deleteAll(APP_PATH . "/controller/api");					$this->deleteAll(APP_PATH . "/template/default/api");				}			}		}	}	public function deleteAll($path)	{		$op = @dir($path);		if ($op) {			while (false != ($item = $op->read())) {				if ($item == '.' || $item == '..') {					continue;				}				if (is_dir($op->path . '/' . $item)) {					$this->deleteAll($op->path . '/' . $item);					@rmdir($op->path . '/' . $item);				} else {					@unlink($op->path . '/' . $item);				}			}			@rmdir($path);		}	}}