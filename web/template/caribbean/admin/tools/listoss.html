{include file="public:header"}
<head>
	<meta charset="utf-8">
	<style>
		h1{
			border-bottom:1px solid #C0C0C0;
			margin-bottom:10px;
			padding-bottom:10px;
			white-space:nowrap;
		}

		table{
			border-collapse:collapse;
		}

		th{
			cursor:pointer;
		}

		td.detailsColumn{
			-webkit-padding-start:2em;
			text-align:end;
			white-space:nowrap;
		}

		a.icon{
			-webkit-padding-start:1.5em;
			text-decoration:none;
		}

		a.icon:hover{
			text-decoration:underline;
		}

		a.file{
			background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAABnRSTlMAAAAAAABupgeRAAABHUlEQVR42o2RMW7DIBiF3498iHRJD5JKHurL+CRVBp+i2T16tTynF2gO0KSb5ZrBBl4HHDBuK/WXACH4eO9/CAAAbdvijzLGNE1TVZXfZuHg6XCAQESAZXbOKaXO57eiKG6ft9PrKQIkCQqFoIiQFBGlFIB5nvM8t9aOX2Nd18oDzjnPgCDpn/BH4zh2XZdlWVmWiUK4IgCBoFMUz9eP6zRN75cLgEQhcmTQIbl72O0f9865qLAAsURAAgKBJKEtgLXWvyjLuFsThCSstb8rBCaAQhDYWgIZ7myM+TUBjDHrHlZcbMYYk34cN0YSLcgS+wL0fe9TXDMbY33fR2AYBvyQ8L0Gk8MwREBrTfKe4TpTzwhArXWi8HI84h/1DfwI5mhxJamFAAAAAElFTkSuQmCC ") left top no-repeat;
		}

		a.dir{
			background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAd5JREFUeNqMU79rFUEQ/vbuodFEEkzAImBpkUabFP4ldpaJhZXYm/RiZWsv/hkWFglBUyTIgyAIIfgIRjHv3r39MePM7N3LcbxAFvZ2b2bn22/mm3XMjF+HL3YW7q28YSIw8mBKoBihhhgCsoORot9d3/ywg3YowMXwNde/PzGnk2vn6PitrT+/PGeNaecg4+qNY3D43vy16A5wDDd4Aqg/ngmrjl/GoN0U5V1QquHQG3q+TPDVhVwyBffcmQGJmSVfyZk7R3SngI4JKfwDJ2+05zIg8gbiereTZRHhJ5KCMOwDFLjhoBTn2g0ghagfKeIYJDPFyibJVBtTREwq60SpYvh5++PpwatHsxSm9QRLSQpEVSd7/TYJUb49TX7gztpjjEffnoVw66+Ytovs14Yp7HaKmUXeX9rKUoMoLNW3srqI5fWn8JejrVkK0QcrkFLOgS39yoKUQe292WJ1guUHG8K2o8K00oO1BTvXoW4yasclUTgZYJY9aFNfAThX5CZRmczAV52oAPoupHhWRIUUAOoyUIlYVaAa/VbLbyiZUiyFbjQFNwiZQSGl4IDy9sO5Wrty0QLKhdZPxmgGcDo8ejn+c/6eiK9poz15Kw7Dr/vN/z6W7q++091/AQYA5mZ8GYJ9K0AAAAAASUVORK5CYII= ") left top no-repeat;
		}

		a.up{
			background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAmlJREFUeNpsU0toU0EUPfPysx/tTxuDH9SCWhUDooIbd7oRUUTMouqi2iIoCO6lceHWhegy4EJFinWjrlQUpVm0IIoFpVDEIthm0dpikpf3ZuZ6Z94nrXhhMjM3c8895977BBHB2PznK8WPtDgyWH5q77cPH8PpdXuhpQT4ifR9u5sfJb1bmw6VivahATDrxcRZ2njfoaMv+2j7mLDn93MPiNRMvGbL18L9IpF8h9/TN+EYkMffSiOXJ5+hkD+PdqcLpICWHOHc2CC+LEyA/K+cKQMnlQHJX8wqYG3MAJy88Wa4OLDvEqAEOpJd0LxHIMdHBziowSwVlF8D6QaicK01krw/JynwcKoEwZczewroTvZirlKJs5CqQ5CG8pb57FnJUA0LYCXMX5fibd+p8LWDDemcPZbzQyjvH+Ki1TlIciElA7ghwLKV4kRZstt2sANWRjYTAGzuP2hXZFpJ/GsxgGJ0ox1aoFWsDXyyxqCs26+ydmagFN/rRjymJ1898bzGzmQE0HCZpmk5A0RFIv8Pn0WYPsiu6t/Rsj6PauVTwffTSzGAGZhUG2F06hEc9ibS7OPMNp6ErYFlKavo7MkhmTqCxZ/jwzGA9Hx82H2BZSw1NTN9Gx8ycHkajU/7M+jInsDC7DiaEmo1bNl1AMr9ASFgqVu9MCTIzoGUimXVAnnaN0PdBBDCCYbEtMk6wkpQwIG0sn0PQIUF4GsTwLSIFKNqF6DVrQq+IWVrQDxAYQC/1SsYOI4pOxKZrfifiUSbDUisif7XlpGIPufXd/uvdvZm760M0no1FZcnrzUdjw7au3vu/BVgAFLXeuTxhTXVAAAAAElFTkSuQmCC ") left top no-repeat;
		}

		html[dir=rtl] a{
			background-position-x:right;
		}

		#listingParsingErrorBox{
			border:1px solid black;
			background:#FAE691;
			padding:10px;
			display:none;
		}
	</style>
	<title id="title"><?php echo $prefix ? $prefix : "HOME";?> 的索引</title>
</head>
<script>
	function addRow(name, url, isdir,
	                size, size_string, date_modified, date_modified_string) {
		if (name == ".")
			return;

		var root = document.location.pathname;
		if (root.substr(-1) !== "/")
			root += "/";

		var tbody     = document.getElementById("tbody");
		var row       = document.createElement("tr");
		var file_cell = document.createElement("td");
		var link      = document.createElement("a");

		link.className = isdir ? "icon dir" : "icon file";

		if (name == "..") {
			link.href            = root + "..";
			link.innerText       = document.getElementById("parentDirText").innerText;
			link.className       = "icon up";
			size                 = 0;
			size_string          = "";
			date_modified        = 0;
			date_modified_string = "";
		} else {
			if (isdir) {
				name        = name + "/";
				url         = url + "/";
				size        = 0;
				size_string = "";
			} else {
				link.draggable = "true";
				link.addEventListener("dragstart", onDragStart, false);
			}
			link.innerText = name;
			link.href      = root + url;
		}
		file_cell.dataset.value = name;
		file_cell.appendChild(link);

		row.appendChild(file_cell);
		row.appendChild(createCell(size, size_string));
		row.appendChild(createCell(date_modified, date_modified_string));

		tbody.appendChild(row);
	}

	function onDragStart(e) {
		var el                = e.srcElement;
		var name              = el.innerText.replace(":", "");
		var download_url_data = "application/octet-stream:" + name + ":" + el.href;
		e.dataTransfer.setData("DownloadURL", download_url_data);
		e.dataTransfer.effectAllowed = "copy";
	}

	function createCell(value, text) {
		var cell = document.createElement("td");
		cell.setAttribute("class", "detailsColumn");
		cell.dataset.value = value;
		cell.innerText     = text;
		return cell;
	}

	function start(location) {
		var list_header       = document.getElementById("list_header");
		list_header.innerText = list_header.innerText.replace("LOCATION", location);

		document.getElementById("title").innerText = list_header.innerText;
	}

	function onListingParsingError() {
		var box           = document.getElementById("listingParsingErrorBox");
		box.innerHTML     = box.innerHTML.replace("LOCATION", encodeURI(document.location)
				+ "?raw");
		box.style.display = "block";
	}

	function sortTable(column) {
		var tlist_header                         = document.getElementById("tlist_header");
		var oldOrder                        = tlist_header.cells[column].dataset.order || '1';
		oldOrder                            = parseInt(oldOrder, 10)
		var newOrder                        = 0 - oldOrder;
		tlist_header.cells[column].dataset.order = newOrder;

		var tbody = document.getElementById("tbody");
		var rows  = tbody.rows;
		var list  = [], i;
		for (i = 0; i < rows.length; i++) {
			list.push(rows[i]);
		}

		list.sort(function (row1, row2) {
			var a = row1.cells[column].dataset.value;
			var b = row2.cells[column].dataset.value;
			if (column) {
				a = parseInt(a, 10);
				b = parseInt(b, 10);
				return a > b ? newOrder : a < b ? oldOrder : 0;
			}

			// Column 0 is text.
			// Also the parent directory should always be sorted at one of the ends.
			if (b == ".." | a > b) {
				return newOrder;
			} else if (a == ".." | a < b) {
				return oldOrder;
			} else {
				return 0;
			}
		});

		// Appending an existing child again just moves it.
		for (i = 0; i < list.length; i++) {
			tbody.appendChild(list[i]);
		}
	}
</script>
<div id="main-content">
	<div id="top-alert" class="fixed alert alert-error" style="display: none;">
		<button class="close fixed" style="margin-top: 4px;">&times;</button>
		<div class="alert-content">警告内容</div>
	</div>
	<div id="main" class="main">
		<div class="main-title-h">
			<span class="h1-title">阿里云OSS文件管理</span>
		</div>
		<block name="body">
			<div class="container-span">
				<div class="span4" style="margin: 0 0px;width: 100%;">
					<div class="columns-mod">
						<div class="hd cf">
							<h5>
								{if $listdata['prefix']} {$listdata['prefix']} 的索引 {else} HOME {/if}
							</h5>

							<div>
								<span style="height:45px;float:right;line-height:45px;color: #1abc9c;cursor: pointer;" onclick="adddir()">新建文件夹</span>


								<span>
									<img class="oss_add_img" onclick="getElementById('web_logo_inputfile').click()"
									     style="cursor:pointer;max-width:400px;margin: 5px 10px 0 0;float: right;" title="点击添加图片" alt="点击添加图片"
									     src="/static//default/admin/img/addimg.png">
									<input type="hidden" id="pathType" name="pathType" value="{$listdata['prefix']}">
									<input type="file" id="web_logo_inputfile" style="height:0;width:0;z-index: -1; position: absolute;left: 10px;top: 5px;" value=""/>
								</span>
							</div>

							<script type="text/javascript">

								$(document).ready(function () {
									$("#web_logo_inputfile").change(function () {
										var data = new FormData();
										data.append('pathType', "{$listdata['prefix']}");
										console.log(data);
										$.each($('#web_logo_inputfile')[0].files, function (i, file) {
											data.append('upload_file' + i, file);
										});

										layer.confirm('是否需要加密hash文件名？', {
											btn: ['是的','不需要'] //按钮
										}, function(){
											layer.closeAll();
											layer.load(1, {
												shade: [0.1,'#fff'] //0.1透明度的白色背景
											});
											data.append('hashname', 1);
											upload_file(data);
										}, function(){
											layer.closeAll();
											layer.load(1, {
												shade: [0.1,'#fff'] //0.1透明度的白色背景
											});
											data.append('hashname', 0);
											upload_file(data);
										});
									});
								});

								function upload_file(data){
									$.ajax({
										url: '/admin/tools/listoss?act=add&action=uploadimage',
										type: 'POST',
										data: data,
										dataType: "json",
										cache: false,
										contentType: false,		//不可缺参数
										processData: false,		//不可缺参数
										success: function (data) {
											if (data.state == "SUCCESS") {
												layer.closeAll();
												layer.msg('上传成功刷新中');
												window.setTimeout("window.location.reload();",1000);
											} else {
												layer.msg(data.state);
											}
										},
										error: function () {
											alert('上传出错');
											$(".loading").hide();
										}
									});
								}

								function adddir(){
									layer.prompt({title: '输入新建文件夹名称', formType: 3}, function(str,index){
										layer.close(index);
										var pre = "{$listdata['prefix']}";
										$.post('/admin/tools/listoss?act=add&action=catchimage',
												{
													pathType:pre + str,
													"source[]":"http://www.movesay.com/static/img/logo.png",
													hashname:false
												},
												function(data){
													if (data.state == "SUCCESS") {
														layer.closeAll();
														layer.msg('上传成功刷新中');
														window.setTimeout("window.location.reload();",1000);
													} else {
														layer.msg(data.state);
													}
										},"json");
									});

								}

							</script>


						</div>
						<div class="bd">
							<div class="sys-info">
								{if $online}
									<table>
									<thead>
									<tr class="list_header" id="tlist_header">
										<th onclick="javascript:sortTable(0);" style="min-width: 100px;">
											名称
										</th>
										<th onclick="javascript:sortTable(1);" style="min-width: 100px;">
											信息
										</th>
										<th onclick="javascript:sortTable(2);" style="min-width: 100px;">
											大小
										</th>
										<th onclick="javascript:sortTable(3);" style="min-width: 100px;">
											修改日期
										</th>
										<th style="min-width: 100px;">
											操 作
										</th>
									</tr>
									</thead>
									<tbody id="tbody">
									{if $listdata['prefix']}
										<tr>
											<td data-value="..">
												<a class="icon up" href="?prefix=<?php echo $up_prefix;?>">[上级目录]</a>
											</td>
											<td data-value="0">
											</td>
											<td data-value="0"></td>
											<td data-value="0"></td>
											<td data-value="0"></td>
										</tr>
									{/if}

									{if $listdata['prefixList']}
										{foreach $listdata['prefixList'] as $val}
										<tr>
											<td data-value="">
												<a class="icon dir" href="?prefix={$val}"><?php echo trim(str_replace($prefix,"",$val),"/"); ?></a>
											</td>
											<td data-value="0">
											</td>
											<td data-value="0">
											</td>
											<td data-value="0">
											</td>
											<td data-value="0">
											</td>
										</tr>
										{/foreach}
									{/if}

									{if $listdata['objectList']} {foreach $listdata['objectList'] as $val}
									<tr>
										<td data-value="{$val['key']}">
											<a class="icon file" draggable="true" target="_blank" href="{$img_host}{$val['key']}"> {$val['name']} </a>
										</td>
										<td data-value="<?php echo $img_host  . $val['key'];?>">
											<?php
												//判断是图片
												$ext = strtolower(strrchr($val['key'], '.'));
												if(in_array($ext,[".png", ".jpg", ".jpeg", ".gif", ".bmp"])){
													echo '<img width="100" height="50" src="'.$img_host  . $val['key'].'">'; }else{ echo $ext."文件"; } ?>
										</td>
										<td data-value="<?php echo $val['size']; ?>">
											<?php echo $val['size']; ?> K
										</td>
										<td data-value="<?php echo strtotime($val['lastModified']); ?>">
											<?php echo date("Y-m-d H:i:s",strtotime($val['lastModified'])); ?>
										</td>
										<td   >
											<a draggable="true" href="/admin/tools/listoss?act=del&object={$val['key']}"> 删除 </a>
										</td>
									</tr>
									{/foreach} {/if}
									</tbody>
								</table>
								{else}
									OSS 模式未开启
								{/if}
							</div>
						</div>
					</div>
				</div>
			</div>
		</block>
	</div>
</div>
{include file="public:footer"}