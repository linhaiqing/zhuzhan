{include file="public:header"}
<link type="text/css" rel="stylesheet" href="__WAP__/css/shop/public.css">
<link type="text/css" rel="stylesheet" href="__WAP__/css/shop/goods.css">
<link type="text/css" rel="stylesheet" href="__WAP__/css/aui/aui.2.0.css">
<link type="text/css" rel="stylesheet" href="__WAP__/css/aui/aui-slide.css">
<link type="text/css" rel="stylesheet" href="__WAP__/css/fontawesome/font-awesome.min.css">
	<style>
        .h-mid ul li{ width:20%; float:left; height:45px; text-align:center; }
        .orderItem li{
            font-size: 0.65rem;
            margin: 0.3125rem 0.625rem;
        }
        .orderItem ul{
            clear: both;
        }
        .orderTotalMsg span {

            margin: 0.325rem 0.325rem;
        }

        .orderOptionBtns span {
            margin: 0.325rem 0.325rem;
            border: #999 1px solid;
            padding: 0.125rem 0.325rem;
            border-radius: 0.125rem;
        }

        .iconfont{
            padding: 0.25rem 0.45rem;
            border-radius: 0.2rem;
            color: white;
            font-size: 0.8rem !important;
        }
        .icon-map-marker{
            background-color: #49afcd;
        }

        .hideDiv {
            display: none;
        }

	</style>
</head>
<body>
<div class="aui-content aui-margin-b-15">
    <ul class="aui-list aui-list-in">
        <li class="aui-list-header">收货地址</li>
        <li class="aui-list-item"  tapmod onclick="selectAddress()">
            <div class="aui-list-item-label-icon">
                <i class="iconfont icon-map-marker"></i>
            </div>
            <div class="aui-list-item-inner aui-list-item-arrow">
                <div class="aui-list-item-label">收货地址:</div>
<!--                <div class="aui-list-item-text" id="shouhuoAddress">武汉市武昌区友谊大道999</div>-->
                <div class="aui-list-item-text">
                    <select id="selectAddress" onchange="selectAddress()">
                        <option index="0" >请选择收货地址</option>
                    </select>
                </div>
            </div>
        </li>

    </ul>
    <ul class="aui-list aui-list-in">
        <li class="aui-list-header">确认订单信息</li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">商品名称:</div>
                <div class="aui-list-item-text" id = "goodsName"></div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">数量:</div>
                <div class="aui-list-item-text" id="buyNumber"></div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">单价:</div>
                <div class="aui-list-item-text" id="singlePrice"></div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">库存:</div>
                <div class="aui-list-item-text" id="wareroomLeft"></div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">支付币种:</div>
                <div class="aui-list-item-text" id="payCoinType"></div>
            </div>
        </li>
    </ul>
    <ul class="aui-list aui-list-in">
        <li class="aui-list-header">合计</li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    留言:
                </div>
                <div class="aui-list-item-input">
                    <input id="liuyan" type="text" placeholder="给卖家的留言,最多80字">
                </div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">合计:</div>
                <div class="aui-list-item-text" id="totalMoney1"></div>
            </div>
        </li>
        <li id="latestPriceContainar" class="aui-list-item hideDiv">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">最新行情: </div>
                <div class="aui-list-item-text" id="latestPrice"></div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">实付:</div>
                <div class="aui-list-item-text" id="totalMoney2"></div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">收货人:</div>
                <div class="aui-list-item-text" id="masterName"></div>
            </div>
        </li>
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">寄送至:</div>
                <div class="aui-list-item-text" id="fetchAddress"></div>
            </div>
        </li>
	    <li class="aui-list-item">
		    <div class="aui-list-item-inner">
			    <div class="aui-list-item-label">交易密码:</div>
			    <div class="aui-list-item-input">
				    <input id="paypassword" type="password" placeholder="">
			    </div>
		    </div>
	    </li>
    </ul>
    <div class="aui-content-padded">
    <p><div class="aui-btn aui-btn-info" onclick="buyNow()" style="width: 100%;line-height: 1.5rem">立即购买</div></p>
    </div>
</div>
</body>
<script type="text/javascript" src="__WAP__/js/ext/doT.min.js"></script>
<script type="text/javascript" src="__WAP__/js/ext/echo.js"></script>
<script type="text/javascript" src="__WAP__/js/aui/aui-slide.js"></script>
<script type="text/javascript" src="__WAP__/js/aui/aui-pull-refresh.js"></script>
<script type="text/javascript">
	apiready = function () {
		alog("come");
		onerror = error_handel;
		flash(function () {
		});
	};

	var shop_info;
	var addrIndex;
    var addrId;
	function addCard(){
		var shop_card = memObj("shop_card");
		if(shop_card){
			shop_card = merge(shop_card,[shop_info['id']]);
		}else{
			shop_card = [shop_info['id']];
		}
		memObj("shop_card",shop_card);
		memObj("shop_id_"+shop_info['id'],shop_info);
		art("成功加入购物车");
	}

	function shopBuy(){
		art("前往购买开发中...");
	}

	function flash(callback) {
		var id = iv("id");

		if(!id){
			art("商品ID未获取");
			return;
		}

		var param={
			id:iv('id'),
				num:iv('num'),
			coinpay:mem('coinpay'),
		}

		if(!chkLogin()){
			var req = Ajax
		}else {
			var req = UserAjax;
		}

		req('shop/order', 'post', param, function (ret) {
			if (ret.status == 1) {
				alog(ret);
				shop_info = ret.info;

                //收货地址
//                $('#shouhuoAddress').html(shop_info.user_goods.addr);
                if(shop_info.user_goods && shop_info.user_goods.length > 0 ) {
                    var opt = '';
                    if ( shop_info.user_goods.length > 0 ) {
                        addrIndex = 0;
                        addrId = shop_info.user_goods[0].id;
                        for( var index = 0; index < shop_info.user_goods.length; index++ ) {
                            opt += "<option index=\'"+index+"\' value=\'"+shop_info.user_goods[index].id+"\'>"
                                    +shop_info.user_goods[index].truename+"|"+
                                    +shop_info.user_goods[index].moble+"|";
                            var tail = shop_info.user_goods[index].addr+
                                    "</option>";
                            opt += tail;
                        }
	                    opt += "<option index='tianjia' value='+'>管理收货地址</option>"
                    }
                    $('#selectAddress').html(opt);
                }
                //商品名称
                $('#goodsName').html(shop_info.shop.title);
                $('#buyNumber').html(shop_info.num);
                $('#singlePrice').html(shop_info.shop.price);
                $('#wareroomLeft').html(shop_info.shop.num);
                $('#payCoinType').html(shop_info.shop.coin_title);
                var totalMoney1 = parseFloat(shop_info.shop.price)*parseFloat(shop_info.num);
                $('#totalMoney1').html( totalMoney1 + "元");
                if ( shop_info.bili) {
                    $('#latestPrice').html("1"+shop_info.shop.coin_title+ " = "+ shop_info.bili + "人民币" );
                    $('#latestPriceContainar').removeClass('hideDiv');
                }
                $('#totalMoney2').html(shop_info.shiji+shop_info.shop.coin_title);
                $('#masterName').html(shop_info.user_goods.truename);
                setFetchAddress();

				parseTapmode();
			} else {
				art(ret.info);
			}
		});
	}

    function selectAddress () {

        var selectOption = $('#selectAddress option').filter(function (){ return this.selected});
        if(selectOption.val() == '+'){
	     open_win('goods_addr_h','setting')
	        $('#selectAddress option').filter(function (){ return this.value ==addrId}).prop('selected','selected')
             return
        }
	    addrIndex = selectOption.attr("index");
        addrId = selectOption.val();
        setFetchAddress();
    }

    function setFetchAddress(){

        alog("addrIndex===="+addrIndex);

        var addr = shop_info.user_goods[addrIndex];
        $('#masterName').html(addr.truename);
        $('#fetchAddress').html(
                addr.prov+" "
                +addr.city+" "
                +addr.addr
        );
    }

    function buyNow() {
	    if(!chkLogin()){
		    art('请登录')
		    return false
	    }
        var num = iv('num');
        var shop_id = iv('id')
        var coinpay = shop_info.buycoin;
        var user_goods_id = addrId;
        var liuyan = $('#liuyan').val();
	    var  paypassword = $("#paypassword").val()

        if (  isNull( num ) || isNull( shop_id ) )
        {
            art('购买信息不存在');
            return;
        }
        if ( isNull( coinpay ) ){
            art('支付币种错误');
            return;
        }
        if( isNull( user_goods_id )){
            art('收货地址错误');
            return;
        }
	    if(!paypassword){
		    art('请输入交易密码')
		    return
	    }

        var params = {
            'num':num,
            'shop_id':shop_id,
            'coinpay':coinpay,
            'user_goods_id':user_goods_id,
            'liuyan':liuyan,
	        'paypassword':paypassword
        };


        loading('提交中...')
        UserAjax('shop/order_up', 'post', params, function (ret) {
            toast.hide();
            if ( ret.status == 1 ){
                art(ret.info);
	            $("#paypassword").val(null)
                setTimeout(function(){
	                open_win('shopping_log_h','shop')
                },2000);
            }
            else {
                art(ret.info);
            }
        });
    }

</script>
</html>