{include file="public:header"}
<link type="text/css" rel="stylesheet" href="__WAP__/css/shop/public.css">
<link type="text/css" rel="stylesheet" href="__WAP__/css/shop/category_list.css">
<link type="text/css" rel="stylesheet" href="__WAP__/css/aui/aui.2.0.css">
<link type="text/css" rel="stylesheet" href="__WAP__/css/aui/aui-pull-refresh.css">
<style>
        .touchweb-com_searchListBox.openList .item .price_box {
            height: 25px;;
        }

        .filtrate_term li {
            color: #777f86;
            font-size: 14px;
            cursor: pointer;
        }

        .filter {
            position: relative;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            height: 2.066667rem;
            line-height: 2.04rem;
            z-index: 100;
        }

        .filter li {
            padding-left: 0.75rem;
        }

        .filter-header {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            z-index: 3;
            background-color: #fff;
        }

        .filter-nav {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            display: block;
            width: 0;
            text-align: center;
            color: #666;
            position: relative;
            font-size: .75rem;
        }

        .filter-nav:after {
            content: "";
            background: #ddd;
            width: 1px;
            height: .56rem;
            position: absolute;
            top: 50%;
            right: 0;
            -webkit-transform: translateY(-50%);
            transform: translateY(-50%);
        }

        .filter-extend.open {
            opacity: 1;
            visibility: visible;
            max-height: 1000%;
        }

        .filter-modal {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1;
            background: rgba(0, 0, 0, .2);
            visibility: hidden;
            opacity: 0;
            -webkit-transition: all .3s ease-in-out;
            transition: all .3s ease-in-out;
        }

        .filter-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .filter-extend.open {
            opacity: 1;
            visibility: visible;
            max-height: 1000%;
        }

        .filter-extend {
            left: 0;
            right: 0;
            top: 100%;
            border-top: 1px solid #ddd;
            position: absolute;
            max-height: 0;
            background-color: #fff;
            -webkit-transition: all .2s ease-in-out;
            transition: all .2s ease-in-out;
            visibility: hidden;
            overflow: auto;
            opacity: 0;
            z-index: 3;
        }

        .filter-category {
            z-index: 200;
            padding-bottom: 0;
            color: #666;
            height: 1000%;
        }

        .filter-category .filter-scroller,
        .filter-category .loading {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            height: 100%;
        }

        .filter-category ul:first-child {
            background-color: #dddddd;
        }

        .filter-category ul {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            display: block;
            width: 0;
            list-style: none;
            margin: 0;
            padding: 0;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .filter-category ul:first-child li {
            padding: 0 0 0 .266667rem;
        }

        .filter-category li {
            position: relative;
            line-height: 2.333333rem;
        }

        .filter-category ul:nth-of-type(2) {
            /*margin-left: .4rem;*/
            /*padding-right: .133333rem;*/
            background-color: #F2F2F2;
        }

        .filter-category ul:nth-of-type(2) li {
            /*border-bottom: 1px solid #ddd;*/
        }

        .filter-category ul:nth-of-type(3) li {
            border-bottom: 1px solid #ddd;
        }

        .filter-category li.active {
            background-color: #fff;
        }

        .filter-sort {
            padding-bottom: 0;
        }

        .displayNone {
            display: none;
        }


        .active {
            color: #3190e8 !important;
        }

        .overHide {
            overflow: hidden;
        }

        .price_box p {
            font-size: 0.625rem;
        }


    </style>
</head>
<body>

<div style="left: 0px;
         right: 0px;
         top: 0px;
         z-index: 1000;
         position: fixed;">
<aside class="filter">
    <div class="filter-header">
        <span id="title_filter" class="filter-nav filter-nav-more" onclick="chose_tab(0)"><span>分类</span></span>
        <span id="title_sort" class="filter-nav" onclick="chose_tab(1)"><span>排序</span></span>
    </div>
    <section id="" class="filter-extend filter-sort open displayNone">
        <ul>
            <li class="aui-border-b">
                <span>全 部</span>
            </li>
            <li class="aui-border-b">
                <span>邀请好友</span>
            </li>
            <li class="aui-border-b">
                <span>微信推广</span>
            </li>
            <li class="aui-border-b">
                <span>充值豪礼</span>
            </li>
            <li class="aui-border-b">
                <span>交易回馈</span>
            </li>
            <li class="aui-border-b">
                <span>其他</span>
            </li>
        </ul>
    </section>
    <section id="condition_filter" class="filter-extend filter-category open displayNone">
        <div id="category_con" class="filter-scroller">
        </div>
    </section>
    <section id="condition_sort" class="filter-extend filter-sort open displayNone">
        <ul>
            <li class="aui-border-b" index="0" value="0" onclick="selectSort(0)">
                <span>综 合</span>
            </li>
            <li class="aui-border-b" index="1" value="1" onclick="selectSort(1)">
                <span>起拍价</span>
            </li>
            <li class="aui-border-b" index="2" value="2" onclick="selectSort(2)">
                <span>新品</span>
            </li>
        </ul>
    </section>

    <section id="condition_background" class="filter-modal open displayNone" onclick="hideConditionBG()"></section>
</aside>
    </div>
<section class="aui-refresh-content" style="margin-top: 40px">
    <div class="touchweb-com_searchListBox openList" id="goods_list" style="padding:  0.325rem;margin: 0rem">
    </div>
</section>

<!--status 状态 1 2 3 即将开始 进行中 已结束-->
<script id="list-template" type="text/x-dot-template">
    {{? it.length > 0 }}
    {{ for(var i in it) { }}
    <li style="padding-bottom: 57px;" onclick="open_view({{=it[i].id}})" tapmod>
        <a class="item">
            <div class="pic_box">
                <div class="active_box">
                    <span style=" background-position:0px -36px"></span>
                </div>
                <img src="{{=it[i].img}}">
            </div>
            <div class="title_box" style="line-height: 1rem;height: 1rem">{{=it[i].title}}</div>
            <div class="price_box">
                {{? it[i].status == 1}}
                <p class="new_price">起拍价:{{=it[i].minprice}} {{=it[i].cointitle}}</p>
                <p class="deal">开始时间:{{=it[i].strtime}}</p>
                {{?? it[i].status == 2}}
                <p class="new_price">当前价:{{=it[i].price}} {{=it[i].cointitle}}</p>
                <p class="deal">结束时间:{{=it[i].endtime}}</p>
                {{??}}
                <p class="new_price">成交价:{{=it[i].price}} {{=it[i].cointitle}}</p>
                <p class="deal">结束时间:{{=it[i].endtime}}</p>
                {{?}}
            </div>
        </a>
    </li>
    {{ } }}
    {{??}}
    <div style="padding: 10px 0">
        <ul style="text-align: center;color: #535C6F">
            暂无内容
        </ul>
    </div>
    {{? }}
</script>
</body>
<script type="text/javascript" src="__WAP__/js/ext/doT.min.js"></script>
<script type="text/javascript" src="__WAP__/js/ext/echo.js"></script>
<script type="text/javascript" src="__WAP__/js/aui/aui-slide.js"></script>
<script type="text/javascript" src="__WAP__/js/aui/aui-pull-refresh.js"></script>
<script type="text/javascript" src="__WAP__/js/aui/aui-toast.js"></script>
<script type="text/javascript">

    var pid = 1;
    var type = '';
    var sort = '';
    var lastViewIndex = -1;

    var categoryData;
    var clas1 = '';
    var clas2 = '';
    var clas3 = '';

    var selectedId;

    apiready = function () {
        onerror = error_handel;

        getCategory();
        requestData();
    };
    function getCategory() {
        Ajax('sale/type_list', 'get', '', function (ret) {
        alog(ret);
        if (ret.status == 1) {
            alog(ret.info);
            categoryData = ret.info.shop_type1;
            updateCategory();
        }
        else {
            art(ret.info);
        }
        });
    }
    function updateCategory() {

        if (typeof categoryData == 'undefined') {
            art('分类数据不存在');
            return;
        }

        //一级分类
        var opt = '';
        opt += '<ul>';
//        opt += '<li index="0" onclick="selCat1(0)"><span>全部</span></li>';
        clas1 = clas1 == '' ? 0 : clas1;
        for (var index1 = 0; index1 < categoryData.length; index1++) {

//            var indVal = index1 + 1 ;
            var indVal = index1;
            if (clas1 == index1) {
                opt += '<li class="active" index=\"' + indVal + '\" onclick="selCat1(' + indVal + ')"><span>' + categoryData[index1].title + '</span></li>'
            }
            else {
                opt += '<li index=\"' + indVal + '\" onclick="selCat1(' + indVal + ')"><span>' + categoryData[index1].title + '</span></li>'
            }
        }
        opt += '</ul>';

        //二级分类
        if (categoryData[clas1].pid_list.length == 0) {
            opt += '<ul>暂无内容</ul>';
            return;
        }

        opt += '<ul>';
//        opt += '<li index="0" onclick="selCat2(0)"><span>全部'+categoryData[clas1].title+'</span></li>';
        clas2 = clas2 == '' ? 0 : clas2;
        var clas2List = categoryData[clas1].pid_list;
        for (var index1 = 0; index1 < clas2List.length; index1++) {

//            var indVal = index1 + 1 ;
            var indVal = index1;
            if (clas2 == index1) {
                opt += '<li class="active" index=\"' + indVal + '\" onclick="selCat2(' + indVal + ')"><span>' + clas2List[index1].title + '</span></li>'
            }
            else {
                opt += '<li index=\"' + indVal + '\" onclick="selCat2(' + indVal + ')"><span>' + clas2List[index1].title + '</span></li>'
            }
        }
        opt += '</ul>';

        //三级分类
        opt += '<ul>';
//        opt += '<li index="0" onclick="selCat3(0)"><span>全部'+clas2List[clas2].title+'</span></li>';
        clas3 = clas3 == '' ? 0 : clas3;
        clas2 = clas2 > clas2List.length - 1 ? 0 : clas2;
        if (clas2 > clas2List.length - 1) {
            clas2 = 0;
        }
        var clas3List = clas2List[clas2].pid_list;
        alog(clas3List);
        for (var index1 = 0; index1 < clas3List.length; index1++) {

//            var indVal = index1 + 1 ;
            var indVal = index1;
            if (clas3 == index1) {
                opt += '<li class="active" index=\"' + indVal + '\" onclick="selCat3(' + indVal + ')"><span>' + clas3List[index1].title + '</span></li>'
            }
            else {
                opt += '<li index=\"' + indVal + '\" onclick="selCat3(' + indVal + ')"><span>' + clas3List[index1].title + '</span></li>'
            }
        }
        opt += '</ul>';

        $('#category_con').html(opt);
        alog(opt);
    }

    function createView() {

        alog("更新界面");
        var argu = arguments[0];
        if (typeof argu == 'undefined') {
            art("createView参数错误");
            return;
        }
        alog(argu);

        //主要数据
        var tempData = argu.data;
        var licaiList_temp = doT.template($("#list-template").html());

        if (pid == 1) {
            //第一页 -- 覆盖
            $('#goods_list').html(licaiList_temp(tempData.list));
        }
        else if (tempData.list.length > 0) {
            //非第一页且有数据 -- 追加
            $('#goods_list').html($('#goods_list').html() + licaiList_temp(tempData.list));
        }

        if (pid > Math.ceil(parseInt(tempData.count) / parseInt(tempData.pageSize))) {
            art("没有更多数据了");
        } else {
            art('第' + pid + '页');
            pid++;
        }
    }

    // index是分类的索引,值和数据源长度相等
    function selCat1(index) {
//        clas1 = index - 1;
        clas1 = index;
        updateCategory();
    }
    function selCat2(index) {
//        clas2 = index - 1;
        clas2 = index;
        updateCategory();

    }
    function selCat3(index) {
//        clas3 = index - 1;
        clas3 = index;
        updateCategory();


        hideConditionBG();
        var title = categoryData[clas1].pid_list[clas2].pid_list[clas3].title;
        $('#title_filter span').html(title);

        pid = 1;
        type = categoryData[clas1].pid_list[clas2].pid_list[clas3].id;
        requestData();
    }

    function requestData(callback) {

        var params = {
            "pid": pid,
            "type3": type,
            "sort": sort,
        };
        alog(params);
        loading();
        Ajax('sale/lists', 'get', params, function (ret) {
            toast.hide();
            if (typeof callback == "function") {
                callback("刷新完成");
            }
            alog(ret);
            if (ret.status == 1) {
                createView(ret.info);
            }
            else {
                art('ajax错误！');
            }
        });
    }

    //打开商品
    function open_view(id) {
        openWinWithParams('auctionDetail_h','app_auction',{'id':id});
    }

    //上拉加载
    window.onscroll = function () {
        if (isScrollToBottom())
        {
            requestData();
        }
    };

    //下拉刷新
    var pullRefresh = new auiPullToRefresh({
        container: document.querySelector('.aui-refresh-content'),
        triggerDistance: 100
    }, function (ret) {
        if (ret.status == "success") {
            if(getScrollTop() < 10)
            {
                pid = 1;
                requestData(function (msg) {
                    art(msg);
                    pullRefresh.cancelLoading(); //刷新成功后调用此方法隐藏
                });
            }
            else {
                pullRefresh.cancelLoading();
            }
        }
    });

    function chose_tab(id) {

        if (lastViewIndex == id) {
            hideConditionBG();
        }
        else {
            hideConditionBG();
            $('.filter-nav').removeClass('active');
            $('.filter-nav').filter(function (index) { return index == id }).addClass('active');
            if (id == 0) {
                //筛选
                $('#condition_background').removeClass('displayNone');
                $('#condition_filter').removeClass('displayNone');
            }
            if (id == 1) {
                //排序
                $('#condition_background').removeClass('displayNone');
                $('#condition_sort').removeClass('displayNone');
            }
            lastViewIndex = id;
        }
    }

    function hideConditionBG() {
        $('#condition_background').addClass('displayNone');
        $('#condition_filter').addClass('displayNone');
        $('#condition_sort').addClass('displayNone');
        $('.filter-nav').removeClass('active');
        lastViewIndex = -1;
    }

    function selectSort(val) {
        art("selectSort() " + val);
        $('#condition_sort li').removeClass('active');
        var ele = $('#condition_sort li').filter(function (index) {
            return this.getAttribute('value') == val
        }).addClass('active');
        var title = ele.children('span').html();
        $('#title_sort').html(title);
        sort = val;
        conditionReady();
    }

    function conditionReady() {
        pid = 1;
        hideConditionBG();
        requestData();
    }
</script>
</html>